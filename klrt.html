
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="zh-TW" xmlns="http://www.w3.org/1999/xhtml">
<head>
	<!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-143711253-1"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());
	
	  gtag('config', 'UA-143711253-1');
	</script>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width; initial-scale=1.0" />
<meta name="description" content="接軌時刻 - 基隆輕軌模擬器" />
<meta name="keywords" content="CANVAS,台鐵,捷運,基隆輕軌,輕軌,接軌時刻" />
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<title>接軌時刻 - 基隆輕軌模擬器</title>
<style type="text/css">
@charset "utf-8";

body {
	/*font-family:'細明體', "PMingLiU";*/
	font-size: 14px;
	margin: 0px;
}
.bs_no_select{
   -o-user-select:none;
   -moz-user-select: none;
   -ms-user-select: none;
   -webkit-user-select: none;
   user-select: none;
}

#ttDebug{
	position: fixed;
	top: 60px;
	background-color: #311;
	color: #DDE;
	display: inline-block;
}
.ttHide{
	display: none;
}

.menuBar{
	width: calc(100% - 30px);
	min-width: 1000px;
	margin: 5px 10px;
	border: 1px solid #EEE;
	border-radius: 5px;
	display: inline-block;
}

.menuItem{
	margin: 5px 10px;
	padding: 3px 10px;
	border: 2px solid #ECC;
	border-radius: 5px;
	float: left;
	cursor: pointer;
	font-size: 16px;
}
.menuItem.selected{
	background-color: #FDD;
}
.menuItem2{
	border: 2px solid #994;
}


.setItem{
	margin: 5px 5px;
	padding: 3px 10px;
	border: 2px solid #3BD;
	border-radius: 5px;
	float: left;
	cursor: pointer;
	font-size: 16px;
}
.setItem.sim4Rail{
	/*background-color: #FAFAFA;*/
	background-color: #833;
	color: #F5F5F5;
	border-color: #DDA60A;
}
.setItem.selected{
	background-color: #DED;
}
.setItem2{
	border: 2px solid #B2E;
}
.setItem2.selected{
	background-color: #ECF;
}

.helpArea{
	width: calc(100% - 50px);
	margin: 5px 2px 5px 20px;
	display: inline-block;
}
.helpArea .description{
	font-size: 12px;
	color: #331;
	width: calc(100% - 24px);
	display: inline-block;
	padding: 2px 10px;
}
.showHideDownUp{
	cursor: pointer;
	color: #23F;
	display: inline-block;
}
.timeShowArea{
	width: 90%;
	height: 50px;
	margin: 0 0 10px 20px;
	padding: 0 0 0 20px;
	min-width: 1200px;
	background-color: #FCFEEA;
}
.timeShowArea > div{
	float: left;
}
.timeShowArea .time{
	font-size: 30px;
	line-height: 30px;
	color: #2F9CED;
	width: 260px;
	margin: 5px 0;
}
.timeShowArea .status{
	font-size: 10px;
	line-height: 12px;
	width: 100px;
	margin: 5px 10px;
}
.timeShowArea .status .hold{color: #FE0101;}
.timeShowArea .status .running{color: #10BF10;}
.timeShowArea .status .off{color: #BAC93401;}

#copyJSON{
	margin: 5px 5px;
	padding: 3px 10px;
	border: 2px solid #7D2;
	border-radius: 5px;
	display: inline-block;
	cursor: pointer;
	font-size: 16px;
}
.showJSON{
	width: 100%;
	height: 600px;
}
/* Map Class */
.mapOut{
	position: relative;
	width: 1240px;
	height: 326px;
	margin-left: 20px;
	overflow: hidden;
}
#canvasRoute{
	width: 1240px;
	height: 326px;
}
.routeLayer{
	position: absolute;
	left: 0px;
	top: 0px;
	width: 100%;
	height: 100%;
	z-index: 2;
}
.trainLayer{
	position: absolute;
	left: 0px;
	top: 0px;
	width: 100%;
	height: 100%;
	z-index: 42;
}

.stationLayer{
	position: absolute;
	left: 0px;
	top: 0px;
	width: 100%;
	height: 100%;
	z-index: 5;
}
.stationOut{
	position: absolute;
	text-align: center;
}
.stationName{
	color: #208;
	height: 18px;
	overflow: hidden;
	position: relative;
	z-index: 41;
	cursor: pointer;
	background-color: #FFF;
}

.platformOut{
	width: 40px;
	height: 100%;
	position: absolute;
	z-index: 21;
	top: 0px;
	left: 20px;
}
.platformTRA, .platformKLRT{
	position: absolute;
}
.platformDiv{
	position: absolute;
	width: 40px;
	height: 14px;
	text-align: center;
	border: 1px solid transparent;
	box-sizing: border-box;
	line-height: 14px;
	color: transparent;
}
.marArea{
	width: 100%;
	height: 20px;
	position: absolute;
	bottom: 0px;
	z-index: 20;
}
.marArea .marIn{
	transition: all 1s linear;
	left: 100%;
	position: absolute;
	display: inline;
	word-wrap: break-word;
	word-break: break-all;
	white-space: nowrap;
}
.penArea{
	position: absolute;
	top: 24px;
	left: 0px;
	z-index: 20;
	color: #3AC049;
	cursor: pointer;
	font-size: 12px;
}
.penArea > div{
	border: 1px solid #A99;
	border-radius: 5px;
	padding: 3px 6px;
	margin: 2px 0px;
}
.penArea .penClear{
	color: #AA20B9;
}
.penArea .penSave{
	color: #3AD0B9;
}



/* Car Class */
.carOut{
	position: absolute;
}
.carAlign{
	position: absolute;
	box-sizing: border-box;
	border: 2px solid #9C2D14;
	border-radius: 5px;
	background-color: rgba(240,239,181,0.9);
	padding: 6px;
}
.carClass{
	position: absolute;
	font-size: 14px;
	width: 40px;
	height: 20px;
    text-align: center;
    line-height: 16px;
    color: #FFF;
    opacity: 0.95;
    cursor: pointer;
	box-sizing: border-box;
}
.speedRate20x{
	 transition: all 0.95s linear;
}
.speedRate40x{
	 transition: all 0.47s linear;
}
.speedRate60x{
	 transition: all 0.32s linear;
}
.speedRate80x{
	 transition: all 0.235s linear;
}
.carOnWait{
	background-color: #FFE0E0;
}
.carOnGo, .carOnStop{
	background-color: #F0F0A0;
}
.carK, .carN{
	background-color: #2EA42B;
	border: 1px solid #2EA42B;
	z-index: 104;
}
.carW{
	background-color: #fd7a10;
	border: 1px solid #fd7a10;
	z-index: 118;
}
.carE{
	background-color: #fd7a10;
	border: 1px solid #fd7a10;
	z-index: 119;
}
.carR{
	background-color: #CEB763;
	border: 1px solid #CEB763;
	z-index: 120;
}
.carT{
	background-color: #ff0030;
	border: 1px solid #ff0030;
	z-index: 121;
}
.carP{
	background-color: #0D46A2;
	border: 1px solid #0D46A2;
	z-index: 105;
}
.carX{
	background-color: #33D2DD;
	border: 1px solid #33D2DD;
	z-index: 107;
}
.carF{
	background-color: #32CFBC;
	border: 1px solid #32CFBC;
	z-index: 108;
}
.carG{
	background-color: #ff1070;
	border: 1px solid #ff1070;
	z-index: 109;
}
.carOnStation{
	opacity: 1;
	border-left: 5px solid #FEFE30;
	border-right: 5px solid #FEFE30;
}

.timeTableOut{
	display: inline-block;
	background-color: #FAFAFA;
	margin-left: 20px;
	position: relative;
	max-width: calc(100% - 60px);
	overflow-x: auto;
	min-width: 1010px;
}
.timeTableOut.tra{
	border: 2px solid #26c;
}
.timeTableOut.klrt{
	border: 2px solid #C26;
}
.timeTableOut .btnSwitchArea{
	position: absolute;
	left: 0px;
}
.timeTableOut .btnSwitchTable{
	font-size: 16px;
	padding: 5px 20px;
	line-height: 18px;
	color: #EEE;
	float: left;
	cursor: pointer;
}
.timeTableOut .btnSwitchTable:hover{
	opacity: 0.8;
}
.timeTableIn{
	top: 30px;
	margin: 30px 10px;
	left: 0px;
}
.timeTableIn table th{
	text-align: left;
	padding-left: 4px;
	min-width: 70px;
}
.timeTableIn table td{
	padding: 1px 4px;
	text-align: left;
}
.timeTableIn table tr.row2{
	background-color: #EEE;
}
.timeTableIn .passTrainTime{
	font-size:10px;
	color:transparent;
}

.bgTRA{
	background-color: #26C;
}
.bgKLRT{
	background-color: #C26;
}
.fontColorTRA{
	color: #26C;
}
.fontColorKLRT{
	color: #C26;
}


/* Set Page Class */
.setPage{
	margin-left: 20px;
	min-width: 1560px;
	min-height: 600px;
}
.setPage .jsonText{
	margin: 10px 5px;
	width: 1000px;
	height: 500px;
	float: left;
}
.setPage .paramText{
	margin: 10px 5px;
	width: 500px;
	height: 500px;
	float: left;
	color: #945;
	background-color: #EFFCFA;
}
.setPage .createBtnArea{
	margin: 5px;
	padding: 3px;
	min-height: 24px;
}
.setPage .sucMsg{
	float: left;
	margin: 4px;
	padding: 2px 10px;
	background-color: #DDC933;
	color: #B92E09;
	font-size: 14px;
	transition: all 2s linear;
}
.setPage .sucMsg.bye{
	transition-property: opacity;
	transition-duration: 2s;
	opacity: 0.01;
}
.setPage .textURL{
	margin: 10px 5px;
	width: 90%;
	height: 100px;
}
.setPage .helpText{
	margin: 5px;
	padding: 3px;
	max-height: 300px;
	overflow-y: scroll;
	width: 80%;
	max-width: 1260px;
}

.popupArea{
	width: 100%;
	height: 100%;
	position: fixed;
	top: 0; left: 0;
	background-color: rgba(242,242,242,0.8);
	z-index: 4000;
}
.popupArea .popupIn{
	width: 90%;
	height: 90%;
	transform: translateX(-50%) translateY(-50%);
	left: 50%; top: 50%;
	background-color: #DEF;
	display: inline-block;
	position: absolute;
	overflow: auto;
	border-radius: 20px;
	border: 10px solid #4AF;
	box-sizing: border-box;
	padding: 20px 50px;
	font-size: 16px;
	line-height: 26px;
}

.popupArea .popupIn .diagram{
	background-color: #FFF;
}

.popupArea .popupIn.big2{
	font-size: 40px;
	line-height: 56px;
}
.popupArea .popupIn.alphas{
	background-color: transparent;
}
.popupArea .popupIn.alphas .diagram{
	background-color: transparent;
}

.popupArea .close{
	position: absolute;
	z-index: 4002;
	width: 20px;
	height: 20px;
	font-size: 20px;
	line-height: 20px;
	right: 10px;
	top: 10px;
	cursor: pointer;
	border-radius: 10px;
	border: 1px solid #AAA;
	padding-left: 5px;
}
.popupArea .fontTune, .popupArea .setBgAlpha{
	position: absolute;
	z-index: 4002;
	width: 20px;
	height: 20px;
	font-size: 16px;
	line-height: 16px;
	left: 10px;
	top: 10px;
	cursor: pointer;
	border-radius: 10px;
	border: 1px solid #AAA;
	padding-left: 5px;
	background-color: #EEE;
}
.popupArea .setBgAlpha{
	left: 40px;
}
.popupArea .bgYellow{
	background-color: #FAFA22;
}
.popupArea .bgPink{
	background-color: #FADAF2;
}


</style>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<!--<script type="text/javascript" src="./libs/vue.js"></script>-->
<script type="text/javascript">
var TT = {
	descriptionText: [
		'本程式為接軌時刻 Web App 內之輔助工具，用於模擬基隆輕軌及台鐵四軌化、定型化時刻表後的運轉模式。<a href="https://github.com/melixyen/railtime/blob/gh-pages/klrt.html" target="_blank">Source</a> ',//| <span style="color:#33E;cursor:pointer;" onclick="TT.popupArea.reopen()">Window</span>',
		'目標為將台鐵兩條主幹線路線容量提升至單向每小時十二班，輕軌方面每小時可有三班台鐵列車、三班輕軌開入基隆外，依運量需求 ，開行北五堵站往返南港區間車，可讓該區間輕軌每小時最高開行十二班車，加上火車的十二班車，單向每小時可達廿四班車。',
		
		'發行單位: <span style="background-color: #BBB;"><span style="color:blue;">極</span><span style="color:#FEFE11;">光</span><span style="color:#005530;">駭</span><span style="color:red;">客</span></span><span>&nbsp;Melix Yen (melixyen@gmail.com)</span><span style="padding-left: 50px;">' +
			"更新日期: 2018/06/20</span>"
	],
	car: [
		{"id": "carK", "name": "輕軌", "ename": "Keelung LRT", "color": "#2EA42B", trainType: "k", zIndex: 104},
		{"id": "carN", "name": "區間車", "ename": "Local Train", "color": "#2EA42B", trainType: "n", zIndex: 104},
		{"id": "carW", "name": "西自強", "ename": "Tze-Chiang Limited Express", "color": "#fd7a10", trainType: "w", zIndex: 118},
        			{"id": "carE", "name": "東自強", "ename": "Tze-Chiang Limited Express", "color": "#fd7a10", trainType: "e", zIndex: 119},
        			{"id": "carR", "name": "太魯閣", "ename": "Tze-Chiang Limited Express(Tarko)", "color": "#CEB763", trainType: "r", zIndex: 120},
        			{"id": "carT", "name": "普悠瑪", "ename": "Tze-Chiang Limited Express(Puyuma)", "color": "#ff0030", trainType: "t", zIndex: 121},
        			{"id": "carP", "name": "區間車", "ename": "Local Train", "color": "#0D46A2", trainType: "p", zIndex: 105},
        			{"id": "carX", "name": "區間快", "ename": "Fast Local Train", "color": "#33D2DD", trainType: "x", zIndex: 107},
        			{"id": "carF", "name": "復興", "ename": "Fu-Hsing Semi Express", "color": "#32CFBC", trainType: "f", zIndex: 108},
        			{"id": "carG", "name": "莒光", "ename": "Chu-Kuang Express", "color": "#ff1070", trainType: "g", zIndex: 109}
	],
	//big: t停東線太魯閣普悠瑪，r停西線太魯閣普悠瑪，e停東線自強，w停西線自強，x停區間快車，p停區間車，k停基隆輕軌
	//line: k停基隆輕軌，w停西線，e停東線
	//platform: 由山側往海側堆月台，1a1b,2c2d，數字為月台編號，ac為南下逆行方左邊 bd為右邊，ab是台鐵cd是基隆輕軌
	//dir: 1是西部南下逆行，0是西部北上順行
	//platMain 若為兩組數字代表南下逆跟北上順的主要月台，若為四組數字則前兩組為台鐵後兩組代表基隆輕軌的南下跟北上
	station: [
        {id:"tra_1001", name: "基隆", trainType: 'pkrewx', line: "kw", km: 0, platform: ["1a1b","2a2b"], platMain: ["1b","2a"], pos: [14,0]},
        {id:"tra_1029", name: "三坑", trainType: "pk", line: "kw", km: 1.3, platform: ["1a1b"], platMain: ["1a","1b"], pos: [13,0]},
        {id:"tra_1002", name: "八堵", trainType: "pkex", line: "kwe", km: 3.7, platform: ["1b","2a","3a3b"], platMain: ["3a","3b"], pos: [12,0]},
        {id:"tra_1003", name: "七堵", trainType: "pkewxr", line: "kwe", km: 6, platform: ["1a1b","2a2b","3a3b","4a4b","5c5d"], platMain: ["1b","2a", "5c", "5d"], pos: [11,0]},
        {id:"tra_1030", name: "百福", trainType: "p", line: "we", km: 8.7, platform: ["1a1b","2a"], platMain: ["1a","1b"], pos: [9,0]},
        {id:"tra_1004", name: "五堵", trainType: "pk", line: "kwe", km: 11.7, platform: ["1a1b","2c2d"], platMain: ["1a","1b","2c","2d"], pos: [7,0]},
        {id:"tra_1005", name: "汐止", trainType: "pkwx", line: "kwe", km: 13.1, platform: ["1a1b","2a2b","3c3d"], platMain: ["1b","2a","3c","3d"], pos: [6,0]},
        {id:"tra_1031", name: "汐科", trainType: "pkx", line: "kwe", km: 14.6, platform: ["1a1b","2c2d"], platMain: ["1a","1b","2c","2d"], pos: [5,0]},
        {id:"tra_1006", name: "南港", trainType: "pkewxtr", line: "kwe", km: 19.1, platform: ["4b","3a3b","2a2b","1a1b","5c5d"], platMain: ["2b","1a","5c","5d"], pos: [2,0]},
        {id:"tra_1007", name: "松山", trainType: "pewxtr", line: "we", km: 21.9, platform: ["1a1b","2a2b"], platMain: ["1b","2a"], pos: [1,0]},
        {id:"tra_1008", name: "台北", trainType: "pewxtr", line: "we", km: 28.3, platform: ["3a3b","4a4b"], platMain: ["3b","4a"], pos: [0,0]},
        //{id:"tra_1802", name: "暖暖", trainType: "p", line: "e", platform: ["1b","2a"], platMain: ["1b","2a"], pos: [12,1], rotate: true},
        //{id:"tra_1803", name: "四腳亭", trainType: "p", line: "e", platform: ["1a1b"], platMain: ["1a","1b"], pos: [12,2], rotate: true},
        //{id:"tra_1804", name: "瑞芳", trainType: "pex", line: "e", platform: ["1a1b","2a2b"], platMain: ["1b","2a"], pos: [12,3], rotate: true},
        {id:"tra_8102", name: "六堵", trainType: "k", line: "k", km: 7.8, platform: ["1c1d"], platMain: ["1c","1d"], pos: [10,0]},
        {id:"tra_8104", name: "北五堵", trainType: "k", line: "k", km: 9.7, platform: ["1c1d"], platMain: ["1c","1d"], pos: [8,0]},
        {id:"tra_8106", name: "樟樹灣", trainType: "k", line: "k", km: 15.5, platform: ["1c1d"], platMain: ["1c","1d"], pos: [4,0]},
        {id:"tra_8108", name: "南港展覽館", trainType: "k", line: "k", km: 18, platform: ["1c1d"], platMain: ["1c","1d"], pos: [3,0]}
	],
	stBlockWidth: 80,
	stBlockHeight: 300,
	stRotateBlockWidth: 200,
	stRotateBlockHeight: 50,
	caWidth: 1240,
	caHeight: 326,
	rail: {
		baseHeight: 200,//西線南下主線股道高度
		baseKLRTHeight: 60,//基隆輕軌南下主線高度
		westSubTopOffset: -58,
		eastSubTopOffset: 28,
		colorTRA: "#26C",
		colorKLRT: "#C26",
		mode: 4,//4 for 四軌，3 for 三軌增站，2 for 三軌不增站
		lineWidth: 2,
		lineMainWidth: 3,
		lineOutMargin: 3,//軌道往外靜空
		platformRailMargin: 5,//月台和軌道間淨空
		platformSideOutMargin: 5+3+3,//基本上是 platformRailMargin + lineWidth or lineMainWidth + lineOutMargin 組成，指月台一側向外延伸淨空區
		platformHeight: 16,
		platformBorderWidth: 1,
		platformWidth: 40
	},
	line: [
		{
			id: "e",
			dir: 0,
			color: "#005000",
			//linkStation: [
				//{linkTo: "w", linkDir: 0, stationID: "tra_1002"},
				//{linkTo: "k", linkDir: 0, stationID: "tra_1002"}
			//],
			stationAry: ["tra_1008","tra_1007","tra_1006","tra_1031","tra_1005","tra_1004","tra_1030","tra_1003","tra_1002"]
		},
		{
			id: "w",
			dir: 0,
			color: "#000050",
			//linkStation: [
				//{linkTo: "e", linkDir: 0, stationID: "tra_1002"},
				//{linkTo: "k", linkDir: 0, stationID: "tra_1002"}
			//],
			stationAry: ["tra_1008","tra_1007","tra_1006","tra_1031","tra_1005","tra_1004","tra_1030","tra_1003","tra_1002","tra_1029","tra_1001"]
		},
		{
			id: "k",
			dir: 0,
			color: "#500000",
			//linkStation: [
				//{linkTo: "w", linkDir: 0, stationID: "tra_1002"},
				//{linkTo: "e", linkDir: 0, stationID: "tra_1002"}
			//],
			stationAry: ["tra_1006","tra_8108","tra_8106","tra_1031","tra_1005","tra_1004","tra_8104","tra_8102","tra_1003","tra_1002","tra_1029","tra_1001"]
		}
	],
	startHour: 6,//早上六點開始計算出發
	runHour: 3,//模擬運轉3小時
	nowTime: 0,//儲存目前的模擬時間
	baseRate: 20,//基礎值為每次跑 20 秒
	rate: 40,//預設 40 倍速模擬
	genID: 0,//計數編成車次當物件id
	readyGoIndexAry: [],
	timerID: false,//setInterval 變數儲存
	timerInterval: 1000,
	timeTable: [],//儲存動態產生時刻表
	timeGo: [],//儲存上線列車物件
	editTimeTableByPeople: false,//若產生過編輯參數或讀入時帶有時刻表將之設為 true，則程式不會在切換軌道模式時做時刻表的調整
	trainGoTime: [
		//一小時內要發的所有列車，格時為 [mod , startTime minute]
		["y_1",3], ["w_1",20], ["p_1",6], ["t_1",32], ["y_3",23], ["x_1",31], ["p_3",27], ["r_1",51], ["y_5",43], ["w_1",60], ["p_5",46], ["e_1",7],
		["r_2",0], ["p_2",5], ["w_2",10], ["y_2",15], ["e_2",20], ["p_4",25], ["x_2",30], ["y_4",35], ["t_2",40], ["p_6",45], ["w_2",50], ["y_6",55],
		["k_1",0], ["k_3",20], ["k_1",10], ["k_1",15], ["k_1",20], ["k_3",40], ["k_3",45], ["k_1",35], ["k_1",40], ["k_3",60], ["k_1",50], ["k_1",55],
		["k_4",2], ["k_2",7], ["k_2",12], ["k_2",17], ["k_4",22], ["k_2",27],  ["k_2",32], ["k_4",37], ["k_4",42], ["k_2",47], ["k_2",52], ["k_2",57]
	],
	trainModuleTime: [//列車基礎時刻，一切以定型化班表運作，每種列車停靠站與時間固定，以 trainType 加組合數字設定固定模式與待避車站
		//數字直接換算，停靠較久用 ~ 連接，待避用 w 連接，過站不停的時間用 p 寫前綴
		//轉換網址列作法 a=t_1&b=t&c=e&d=1&e=1002&f=1008&g=%E5%8F%B0%E6%9D%B1-%E6%A8%B9%E6%9E%97&h=p32-p34-p36-p39-p40-p41-45-50-57~60&q=   <<< q 為斷符代表一個 module 的結束
		//++++東線普悠瑪號
		{
			mod: "t_1",
			trainType: "t", line: "e", dir: 1,
			from: "tra_1002", to: "tra_1008",
			tag: "台東-樹林",
			time: ["p32","p34","p36","p39","p40","p41",45,50,"57~60"]
		}, {
			mod: "t_2",
			trainType: "t", line: "e", dir: 0,
			from: "tra_1008", to: "tra_1002",
			tag: "樹林-台東",
			time: [40,47,52,"p57","p58","p59","p62","p64","p65"]
		},
		//++++東線太魯閣號
		{
			mod: "r_1",
			trainType: "r", line: "e", dir: 1,
			from: "tra_1002", to: "tra_1008",
			tag: "花蓮-樹林",
			time: [51,"p54","p56","p59","p60","p61",65,70,"77~80"]
		}, {
			mod: "r_2",
			trainType: "r", line: "e", dir: 0,
			from: "tra_1008", to: "tra_1002",
			tag: "樹林-花蓮",
			time: [0,7,12,"p17","p18","p19","p21","p24",26]
		},
		//++++東線自強號
		{
			mod: "e_1",
			trainType: "e", line: "e", dir: 1,
			from: "tra_1002", to: "tra_1008",
			tag: "花蓮-樹林",
			time: ["p7",9,"p13","p17","p18","p20",25,30,"37~40"]
		}, {
			mod: "e_2",
			trainType: "e", line: "e", dir: 0,
			from: "tra_1008", to: "tra_1002",
			tag: "樹林-花蓮",
			time: [20,27,32,"p36","p38","p40","p44",48,"p51"]
		},
		//++++西線自強號，會用到兩次
		{
			mod: "w_1",
			trainType: "w", line: "e", dir: 1,
			from: "tra_1003", to: "tra_1008",
			tag: "七堵-潮州",
			time: [0,"p4","p8",10,"p12","p16",20,"27~30"]
		}, {
			mod: "w_2",
			trainType: "w", line: "w", dir: 0,
			from: "tra_1008", to: "tra_1003",
			tag: "潮州-七堵",
			time: [10,17,"p21","p25",27,"p29","p32",35]
		},
		//++++西線區間快車
		{
			mod: "x_1",
			trainType: "x", line: "w", dir: 1,
			from: "tra_1001", to: "tra_1008",
			tag: "基隆-彰化",
			time: [31,"p33","p37",40,"p43","p47",49,"p51",56,60,"67~70"]
		}, {
			mod: "x_2",
			trainType: "x", line: "w", dir: 0,
			from: "tra_1008", to: "tra_1001",
			tag: "彰化-基隆",
			time: [30,37,42,"p47",49,"p51","p54",58,"p62","p65",67]
		},
		//++++宜蘭線區間車
		{
			mod: "y_1",
			trainType: "p", line: "e", dir: 1,
			from: "tra_1002", to: "tra_1008",
			tag: "蘇澳-樹林",
			time: [3,"7w11",15,19,22,24,30,35,"42~45"]
		}, {
			mod: "y_3",
			trainType: "p", line: "e", dir: 1,
			from: "tra_1002", to: "tra_1008",
			tag: "蘇澳-樹林",
			time: [23,27,32,36,"38w42",44,50,55,"62~65"]
		}, {
			mod: "y_5",
			trainType: "p", line: "e", dir: 1,
			from: "tra_1002", to: "tra_1008",
			tag: "瑞芳-中壢",
			time: [43,47,52,56,"58w61",64,70,75,"82~85"]
		}, {
			mod: "y_2",
			trainType: "p", line: "e", dir: 0,
			from: "tra_1008", to: "tra_1002",
			tag: "樹林-蘇澳",
			time: [15,22,27,33,"36w39",42,46,51,55]
		}, {
			mod: "y_4",
			trainType: "p", line: "e", dir: 0,
			from: "tra_1008", to: "tra_1002",
			tag: "樹林-蘇澳",
			time: [35,42,47,53,"56w59",61,65,"70~71",75]
		}, {
			mod: "y_6",
			trainType: "p", line: "e", dir: 0,
			from: "tra_1008", to: "tra_1002",
			tag: "中壢-瑞芳",
			time: [55,62,67,73,"75w79",81,85,"90~91",95]
		},
		//++++西線區間車
		{
			mod: "p_1",
			trainType: "p", line: "w", dir: 1,
			from: "tra_1001", to: "tra_1008",
			tag: "基隆-新竹",
			time: [6,9,13,17,22,26,"28w32",34,40,45,"52~55"]
		}, {
			mod: "p_3",
			trainType: "p", line: "w", dir: 1,
			from: "tra_1001", to: "tra_1008",
			tag: "基隆-新竹",
			time: [27,30,34,"38w42",47,51,53,55,61,66,"73~75"]
		}, {
			mod: "p_5",
			trainType: "p", line: "w", dir: 1,
			from: "tra_1001", to: "tra_1008",
			tag: "基隆-新竹",
			time: [46,49,53,57,62,66,"68w72",74,80,85,"92~95"]
		}, {
			mod: "p_2",
			trainType: "p", line: "w", dir: 0,
			from: "tra_1008", to: "tra_1001",
			tag: "新竹-基隆",
			time: [5,12,17,23,"25w29",31,35,"40~41",45,49,52]
		}, {
			mod: "p_4",
			trainType: "p", line: "w", dir: 0,
			from: "tra_1008", to: "tra_1001",
			tag: "新竹-基隆",
			time: [25,32,37,43,45,47,51,"56w60",64,68,71]
		}, {
			mod: "p_6",
			trainType: "p", line: "w", dir: 0,
			from: "tra_1008", to: "tra_1001",
			tag: "新竹-基隆",
			time: [45,52,57,63,"65w69",71,75,"80~81",85,89,92]
		},
		//++++基隆輕軌
		{
			mod: "k_1",
			trainType: "k", line: "k", dir: 1,
			from: "tra_1001", to: "tra_1006",
			tag: "基隆-南港",
			time: [0,3,7,10,13,15,18,20,22,23,27,29]
		}, {
			mod: "k_2",
			trainType: "k", line: "k", dir: 0,
			from: "tra_1006", to: "tra_1001",
			tag: "南港-基隆",
			time: [0,2,6,7,9,11,14,16,19,22,26,29]
		}, {
			mod: "k_3",
			trainType: "k", line: "k", dir: 1,
			from: "tra_8104", to: "tra_1006",
			tag: "北五堵-南港",
			time: [0,3,5,7,8,12,14]
		}, {
			mod: "k_4",
			trainType: "k", line: "k", dir: 0,
			from: "tra_1006", to: "tra_8104",
			tag: "南港-北五堵",
			time: [0,2,6,7,9,11,14]
		}
	],
	r3trainGoTime: [
		["w_1",40], ["p_1",15], ["t_1",37], ["y_3",48], ["p_1",35], ["r_1",21], ["y_3",8], ["w_1",60], ["p_1",55], ["e_1",2],
		["r_2",0], ["w_2",5], ["p_4",10], ["y_2",35], ["e_2",40], ["p_2",30], ["y_4",25], ["t_2",20], ["p_2",50], ["w_2",45],
		["k_1",5], ["k_1",25], ["k_1",45], ["k_2",13], ["k_2",33], ["k_2",53],
		["k_3",10], ["k_3",30], ["k_3",50], ["k_4",23], ["k_4",43], ["k_4",3]
	],
	r3trainModuleTime: [
		//++++東線普悠瑪號
		{
			mod: "t_1",
			trainType: "t", line: "e", dir: 1,
			from: "tra_1002", to: "tra_1008",
			tag: "台東-樹林",
			time: ["p32","p34","p36","p39","p40","p41",45,50,"57~60"]
		}, {
			mod: "t_2",
			trainType: "t", line: "e", dir: 0,
			from: "tra_1008", to: "tra_1002",
			tag: "樹林-台東",
			time: [40,47,52,"p57","p58","p59","p62","p64","p65"]
		},
		//++++東線太魯閣號
		{
			mod: "r_1",
			trainType: "r", line: "e", dir: 1,
			from: "tra_1002", to: "tra_1008",
			tag: "花蓮-彰化",
			time: [51,"p54","p56","p59","p60","p61",65,70,"77~80"]
		}, {
			mod: "r_2",
			trainType: "r", line: "e", dir: 0,
			from: "tra_1008", to: "tra_1002",
			tag: "彰化-花蓮",
			time: [0,7,12,"p17","p18","p19","p21","p24",26]
		},
		//++++東線自強號
		{
			mod: "e_1",
			trainType: "e", line: "e", dir: 1,
			from: "tra_1002", to: "tra_1008",
			tag: "花蓮-樹林",
			time: ["p7",9,"p13","p17","p18","p20",25,30,"37~40"]
		}, {
			mod: "e_2",
			trainType: "e", line: "e", dir: 0,
			from: "tra_1008", to: "tra_1002",
			tag: "樹林-花蓮",
			time: [20,27,32,"p36","p38","p40","p44",48,"p51"]
		},
		//++++西線自強號，會用到兩次
		{
			mod: "w_1",
			trainType: "w", line: "e", dir: 1,
			from: "tra_1003", to: "tra_1008",
			tag: "七堵-潮州",
			time: [0,"p4","p8",10,"p12","p16",20,"27~30"]
		}, {
			mod: "w_2",
			trainType: "w", line: "w", dir: 0,
			from: "tra_1008", to: "tra_1003",
			tag: "潮州-七堵",
			time: [10,17,"p21","p25",27,"p29","p32",35]
		},
		//++++宜蘭線區間車
		{
			mod: "y_1",
			trainType: "p", line: "e", dir: 1,
			from: "tra_1002", to: "tra_1008",
			tag: "蘇澳-樹林",
			time: [28,"32w37",42,46,48,50,56,61,"68~70"]
		}, {
			mod: "y_3",
			trainType: "p", line: "e", dir: 1,
			from: "tra_1002", to: "tra_1008",
			tag: "蘇澳-樹林",
			time: [52,56,61,65,67,69,75,80,"87~89"]
		}, {
			mod: "y_2",
			trainType: "p", line: "e", dir: 0,
			from: "tra_1008", to: "tra_1002",
			tag: "樹林-蘇澳",
			time: [15,22,27,33,36,38,42,"46w50",54]
		}, {
			mod: "y_4",
			trainType: "p", line: "e", dir: 0,
			from: "tra_1008", to: "tra_1002",
			tag: "樹林-蘇澳",
			time: [25,32,37,43,46,48,52,57,61]
		},
		//++++西線區間車
		{
			mod: "p_1",
			trainType: "p", line: "w", dir: 1,
			from: "tra_1001", to: "tra_1008",
			tag: "基隆-新竹",
			time: [10,14,18,22,27,31,33,35,41,46,"53~55"]
		}, {
			mod: "p_2",
			trainType: "p", line: "w", dir: 0,
			from: "tra_1008", to: "tra_1001",
			tag: "新竹-基隆",
			time: [0,7,12,18,21,23,27,31,35,39,43]
		}, {
			mod: "p_4",
			trainType: "p", line: "w", dir: 0,
			from: "tra_1008", to: "tra_1001",
			tag: "新竹-基隆",
			time: [0,7,12,18,21,23,27,"32w35",39,43,47]
		},
		//++++基隆輕軌
		{
			mod: "k_1",
			trainType: "k", line: "k", dir: 1,
			from: "tra_1001", to: "tra_1006",
			tag: "基隆-南港",
			//time: [0,3,7,10,13,15,18,20,23,"24w26",30,31]
			time: [0,3,7,10,13,15,18,20,23,"24w25",30,32]
		}, {
			mod: "k_2",
			trainType: "k", line: "k", dir: 0,
			from: "tra_1006", to: "tra_1001",
			tag: "南港-基隆",
			//time: [0,2,5,7,9,11,14,16,19,22,26,29]
			time: [0,2,7,9,"11w12",14,17,19,22,25,29,32]
		}, {
			mod: "k_3",
			trainType: "k", line: "k", dir: 1,
			from: "tra_8104", to: "tra_1006",
			tag: "北五堵-南港",
			//time: [0,3,5,8,"9w11",15,16]
			time: [0,3,5,8,"9w10",15,17]
		}, {
			mod: "k_4",
			trainType: "k", line: "k", dir: 0,
			from: "tra_1006", to: "tra_8104",
			tag: "南港-北五堵",
			//time: [0,2,5,7,9,11,14]
			time: [0,2,7,9,"11w12",14,17]
		}
	]
};

TT.fn = {
        transTime2HM: function(val){
            if(typeof(val)=='number') val = TT.fn.transSec2Time(val);
            var ary = val.split(':');
            return ary[0] + ':' + ary[1];
        },
        transNum2StrA: function(intA){
            intA = parseInt(intA,10);
            if(intA <= 9){
                return '0' + intA;
            }else{
                return intA.toString();
            }
        },
        transTime2Sec: function(str,offsetTomorrow){
            if (str == null || str == '') {
                str = '0';
            }
            var aryA = str.split(':'), rt;
            if (aryA.length <= 1) {
                rt = parseInt(str,10);
            } else if (aryA.length == 2) {
                rt = parseInt(aryA[0],10) * 3600 + parseInt(aryA[1],10) * 60;
            } else if (aryA.length == 3) {
                rt = parseInt(aryA[0],10) * 3600 + parseInt(aryA[1],10) * 60 + parseInt(aryA[2],10);
            }
            
            if(offsetTomorrow && rt < TT.fn.transTime2Sec(TT.fn.getDefaultDayLastTime())){
                rt = rt + 86400;
            }
            return rt;
        },
        transString2Sec: function(str){
        	//本function會將 01:30 轉為 90 而不是 5400
        	var aryA = str.split(':');
        	if (aryA.length == 2) {
        		str = '00:' + str;
        	}
        	return TT.fn.transTime2Sec(str);
        },
        transSec2Time: function(sec){
            var tid = 0,
                tih = 0,
                tim = 0,
                tis = 0;

            if((sec === '')){
                return '';
            }else if(parseInt(sec,10) < 0){
                sec = 86400 + sec;
            }
            
            sec = parseInt(sec,10);
            tis = sec % 60;
            sec = sec - tis;
            sec = sec / 60;
            tim = sec % 60;
            sec = sec - tim;
            sec = sec / 60
            tih = sec;
            

            tih = (tih < 10) ? '0' + tih : tih;
            tim = (tim < 10) ? '0' + tim : tim;
            tis = (tis < 10) ? '0' + tis : tis;

            if (tih == 0) {
                return tih + ':' + tim + ':' + tis;
            } else {
                return tih + ':' + tim + ':' + tis;
            }
        },
        getCarByTrainType: function(t){
        	for(var i=0; i<TT.car.length; i++){
        		if(TT.car[i].trainType==t) return TT.car[i];
        	}
        },
        getData2JSON: function(){
        	var obj = {
				trainGoTime: TT.trainGoTime,
				trainModuleTime: TT.trainModuleTime
			};
			var a = JSON.stringify(obj, undefined, '\t');
			a = a.replace(/\n\t\t\t\t/gi,'').replace(/\n\t\t\t\]/gi,']');
			var ary = a.split('trainModuleTime');
			ary[0] = ary[0].replace(/\n\t\t\t/gi,'').replace(/\n\t\t\]/gi,']');
			
			return ary[0] + 'trainModuleTime' + ary[1];
        },
        setData2trainRawData: function(str){
        	try {
        		var objA = JSON.parse(str);
        	}catch(e){
        		return false;
        	}
        	if(objA.trainGoTime) TT.trainGoTime = objA.trainGoTime;
        	if(objA.trainModuleTime) TT.trainModuleTime = objA.trainModuleTime;
        	return true;
        },
        getSearch: function(takeAry){
			var pairs = window.location.search.substring(1).split("&"),ary = [], obj={},pair,k;

			for(k in pairs){
				if ( pairs[k] === "" ) continue;
				pair = pairs[k].split("=");
				obj[ decodeURIComponent( pair[0] ) ] = decodeURIComponent( pair[1] );
				ary.push([decodeURIComponent( pair[0] ), decodeURIComponent( pair[1] )])
			}
			
			return (takeAry) ? ary : obj;
        },
        getPlatformElTop: function(top){
        	var r = TT.rail;
        	return {
				top: top,
				rightRail: top - r.platformRailMargin - r.lineWidth,
				leftRail: top + r.platformHeight + r.platformRailMargin,
				rightOut: top - r.platformSideOutMargin,
				leftOut: top + r.platformHeight + r.platformSideOutMargin
			}
        },
        getStationByID: function(id, ary){
        	ary = ary || TT.station;
        	for(var i=0; i<ary.length; i++){
        		if(ary[i].id==id) return ary[i];
        	}
        	return false;
        }
}


TT.processFirst = function(initFlag){
	if(initFlag){
		TT.backupString = {
			trainGoTime: JSON.stringify(TT.trainGoTime),
			trainModuleTime: JSON.stringify(TT.trainModuleTime),
			line: JSON.stringify(TT.line),
			station: JSON.stringify(TT.station)
		}
	}else{
		TT.line = JSON.parse(TT.backupString.line);
		TT.station = JSON.parse(TT.backupString.station);
		if(!TT.editTimeTableByPeople){
			TT.trainGoTime = JSON.parse(TT.backupString.trainGoTime);
			TT.trainModuleTime = JSON.parse(TT.backupString.trainModuleTime);
		}
	}
	if(TT.rail.mode==3){//三軌化來調整月台，基隆輕軌停靠站六堵改百福，改造百福站 2月台
		var kr = TT.getLine('k'), stb;
		kr.stationAry = ["tra_1006","tra_8108","tra_8106","tra_1031","tra_1005","tra_1004","tra_8104","tra_1030","tra_1003","tra_1002","tra_1029","tra_1001"];
		stb = TT.fn.getStationByID('tra_1031');//汐科
		stb.platform = ['1a1b', '2c'];
		stb.platMain = ['1a', '1b', '2c', '2c'];
		stb = TT.fn.getStationByID('tra_1005');//汐止
		stb.platform = ['1a1b', '2c2d'];
		stb.platMain = ['1a', '1b', '2c', '2d'];
		stb = TT.fn.getStationByID('tra_1004');//五堵
		stb.platform = ['1a1b', '2c'];
		stb.platMain = ['1a', '1b', '2c', '2c'];
		stb = TT.fn.getStationByID('tra_1030');//百福
		stb.platform = ['1a1b', '2c'];
		stb.platMain = ['1a', '1b', '2c', '2c'];
		stb.trainType = 'pk'; stb.line = 'kwe';
		stb = TT.fn.getStationByID('tra_8102'); stb.platform = []; stb.platMain = [];//六堵
		stb = TT.fn.getStationByID('tra_1003');//七堵
		stb.platform = ["1a1b","2a2b","3a3b","4c4d"];
		stb.platMain = ['1b', '2a', '4c', '4d'];
		if(!TT.editTimeTableByPeople){
			TT.trainGoTime = JSON.parse(JSON.stringify(TT.r3trainGoTime));
			TT.trainModuleTime = JSON.parse(JSON.stringify(TT.r3trainModuleTime));
		}
	}else if(TT.rail.mode==2){
		var kr = TT.getLine('k'), stb;
		kr.stationAry = ["tra_1006","tra_8108","tra_1031","tra_1005","tra_1004","tra_1030","tra_1003","tra_1002","tra_1029","tra_1001"];
		stb = TT.fn.getStationByID('tra_8106');stb.platform = [];stb.platMain = [];//樟樹灣
		stb = TT.fn.getStationByID('tra_1031');//汐科
		stb.platform = ['1a1b', '2c'];
		stb.platMain = ['1a', '1b', '2c', '2c'];
		stb = TT.fn.getStationByID('tra_1005');//汐止
		stb.platform = ['1a1b', '2c2d'];
		stb.platMain = ['1a', '1b', '2c', '2d'];
		stb = TT.fn.getStationByID('tra_1004');//五堵
		stb.platform = ['1a1b', '2c'];
		stb.platMain = ['1a', '1b', '2c', '2c'];
		stb = TT.fn.getStationByID('tra_8104');stb.platform = [];stb.platMain = [];//北五堵
		stb = TT.fn.getStationByID('tra_1030');//百福
		stb.platform = ['1a1b', '2c'];
		stb.platMain = ['1a', '1b', '2c', '2c'];
		stb.trainType = 'pk'; stb.line = 'kwe';
		stb = TT.fn.getStationByID('tra_8102'); stb.platform = []; stb.platMain = [];//六堵
		stb = TT.fn.getStationByID('tra_1003');//七堵
		stb.platform = ["1a1b","2a2b","3a3b","4c4d"];
		stb.platMain = ['1b', '2a', '4c', '4d'];
		if(!TT.editTimeTableByPeople){
			TT.trainGoTime = JSON.parse(JSON.stringify(TT.r3trainGoTime));
			TT.trainModuleTime = JSON.parse(JSON.stringify(TT.r3trainModuleTime));
			//修改基隆輕軌模組為無新建車站模式
			var tmpA;
			TT.trainGoTime.splice(TT.trainGoTime.length-6);
			var dkk = 0;
			for(var i=0; i<TT.trainGoTime.length; i++){
				if(/^k_2/.test(TT.trainGoTime[i][0])){
					dkk = TT.trainGoTime[i][1] % 10;
					TT.trainGoTime[i][1] = TT.trainGoTime[i][1] - dkk + 5;//每個 5 分發車
				}
			}
			for(var i=0; i<TT.trainModuleTime.length; i++){
				tmpA = TT.trainModuleTime[i];
				switch(tmpA.mod){
					case 'k_1':
					tmpA.time = [0,3,7,10,14,18,20,22,28,30];
					break;
					case 'k_2':
					tmpA.time = [0,2,8,10,12,16,20,24,27,30];
					break;
				}
			}
		}
	}else if(TT.rail.mode==5){
		var kr = TT.getLine('k'), stb, lineObj;
		kr.stationAry = [];
		stb = TT.fn.getStationByID('tra_1006');//南港
		stb.platform = ["4b","3a3b","2a2b","1a1b"];
		stb.platMain = ['2b', '1a'];
		stb = TT.fn.getStationByID('tra_8108');stb.platform = ['1b', '2a2b'];stb.platMain = ['1b', '2a'];stb.trainType = "pkewxtr"; stb.line="kwe";//南港展覽館
		stb = TT.fn.getStationByID('tra_8106');stb.platform = [];stb.platMain = [];//樟樹灣
		stb = TT.fn.getStationByID('tra_1031');//汐科
		stb.platform = ['1b', '2a'];
		stb.platMain = ['1b', '2a'];
		stb = TT.fn.getStationByID('tra_1005');//汐止
		stb.platform = ['1a1b', '2a2b'];
		stb.platMain = ['1b', '2a'];
		stb = TT.fn.getStationByID('tra_1004');//五堵
		stb.platform = ['1b', '2a'];
		stb.platMain = ['1b', '2a'];
		stb = TT.fn.getStationByID('tra_8104');stb.platform = [];stb.platMain = [];//北五堵
		stb = TT.fn.getStationByID('tra_1030');//百福
		stb.platform = ['1b', '2a'];
		stb.platMain = ['1b', '2a'];
		stb.trainType = 'pk'; stb.line = 'kwe';
		stb = TT.fn.getStationByID('tra_8102'); stb.platform = []; stb.platMain = [];//六堵
		stb = TT.fn.getStationByID('tra_1003');//七堵
		stb.platform = ["1a1b","2a2b","3a3b","4a4b"];
		stb.platMain = ['1b', '2a'];
		//修改 line 停靠站
		lineObj = TT.getLine('w');
		lineObj.stationAry = ["tra_1008","tra_1007","tra_1006","tra_8108","tra_1031","tra_1005","tra_1004","tra_1030","tra_1003","tra_1002","tra_1029","tra_1001"];
		lineObj = TT.getLine('e');
		lineObj.stationAry = ["tra_1008","tra_1007","tra_1006","tra_8108","tra_1031","tra_1005","tra_1004","tra_1030","tra_1003","tra_1002"];
		TT.trainModuleTime = [];
		var trm = TT.trainModuleTime;
		trm.push({mod: "p_1", trainType: "p", line: "w", dir: 1, from: "tra_1001", to: "tra_1008", tag: "基隆-新竹", time: [0,3,7,11,15,19,21,23,28,30,35,"42~44"]});
		trm.push({mod: "p_3", trainType: "n", line: "w", dir: 1, from: "tra_1001", to: "tra_1006", tag: "基隆-南港", time: [0,3,7,11,15,19,21,23,28,30]});
		trm.push({mod: "y_1", trainType: "p", line: "e", dir: 1, from: "tra_1002", to: "tra_1008", tag: "蘇澳-樹林", time: [7,11,15,19,21,23,28,30,35,"42~44"]});
		trm.push({mod: "w_1", trainType: "w", line: "w", dir: 1, from: "tra_1001", to: "tra_1008", tag: "基隆-潮州", time: [0,"p3","p6",10,"p14","p18",20,"p22","p25","p27",30,"36~39"]});
		trm.push({mod: "t_1", trainType: "t", line: "e", dir: 1, from: "tra_1002", to: "tra_1008", tag: "台東-樹林", time: ["p32","p34","p36","p39","p40","p41","p44","p46",50,"57~60"]});
		trm.push({mod: "t_3", trainType: "t", line: "e", dir: 1, from: "tra_1002", to: "tra_1006", tag: "台東-南港", time: ["p32","p34","p36","p39","p40","p41","p46",48]});
		trm.push({mod: "r_1", trainType: "r", line: "e", dir: 1, from: "tra_1002", to: "tra_1008", tag: "花蓮-樹林", time: [51,"p54","p56","p59","p60","p61","p64","p66",70,"77~80"]});
		trm.push({mod: "x_1", trainType: "x", line: "e", dir: 1, from: "tra_1002", to: "tra_1008", tag: "花蓮-彰化", time: ["p51",54,"p57","p59","p60","p61","p64",65,70,"77~80"]});
		
		trm.push({mod: "p_2", trainType: "p", line: "w", dir: 0, from: "tra_1008", to: "tra_1001", tag: "新竹-基隆", time: [0,7,11,13,18,20,22,26,30,34,38,42]});
		trm.push({mod: "p_4", trainType: "n", line: "w", dir: 0, from: "tra_1006", to: "tra_1001", tag: "南港-基隆", time: [11,13,18,20,22,26,30,34,38,42]});
		trm.push({mod: "y_2", trainType: "p", line: "e", dir: 0, from: "tra_1008", to: "tra_1002", tag: "樹林-蘇澳", time: [0,7,11,13,18,20,22,26,30,34]});
		trm.push({mod: "w_2", trainType: "w", line: "w", dir: 0, from: "tra_1008", to: "tra_1001", tag: "潮州-基隆", time: [10,17,"p21","p22","p25",27,"p29","p33",37,"p40","p43",47]});
		trm.push({mod: "t_2", trainType: "t", line: "e", dir: 0, from: "tra_1008", to: "tra_1002", tag: "樹林-台東", time: [40,47,"p51","p52","p55","p56","p57","p60","p62","p64"]});
		trm.push({mod: "t_4", trainType: "t", line: "e", dir: 0, from: "tra_1006", to: "tra_1002", tag: "南港-台東", time: [52,"p54","p57","p58","p59","p62","p64","p66"]});
		trm.push({mod: "r_2", trainType: "r", line: "e", dir: 0, from: "tra_1008", to: "tra_1002", tag: "樹林-花蓮", time: [0,7,"p11","p13","p17","p18","p19","p21","p24",26]});
		trm.push({mod: "x_2", trainType: "x", line: "e", dir: 0, from: "tra_1008", to: "tra_1002", tag: "彰化-花蓮", time: [0,7,11,"p13","p17","p18","p19","p21",24,"p27"]});
		TT.trainGoTime = [
			['p_1',1],['p_1',11],['p_1',31],['p_1',41], ['p_2',25],['p_2',15],['p_2',55],['p_2',45], ['y_1', 28],['y_1', 58],['y_2', 5],['y_2', 35],
			['w_1',21],['w_1',51],['w_2',10],['w_2',40],
			
			['t_1',22],['t_1',52], ['r_1',11],['x_1',41],
			['t_2',0],['t_2',30], ['r_2',20],['x_2',50],
			//南港普悠瑪
			['t_3',17],['t_3',47],['t_4',18],['t_4',48],
			
			//基隆-南港區間車
			['p_3',6],['p_3',16],['p_3',26],['p_3',36],['p_3',46],['p_3',56],
			['p_4',1],['p_4',11],['p_4',21],['p_4',31],['p_4',41],['p_4',51]
		];
	}
	
	if(TT.showDescription==14){//rail.mode==4 , 15分鐘內快中慢三輪制
		var trm = TT.trainModuleTime;
		trm.push({mod: "x_13", trainType: "x", line: "w", dir: 1, from: "tra_1001", to: "tra_1008", tag: "基隆-彰化", time: [31,"p33","p37",40,"p43","p47",49,51,57,62,"69~71"] });
		trm.push({mod: "x_14", trainType: "x", line: "w", dir: 0, from: "tra_1008", to: "tra_1001", tag: "彰化-基隆", time: [0,7,12,18,20,"p22","p25",29,"p34","p36",38] });
		trm.push({mod: "r_11", trainType: "r", line: "e", dir: 1, from: "tra_1002", to: "tra_1008", tag: "花蓮-彰化", time: [51,"p54","p56","p59","p60","p61",65,70,"77~80"]});
		trm.push({mod: "r_12", trainType: "r", line: "e", dir: 0, from: "tra_1008", to: "tra_1002", tag: "彰化-花蓮", time: [0,7,12,"p17","p18","p19","p21","p24",26]});
		trm.push({mod: "g_11", trainType: "g", line: "e", dir: 1, from: "tra_1002", to: "tra_1008", tag: "花蓮-樹林", time: ["p22",24,"p28","p32",34,"p36",40,45,"52~55"]});
		trm.push({mod: "g_12", trainType: "g", line: "e", dir: 0, from: "tra_1008", to: "tra_1002", tag: "樹林-花蓮", time: [0,7,12,"p17",19,"p21","p25",29,"p32"]});
		trm.push({mod: "y_16", trainType: "p", line: "e", dir: 0, from: "tra_1008", to: "tra_1002", tag: "樹林-蘇澳", time: [55,62,67,73,"75w79",81,85,"90~91",95]});
		trm.push({mod: "p_12", trainType: "p", line: "w", dir: 0, from: "tra_1008", to: "tra_1001", tag: "新竹-基隆", time: [5,12,17,23,"25w29",31,35,40,44,48,51]});
		TT.trainGoTime = [
			['x_13',30],['x_13',0], ['t_1',47], ['r_11',16],
			['g_11',22], ['e_1',52], ['w_1',60], ['w_1',30],
			['y_3',8],['y_5',38], ['p_1',16],['p_1',46],
			["r_2",0], ['x_14',5], ['w_2',15], ['e_2',20],['t_2',30],['x_14',35],['w_2',45],['g_12',50],
			["y_16",25],['p_12',10],['y_6',55],['p_12',40],
			['k_1',5],['k_1',20],['k_1',35],['k_1',50],['k_3',60],['k_3',10],['k_3',15],['k_3',25],['k_3',30],['k_3',40],['k_3',45],['k_3',55],
			['k_2',5],['k_2',20],['k_2',35],['k_2',50],['k_4',0],['k_4',10],['k_4',15],['k_4',25],['k_4',30],['k_4',40],['k_4',45],['k_4',55]
		];
	}else if(TT.showDescription==24){
		var trm = [];
		trm.push({mod: "r_1", trainType: "r", line: "e", dir: 1, from: "tra_1002", to: "tra_1008", tag: "花蓮-樹林", time: [51,"p54","p56","p59","p60","p61",65,70,"77~80"]});
		trm.push({mod: "t_1", trainType: "t", line: "e", dir: 1, from: "tra_1002", to: "tra_1008", tag: "台東-樹林", time: ["p32","p34","p36","p39","p40","p41",45,50,"57~60"]});
		trm.push({mod: "y_1", trainType: "p", line: "e", dir: 1, from: "tra_1002", to: "tra_1008", tag: "蘇澳-樹林", time: [23,27,32,36,"38w42",44,50,55,"62~65"]});
		trm.push({mod: "y_3", trainType: "p", line: "e", dir: 1, from: "tra_1002", to: "tra_1008", tag: "瑞芳-新竹", time: [23,27,32,36,"38w42",44,50,55,"62~65"]});
		trm.push({mod: "w_1", trainType: "w", line: "e", dir: 1, from: "tra_1003", to: "tra_1008", tag: "七堵-潮州", time: [0,"p4","p8",10,"p12","p16",20,"27~30"]});
		trm.push({mod: "x_1", trainType: "x", line: "w", dir: 1, from: "tra_1003", to: "tra_1008", tag: "七堵-彰化", time: [40,"p43","p47",49,51,57,62,"69~71"] });
		
		trm.push({mod: "t_2", trainType: "t", line: "e", dir: 0, from: "tra_1008", to: "tra_1002", tag: "樹林-台東", time: [40,47,52,"p57","p58","p59","p62","p64","p65"]});
		trm.push({mod: "r_2", trainType: "r", line: "e", dir: 0, from: "tra_1008", to: "tra_1002", tag: "樹林-花蓮", time: [0,7,12,"p17","p18","p19","p21","p24",26]});
		trm.push({mod: "y_2", trainType: "p", line: "e", dir: 0, from: "tra_1008", to: "tra_1002", tag: "樹林-蘇澳", time: [15,22,27,33,"36w39",42,46,51,55]});
		trm.push({mod: "y_4", trainType: "p", line: "e", dir: 0, from: "tra_1008", to: "tra_1002", tag: "新竹-瑞芳", time: [15,22,27,33,"36w39",42,46,51,55]});
		trm.push({mod: "w_2", trainType: "w", line: "w", dir: 0, from: "tra_1008", to: "tra_1003", tag: "潮州-七堵", time: [10,17,"p21","p25","27~28","p30","p34",38]});
		trm.push({mod: "x_2", trainType: "x", line: "w", dir: 0, from: "tra_1008", to: "tra_1003", tag: "彰化-七堵", time: [0,7,12,18,20,"p22","p25",29]});
		
		trm.push({mod: "k_1", trainType: "k", line: "k", dir: 1, from: "tra_1001", to: "tra_1006", tag: "基隆-南港", time: [0,3,7,10,13,15,18,20,22,23,27,29]});
		trm.push({mod: "k_2", trainType: "k", line: "k", dir: 0, from: "tra_1006", to: "tra_1001", tag: "南港-基隆", time: [0,2,6,7,9,11,14,16,19,22,26,29]});
		
		TT.trainGoTime = [
			//['t_1', 62],['t_1', 22],['t_1', 42], ['y_1',13],['y_3',33],['y_3',53],
			['t_1', 67],['t_1', 22],['t_1', 37], ['r_1',51], ['y_3',13],['y_1',28],['y_3',43],['y_1',58],
			['w_1', 30], ['w_1', 60],['x_1', 14], ['x_1', 44],
			['t_2',0],['t_2',15],['t_2',30], ['r_2',45],['y_4',10],['y_2',25],['y_4',40],['y_2',55],
			['w_2',5], ['w_2',35], ['x_2',20], ['x_2',50],
			['k_1',0],['k_1',5],['k_1',10],['k_1',15],['k_1',20],['k_1',25],['k_1',30],['k_1',35],['k_1',40],['k_1',45],['k_1',50],['k_1',55],
			['k_2',0],['k_2',5],['k_2',10],['k_2',15],['k_2',20],['k_2',25],['k_2',30],['k_2',35],['k_2',40],['k_2',45],['k_2',50],['k_2',55]
			
		]
		TT.trainModuleTime = trm;
	}
}
TT.popupArea = (function(){
	var rt = {};
	var lastHTML = '';
	var dom = document.getElementById('popupArea');
	var din = document.getElementById('popupIn');
	if(!dom.isAddCloseFn){
		var df = document.createElement('div');
		df.className = 'fontTune';
		df.innerHTML = '字';
		df.addEventListener('click', function(e){
			if(din.className.indexOf('big2')>=0){
				din.className = din.className.replace(' big2','');
			}else{
				din.className = din.className + ' big2';
			}
		}, false);
		dom.appendChild(df);
		var da = document.createElement('div');
		da.className = 'setBgAlpha';
		da.innerHTML = '透';
		da.addEventListener('click', function(e){
			if(din.className.indexOf('alphas')>=0){
				din.className = din.className.replace(' alphas','');
			}else{
				din.className = din.className + ' alphas';
			}
		}, false);
		dom.appendChild(da);
		dom.addEventListener('click', function(e){
			if(e.target.id=='popupArea'){
				rt.close();
			}
		}, false);
		dom.isAddCloseFn = true;
	}
	rt.close = function(){
		rt.clear();
		din.scrollTop = 0;
		dom.style.display = 'none';
	}
	rt.show = function(){
		dom.style.display = '';
	}
	rt.pop = function(html, flgNoRemember){
		din.className = din.className.replace(' big2','').replace(' alphas','');
		din.innerHTML = html;
		rt.show();
		if(!flgNoRemember) lastHTML = html;
	}
	rt.pop2 = function(html){
		rt.pop(html);
		din.className = din.className + ' big2';
	}
	rt.reopen = function(){
		rt.pop(lastHTML);
	}
	rt.clear = function(){
		din.innerHTML = '';
	}
	return rt;
});
TT.openNews = function(){
	var html = '<div style="margin: 20px 50px; overflow-y:auto;">' +
		'<p><h1><a href="http://news.ltn.com.tw/news/life/paper/1202862" target="_blank">全面四軌方案 八堵—南港發車量大增</a></h1></p>' +
		'<hr>' +
		'<p>〔記者鄭瑋奇／台北報導〕基隆輕軌的優化第三軌及增為四軌兩方案，對搭車民眾有何不同？交通部鐵路改建工程局表示，兩方案初期，基隆—八堵間，每小時都可較現行台鐵營運模式增加一班車；全面四軌方案，八堵—南港單向每小時的火車及輕軌列車最高可發廿二班車，較現行台鐵尖峰發十班車，或優化第三軌後的十三至十四班車，大幅增加。</p>'+
		'<h2>單向每小時可發22班車 現行僅10班車</h2>'+
		'<p>台鐵三軌優化可避免冗長的土地取得時間，減少施工量體與時程，以較少投資解決部分運能不足困境；<span class="bgPink">主要工程是增設第三軌交會車站，以及汐止車站規模調整</span>。輕軌從基隆出發後，八堵站、七堵站需增設獨立候車月台，並<span class="bgYellow">增加北五堵、樟樹灣、南港展覽館三站</span>，其餘都與台鐵共用車站及月台。</p>'+
		'<h2>新增一軌 用地取得複雜但運能增</h2>' +
		'<p>台鐵新增四軌則是將台鐵路線新增一軌道，需處理較複雜的工程、用地問題，但可更大幅增加運能。主要工程除增設車站及既有站改建外，因路線多為高架，須於道路中央設置高架橋。<span class="bgYellow">基隆站出發過八堵後，就拉出兩股獨立路廊</span>，進到新設的七堵調車場站，然後經<span class="bgYellow">新設的六堵、北五堵站，</span><span class="bgPink">中間不停靠百福站；</span><span class="bgYellow">抵達汐止站後不使用台鐵既有車站月台</span>，而後經過汐科、樟樹灣站抵達南港展覽館。</p>'+
		'<p><span class="bgPink">目前台鐵南港—七堵，現行尖峰時段單向每小時已開出十班車，台北往基隆、花東各需五班</span>，幾乎達路線容量上限；使用Tram-Train輕軌系統後，<span class="bgYellow">台北往基隆可開行三班火車、三班輕軌<span>，多出的兩班容量就可拿去給花東使用。</p>' +
		'<p>但若增為四軌、採基隆至南港間全面雙軌化，除<span class="bgYellow">可將台鐵兩條主幹線路線容量提升至單向每小時十二班</span>，輕軌方面，每小時可有三班台鐵列車、三班輕軌開入基隆外，依運量需求，開行<span class="bgPink">北五堵站往返南港區間車</span>，可讓該區間輕軌每小時最高開行十二班車，加上火車的十班車，單向每小時可達廿二班車。</p>' +
		'<p>2018 / 05 / 23</p></div>';
	
	html += '<br><br><br>';
	html += '<div style="margin: 20px 50px;">' +
		'<p><h1><a href="https://udn.com/news/story/10756/2631389" target="_blank">交部：基隆輕軌 傾向原方案</a></h1></p>' +
		'<hr>' +
		'<p>基隆輕軌今啟動的第一階段工程，斥資3億5千萬元在八堵南側增設橫跨三軌的橫渡線，讓車輛調度更靈活，提升路線容量與利用率。<span class="bgYellow">目前台北往返基隆、東部，每小時軌道容量各5班</span>，橫渡線最快明年底完工，屆時東部路線運能將提升四成。</p>' +
		'<p>根據鐵路改建工程局規畫，橫渡線完工後、輕軌完工前，離峰時刻東部可增至7班，基隆往返台北減為3班，但另有3班往返基隆及七堵，不影響基隆運能；尖峰時段基隆台北維持5班、基隆七堵減為1班，花蓮台北維持既有容量5班。輕軌完工後，<span class="bgPink">每小時會有3班列車從基隆進台北、3班從基隆進南港展覽館</span>，另有7班從花東到台北。</p>' +
		'<p>至於基隆輕軌是否延伸南港站，王國材表示，目前有平面、地下延伸兩方案，地下延伸會多50億元，並至少增加兩年工期，下車後要步行180公尺才能到高鐵站；平面則是沿市民大道綠帶到南港站，經費多3到5億元。目前傾向原方案，但會與台北、新北及基隆市府再討論。</p>' +
		'<p>2017 / 08 / 09</p></div>';
	html += '<br><br><br>';
	
	TT.popupArea.pop(html);
}
TT.teachImp = (function(){
	var me = this;
	me.showProgramStep = function(){
		var html = '<h2>列車模擬程式初始化運作流程</h2>' +
			'<p>列車模擬程式進入網頁後首先要判斷 rail.mode 值，建立軌道配置和月台配置的基礎</p>' +
			'<ol><li>依照 station 資料將台北至基隆間所有車站建立至 stationLayer </li><li>使用 CANVAS 繪製軌道，在車站內佈設月台</li><li>用早上七點時間和預設列車模組計算一個小時的時刻表</li></ol>' +
			'<br><br>' +
			'<h2>基本組件</h2><ul>' +
				'<li>TT.trainGoTime: 起站的發車時間</li><li>TT.trainModuleTime: 列車模組，存放車種、行駛路線、行駛區間、每一站的到站時刻、通過時刻、開車時刻' +
				'<li>TT.timeTable: 計算後的列車時刻表存放於此</li><li>TT.timeGo: 動態陣列，有列車要發車時存入，列車到達終點站後移出</li>' +
			'</ul><br><br>' +
			'<h2>啟動模擬後的運作流程</h2><ol>' +
				'<li>讀取使用者設定的模擬起程時間、模擬速度、模擬運轉的時間長度</li>' +
				'<li>依照時間參數從 TT.trainGoTime 讀取發車時間，依照 TT.trainModuleTime 的排點規則產生運轉時刻表</li>' +
				'<li>TT.timeGo 清空，此陣列用來存放上線運轉的列車物件</li>' +
				'<li>啟動 setInterval 計時器，以 20 秒為單位跳躍，跳躍頻率依據運轉倍速決定。<span class="bgYellow">40x 代表每秒要運轉 40 秒進度亦即兩個20秒，所以頻率為 0.5 秒更新一次</span></li>' +
				'<li>當時間超過使用者設定的時間長度且 TT.timeGo 陣列內無列車時停止計時器</li>' +
			'</ol><br><br>' +
			'<h2>每次計時器觸發時的運作過程</h2><ol>' +
				'<li>檢查 TT.timeGo 陣列內<span class="bgYellow">是否有列車的 offlineTime 已經小於 nowTime</span>，有的話代表已到終點站，將列車移出 TT.timeGo 以及將列車元素自 DOM 內移除</li>' +
				'<li>找 TT.timeTable 中尚未註冊上線且發車時刻已經到了的列車  (registerTime == nowTime) </li>' +
				'<li>用 new TT.classTrain(列車模組) 的方式產生一個新的列車物件並加入 TT.timeGo</li>' +
				'<li>對剛加入的列車物件<span class="bgPink">執行 readyGo 發車</span></li>' +
			'</ol><br><br>' +
			'<h2>classTrain 的資料和操作方法</h2><ol>' +
				'<li>data: 列車的原始時刻表資料，運轉的基礎</li>' +
				'<li>stationPosAry: 每一站的列車進站時刻、離站時刻、是否為通過站、是否待避資料儲存於此</li>' +
				'<li>stepAry: 每 20 秒應該移動到的軌道位置、應該停靠的月台資料、當時運轉狀態存放於此，使用 stationPosAry 資料計算出來的</li>' +
				'<li style="color:#2C915C;">readyGo: function，在 DOM 中產生一個列車的 div 加入 stationLayer 後發車。</li>' +
				'<li style="color:#2C915C;">moveTrain: function，依照時間呼叫 setPosition 列車應該移動到的位置</li>' +
				'<li style="color:#2C915C;">setPosition: function，將列車移動到指定的座標，若為靠站狀態加上靠站時的 CSS 效果</li>' +
				'<li style="color:#2C915C;">offline: function，列車到達終點將列車下線，從 stationLayer 中移除列車的 div</li>' +
			'</ol><br><br>' +
			'<h2>月台與股道配置原則</h2><ol>' +
				'<li>在 station 資料中以 platform 陣列儲存，一座月台為一個陣列元素</li>' +
				'<li>月台格式為 1a1b , 2b , 3c3d 型式，編號在前停靠側在後，島式月台有兩個停靠側，側式月台只需填寫一個</li>' +
				'<li><span class="bgYellow">ab代表台鐵月台，cd代表基隆輕軌月台</span>；<span class="bgPink">ac代表基隆看往台北方向的左側，bd代表右側</span></li>' +
				'<li>在 station 資料中以 platMain 紀錄南下北上主要正線通過的月台位置，依序為台鐵逆行、台鐵順行、基隆輕軌逆行、基隆輕軌順行</li>' +
				'<li>幹線通過車站時<span class="bgPink">優先將 platMain 中的月台緊貼於幹線</span>，再往兩旁分佈側線</li>' +
				'<li>汐止和七堵另外設定待避股道，所以列車待避 (stationPosAry 中該站 wait狀態為 true) 時會移動至側線；七堵站則設置起迄點為七堵時停靠第三月台</li>' +
			'</ol><br><br>' +
			'';
		TT.popupArea.pop(html);
	}
	me.showPeopleThink = function(){
		var html = '<h2>非專業模擬程式的缺點</h2>' +
			'<ul><li>如同捷運路網圖，站間距離和圖上位置非等比例，列車移動時間長短無法表現在移動速度上</li>' +
			'<li>股道配置非實際走法，為了維持美觀而將南下北上的幹線直接畫一直線，無視實際運轉中東正線、中正線、西正線在南港至七堵間配置</li>'+
			'<li>只能用旅客時刻表當作排點參考，無法使用台鐵內部運行時刻表，單位無法精準到秒數，只有列車停靠時間沒有列車通過車站的時間</li>'+
			'<li>沒有列車性能數據，不同車種移動速度是固定線性沒有加減速性能的差異表現</li>'+
			'<li>沒有閉塞區間資料、沒有各區段速限資料，模擬時只能顯示列車相對位置而不是絕對安全的間隔位置</li></ul><br><br>' +
			'<h2>對民眾而言的應用面</h2>' +
			'<ol><li>民眾不想要知道閉塞、速限、精準通過時刻，他關心的是運轉後<span class="bgYellow">要等多久的車、要搭多久的車</span></li>'+
			'<li>民眾對新聞報導所書之改善後班次間隔、每小時列車通過數量感覺抽象，對時刻表資訊量感受複雜，對月台緩急轉乘沒有概念</li>'+
			'<li style="color:#A9045C;">通過模擬器程式，民眾可以由全觀視角去看路線上所有列車運作狀態，在哪些車站可緩急轉乘，哪些班車會因待避停靠較久，進而擁有運轉計劃的全觀性</li>'+
			'<li>短途通勤民眾重視發車頻率的固定性，發車間隔短如台北捷運不用先查時刻表，發車間隔長如機場捷運每小時固定四個時段發車好記又固定於長庚醫院緩急轉乘，此為定型化時刻表的重要性</li>' +
			'<li style="color:#2C915C;">模擬程式讓民眾有全線運轉概念後較容易提出意見反應，讓排點單位依據意見調整使時刻表更貼近民眾需求，降低事後改點上線民眾反感度</li>' +
			'<li>小站旅客可經模擬器清楚知道固定在大站轉乘快車更節省時間，教育民眾接受緩急轉乘概念減少後方車站對列車待避的反感</li>' +
			'<li>監督營運單位以及檢討實際運轉為何達不到模擬器的水準，檢討股道配置作為之後調整工程的參考</li></ol><br><br>' +
			'<h2>與運行圖的應用差異</h2>' +
			'<ul><li>運行圖適用書面資料，而模擬器是依照運行圖、時刻表在畫面上動態展示，適合簡報場合</li>' +
			'<li>運行圖是劇本，時刻表是小說，模擬器是動畫</li>'+
			'<li>運行圖是全觀的，只有時間跟場站二維；模擬器的第二維是軌道因此可同時呈現基隆輕軌與台鐵縱貫線分線及共線的運轉狀況，但只能隨時間推進不方便任意看前後關係</li>'+
			'</ul><br><br>';
		TT.popupArea.pop(html);
	},
	me.showDemoLink = function(){
		var html = '<a href="?q=2" target="_blank">三軌模式，只增建南港展覽館站</a><br><br>' +
			'<a href="?q=3" target="_blank">三軌模式，優化增建樟樹灣、北五堵交會站縮短班距</a><br><br>' +
			'<a href="?q=4" target="_blank">四軌模式，台鐵每小時六快六慢，輕軌五分鐘一班，最大化基隆班次</a><br><br>' +
			'<a href="?q=14" target="_blank">四軌模式，台鐵每小時八快四慢，輕軌五分鐘一班，基隆十五分鐘一班車</a><br><br>' +
			'<a href="?q=24" target="_blank">四軌模式，台鐵每小時四班太魯閣普悠瑪往花東，輕軌五分鐘一班，基隆不再停靠台鐵</a><br><br>' +
			'<a href="?q=5" target="_blank">台鐵四軌化，區間車五分鐘一班，基隆十分鐘有兩班到台北和南港的車</a><br><br>'
		TT.popupArea.pop2(html);
	},
	me.showStation1005 = function(){
		var html = '<h2>汐止站基隆輕軌四軌化時新建場站可能位置</h2>' +
			'<p>基隆輕軌若為四軌化方案，為保持汐止站雙島式月台火車待避功能，應於台五甲線汐止大同路上高架雙線新輕軌軌道，汐止車站也會新建基隆輕軌專用車站及專用月台。汐止車站的旅客主要集中於一號出口靠近信義路、新昌公園方向，而汐止車站也只有此處站前廣場直接與大同路連接，其餘位置與大同路間均有民房隔閡，因此汐止車站公車站牌所用花圃和公車彎是最適合設置輕軌車站及月台的位置，並可使用空橋連接台鐵月台末端達成站內轉乘。</p>'+
			'<div><iframe style="width:100%;height:650px;" src="https://www.google.com/maps/d/embed?mid=1WUrE8N6UAAfMopt4XLsSaSi145dyoH0l&ll=25.068974675215863%2C121.66219796613848&z=19"></iframe></div>' +
            '<br>' +
            '<p>使用汐止站前廣場與公車彎之廣場用地改建為車站大樓，一樓為轉運站，目前可轉運聯營公車、新北市新巴士、省道客運如 1032、國道客運如 1880，樓上為汐止車站聯通道以及輕軌站通道，可通往大同路上方的基隆輕軌剪票口並進入月台層候車，另於汐止中正路設一出口方便國泰醫院與建成路社區旅客使用。</p>' +
            '<img src="https://i.imgur.com/ex7vamO.jpg" width="90%"></img><br>' + 
            '<img src="https://i.imgur.com/43U6yIw.jpg" width="90%"></img><br>' + 
            '<img src="https://i.imgur.com/CvEx7TI.jpg" width="90%"></img><br>' + 
			'';
		TT.popupArea.pop(html);
	},
	me.showClassTrain = function(){
		var html = '<div style="color:#3254DE;font-size:20px;font-weight:700">列車的物件導向組件內容</div><br>' +
			'<pre>TT.classTrain = ' +
			TT.classTrain.toString().replace(/\</gi,'＜') +
			'</pre>';
		TT.popupArea.pop(html);
	}
	me.showSimReg = function(){
		var html = '<div style="color:#3254DE;font-size:20px;font-weight:700">啟動模擬</div><br>' +
			'<pre>TT.sim = ' +
			TT.sim.toString().replace(/\</gi,'＜') +
			'</pre><br><br>';
		html += '<div style="color:#3254DE;font-size:20px;font-weight:700">註冊列車</div><br>' +
			'<pre>TT.registerTrain = ' +
			TT.registerTrain.toString().replace(/\</gi,'＜') +
			'</pre><br><br>';
		TT.popupArea.pop(html);
	}
	return me;
})();

TT.flagUseBrowserCopyCheck = (function(){
        		var Sys = {},
					ua = navigator.userAgent.toLowerCase(),
					sAry;
				(sAry = ua.match(/rv:([\d.]+)\) like gecko/)) ? Sys.ie = parseInt(sAry[1]) :
				(sAry = ua.match(/msie ([\d.]+)/)) ? Sys.ie = parseInt(sAry[1]) :
				(sAry = ua.match(/firefox\/([\d.]+)/)) ? Sys.firefox = parseInt(sAry[1]) :
				(sAry = ua.match(/chrome\/([\d.]+)/)) ? Sys.chrome = parseInt(sAry[1]) :
				(sAry = ua.match(/opera.([\d.]+)/)) ? Sys.opera = parseInt(sAry[1]) :
				(sAry = ua.match(/version\/([\d.]+).*safari/)) ? Sys.safari = parseInt(sAry[1]) : 0;
				
				return ((Sys.ie && Sys.ie>=10) || (Sys.firefox && Sys.firefox>=41) || (Sys.chrome && Sys.chrome>=43) || (Sys.opera && Sys.opera>=29) || (Sys.safari && Sys.safari>=10)) ? true : false;
})();
TT.getLine = function(r){
	for(var i=0; i<TT.line.length; i++){
		if(TT.line[i].id==r) return TT.line[i];
	}
}
TT.getRailAry = function(line, from, to, dir, flagReturnObj){
	var stAry = [], rail = false, fAry = [];
	if(/w|e/.test(line)){
		rail = TT.getLine('w');
	}else{
		rail = TT.getLine(line);
	}
	fAry = rail.stationAry.concat();
	if(dir != rail.dir){
		fAry = fAry.reverse();
	}
	var step = 0, tmpF = false;;
	for(var i=0; i<fAry.length; i++){
		if(fAry[i]==from){
			step = 1;
		}else if(fAry[i]==to){
			step = 2;
		}
		tmpF = (flagReturnObj) ? JSON.parse(JSON.stringify(TT.fn.getStationByID(fAry[i]))) : fAry[i];
		if(step==1){
			stAry.push(tmpF);
		}else if(step==2){
			stAry.push(tmpF);
			break;
		}
	}
	return stAry;
}
TT.getTrainModuleTimeByMOD = function(mod){
	var ary = TT.trainModuleTime;
	for(var i=0; i<ary.length; i++){
		if(ary[i].mod==mod) return ary[i];
	}
}
TT.makeRouteTimeTable = function(startHour){
	//依據 trainGoTime 抓 trainModuleTime 內容算出
	try{
	var tObj = false;
	var tmpT = false, mod, startMin, tmpA, tmpB, stidAry, stTimeAry, arr, dep;
	var tid = 't_' + TT.genID++;
	var ary = [];
	var timeTableStartSec = startHour ? startHour*60*60 : TT.startHour *60 * 60;
	var firstMin = 0, offsetMin = 0, sortMin = 0;
	TT.trainGoTime.map(function(c, idx){
		mod = c[0]; startMin = c[1], sortMin = 0;
		stTimeAry = [];
		tid = 't_' + TT.genID++;
		tmpT = TT.getTrainModuleTimeByMOD(mod);
		tmpA = tmpT.time[0];
		if(typeof(tmpA)=='string'){//若第一個數字是字串，先取出數字
			if(/^p/.test(tmpA)){
				tmpA = parseInt(tmpA.replace('p',''));
			}else if(/\~/.test(tmpA)){
				tmpA = parseInt(tmpA.split('~')[0]);
			}else if(/w/.test(tmpA)){
				tmpA = parseInt(tmpA.split('w')[0]);
			}
		}
		firstMin = tmpA; offsetMin = 0;
		if(firstMin != startMin){//start為10但時刻表為 30 開頭時 10-30 = -20 之後所有數值都要 +offset
			offsetMin = startMin - firstMin;
		}
		
		//1.將運行時間算成各站陣列
		stidAry = TT.getRailAry(tmpT.line, tmpT.from, tmpT.to, tmpT.dir);
		tmpT.time.map(function(tm, idx){
			var flagPASS = false, flagWait = false, stid = stidAry[idx];
			var stObj = TT.fn.getStationByID(stid);
			if(typeof(tm)=='string'){//若第一個數字是字串，先取出數字
				if(/^p/.test(tm)){
					flagPASS = true;
					tmpA = parseInt(tm.replace('p',''));
					arr = (tmpA + offsetMin) * 60 + timeTableStartSec;
					dep = arr;
				}else if(/\~/.test(tm)){
					tmpA = tm.split('~');
					arr = (parseInt(tmpA[0]) + offsetMin) * 60 + timeTableStartSec;
					dep = (parseInt(tmpA[1]) + offsetMin) * 60 + timeTableStartSec;
				}else if(/w/.test(tm)){
					flagWait = true;
					tmpA = tm.split('w');
					arr = (parseInt(tmpA[0]) + offsetMin) * 60 + timeTableStartSec;
					dep = (parseInt(tmpA[1]) + offsetMin) * 60 + timeTableStartSec;
				}
			}else{
				arr = (tm + offsetMin) * 60 + timeTableStartSec - 20;
				dep = arr + 40;
			}
			
			if(tmpT.dir==0 && stid=='tra_1008'){
				dep -= 20;
				arr -=100;
			}
			
			if(TT.rail.mode<5 && ((tmpT.line=='k' && stid=='tra_1006') || (/w|e/.test(tmpT.line) && stid=='tra_1008'))){
				sortMin = dep;
			}
			
			var platform = '';
			if(tmpT.line=='k' && (!/^tra_810|^tra_1001|^tra_1029|^tra_1002/.test(stid))){
				platform = (tmpT.dir==1) ? stObj.platMain[2] : stObj.platMain[3];
			}else{
				platform = (tmpT.dir==1) ? stObj.platMain[0] : stObj.platMain[1];
			}
			
			if(stid=='tra_1008' && tmpT.trainType=='p'){
				platform = (tmpT.dir==1) ? '3a' : '4b';
			}else if(stid=='tra_1002' && tmpT.line=='e'){
				platform = (tmpT.dir==1) ? '1b' : '2a';
			}else if(stid=='tra_1003' && (tmpT.from=='tra_1003' || tmpT.to=='tra_1003')){
				platform = (tmpT.dir==1) ? '3b' : '3a';
			}
			
			if(flagWait){
				if(stid=='tra_1007' || (stid=='tra_1005' && TT.rail.mode==4) || stid=='tra_1003'){
					platform = (tmpT.dir==1) ? '1a' : '2b';
				}else if(stid=='tra_1006'){
					platform = (tmpT.dir==1) ? '2a' : '1b';
				}else if(stid=='tra_1008'){
					platform = (tmpT.dir==1) ? '3a' : '4b';
				}
			}
			
			if(TT.rail.mode==5){
				if(stid=='tra_1006'){
					sortMin = dep;
					if(idx==0){
						platform = '3b';
					}else if(idx==tmpT.time.length-1){
						platform = '3a';
					}
					if(tmpT.trainType=='n'){
						platform = '1b';
					}
				}
			}
			
			tmpB = {
				arr: arr,
				dep: dep,
				pass: flagPASS,
				wait: flagWait,
				platform: platform,
				stid: stid
			};
			stTimeAry.push(tmpB);
		});
		
		tObj = {trainID:tid};
		for(var k in tmpT){
			if(k!="time") tObj[k] = tmpT[k];
		}
		tObj.startMin = startMin;
		tObj.timeAry = stTimeAry;
		tObj.sortMin = sortMin;
		tObj.isRegistered = false;//註冊上線運轉後調成 true
		tObj.bye = false;//抵達終點消失後調成 true
		tObj.registerTime = stTimeAry[0].arr;
		tObj.offlineTime = stTimeAry[stTimeAry.length-1].dep;
		ary.push(tObj);
	});
	return ary;
	}catch(e){
		alert('產生時刻表時發生錯誤，可能列車模組資料不完整或輸入格式錯誤');
	}
}
TT.makeAllRouteTimeTable = function(startHour, runHour){
	runHour = runHour || 1;
	var tmpTime = [], tmpAnHour = [];
	for(var i=0; i<runHour; i++){
			tmpAnHour = TT.makeRouteTimeTable(startHour + i);
			tmpTime = tmpTime.concat(tmpAnHour);
	}
	tmpTime.sort(function(a,b){
			return (a.sortMin > b.sortMin) ? 1 : -1;
	});
	return tmpTime;
}

TT.classTrain = function(data){
	//製作每一列車的物件
	var baseRate = TT.baseRate;
	var me = this,
		timeAry = data.timeAry,
		fpm = 60 / baseRate,//用 60 除以此數，代表一分鐘要切成幾塊，預設 20 秒為一個進度所以一分鐘會切成 3 塊
		carOutWidth = 120, carOutHeight = 100, carInWidth = 56, carInHeight = 24, alignWidth = 120, alignHeight = 60,
		carOnTimeTable = false;;
	me.data = data;
	me.divOutID = 'train_out_' + data.trainID;//虛擬外框用，要移動的物件
	me.divInID = 'train_in_' + data.trainID;//車廂用
	me.divAlignID = 'train_align_' + data.trainID;//說明用
	me.flagShowAlign = false;//判斷是否開啟提示
	me.isRendered = false;
	me.stationPosAry = [];
	me.stepAry = [];
	me.lastStepIndex = 0;
	//取列車行駛至該站的股道高度可用 TT.map.getStationRailTop 取得
	var createStep = function(){
		var objA = {},
			stObj = false,
			platMain = '',
			stPosAry = [],
			stStepAry = [],
			centerOfPlatform = Math.ceil(TT.stBlockWidth/2),
			x = 0, y = 0, bx = 0, by = 0, ax = 0, ay = 0,
			pObj = false;
		var intoStationMargin = 6;//月台兩側6px當入站點 
		timeAry.map(function(c){
			pObj = TT.map.getStationRailTop(c.stid);
			stObj = TT.fn.getStationByID(c.stid, TT.map.stationAry);
			y = pObj['p' + c.platform];
			
			x = stObj.pos[0] * TT.stBlockWidth + centerOfPlatform;
			//找 platform 主線位置
			platMain = (data.dir==1) ? stObj.platMain[0] : stObj.platMain[1];
			if(data.line=='k' && stObj.platMain.length==4){
				platMain = (data.dir==1) ? stObj.platMain[2] : stObj.platMain[3];
			}
			bx = x - intoStationMargin;
			by = pObj['p' + platMain];
			ax = x + intoStationMargin;
			ay = pObj['p' + platMain];
			if(data.line=='e' && c.stid=='tra_1002'){
				platMain = (data.dir==1) ? '1b' : '2a';
				if(data.dir==1){
					by = pObj['p' + platMain];
				}else{
					ay = pObj['p' + platMain];
					by = pObj['p' + platMain];
				}
			}else if((data.from=='tra_1003' || data.to=='tra_1003') && c.stid=='tra_1003'){
				platMain = (data.dir==1) ? '3b' : '3a';
				ay = pObj['p' + platMain]; by = pObj['p' + platMain];
			}else if(c.stid=='tra_1008'){
				ay = y; by =y;
			}
			
			if(TT.rail.mode==5){//不蓋基隆輕軌模式
				if(/p|n/.test(data.trainType) && /tra_8108|tra_1031|tra_1005|tra_1004|tra_1030|tra_1003/.test(c.stid)){
					if(data.dir==1){
						y = TT.rail.baseHeight + TT.rail.eastSubTopOffset; ay = y; by = y;
					}else{
						y = TT.rail.baseHeight + TT.rail.westSubTopOffset; ay = y; by = y;
					}
				}
				if((data.from=='tra_1006' || data.to=='tra_1006') && c.stid=='tra_1006'){
					platMain = (data.dir==1) ? '3a' : '3b';
					if(data.trainType=='n'){
						platMain = '1b';
					}
					ay = pObj['p' + platMain]; by = pObj['p' + platMain];
				}
			}
			stPosAry.push({
				stid: c.stid,
				arr: c.arr,
				dep: c.dep,
				pos: [x,y],
				pass: c.pass,
				wait: c.wait,
				beforePos: (data.dir==1) ? [ax, ay] : [bx, by],
				afterPos: (data.dir==1) ? [bx, by] : [ax, ay]
			});
		});
		me.stationPosAry = stPosAry;
		//依據站間時間計算移動腳本
		var tim = data.registerTime,
			idx = 0,
			st1 = false, st2 = false,
			st1X = 0, st2X = 0, movX = 0, movToID = '', specY = 0,
			trainStep = (stPosAry[0].pass) ? 'running' : 'stop',//wait=>停靠站內時 , go=>dep ,  running=>兩站之間 , stop=>arr
			tmpX = stPosAry[0].pos[0], tmpY = stPosAry[0].pos[1],
			regQiduBadu = /^tra_1002|^tra_1003/,
			regBaifuQidu = /^tra_1030|^tra_1003/,
			regTS = /^tra_1007|^tra_1008/,
			regKNnagang2ZhangShuWan = /^tra_1006|^tra_8108|^tra_8106|^tra_1031/,
			offsetDim = 0,
			fnTransTime = TT.fn.transSec2Time,
			md = {};
		while(tim <= data.offlineTime){
			st1 = stPosAry[idx];
			st2 = stPosAry[idx+1];
			md = {action:trainStep, time:tim, x:Math.floor(tmpX), y:tmpY};
			//md.a = TT.fn.transSec2Time(tim);  md.ax = md.x; md.ay = md.y; //debug
			if(st2){//還有下一站
					md.st1 = st1.stid; md.st2=st2.stid;
				switch(trainStep){
					case 'stop':
						trainStep = 'wait';
						tmpX = st1.pos[0];
						tmpY = st1.pos[1];
					break;
					case 'wait':
						if(tim + baseRate >= st1.dep){
							trainStep = 'go';
							tmpX = st1.pos[0];
							tmpY = st1.pos[1];
						}
					break;
					case 'go':
						trainStep = 'running';
							tmpX = st1.afterPos[0];
							tmpY = st1.afterPos[1];
						if(st2.arr-baseRate <= tim){
							if(!st2.pass){
								trainStep = 'stop';
								tmpX = st2.pos[0];
								tmpY = st2.pos[1];
							}
						}
					break;
					case 'running':
						if(movToID==st2.stid){
							tmpX = tmpX + movX;
						}else{
							st1X = (st1.pass) ? st1.pos[0] : st1.afterPos[0]; 
							if(st2.pass){//下站不停，直接通過
								st2X = st2.pos[0];
								movX = ((st2X - st1X) / ((st2.arr - st1.dep) / baseRate));
							}else{
								st2X = st2.beforePos[0];
								offsetDim = (st1.pass) ? 1 : 2;
								movX = ((st2X - st1X) / (((st2.arr - st1.dep) / baseRate) - offsetDim));
							}
							tmpX = tmpX + movX;
							movToID = st2.stid;
						}
						
						if(/k|e/.test(data.line) && tmpY!=specY && regQiduBadu.test(st1.stid) && regQiduBadu.test(st2.stid) && (tim-st1.dep > st2.arr-tim-baseRate*2)){
							specY = st2.beforePos[1]; tmpY = specY;
						//}else if(data.trainType=='w' && tmpY!=specY && regBaifuQidu.test(st1.stid) && regBaifuQidu.test(st2.stid) ){
						}else if(data.from=='tra_1003' && tmpY!=specY && regBaifuQidu.test(st1.stid) && regBaifuQidu.test(st2.stid) ){
							if((data.dir==0 && (tim-st1.dep > st2.arr-tim)) || data.dir==1  && (3*(tim-st1.dep) > st2.arr-tim)){
								specY = st2.beforePos[1]; tmpY = specY;
							}
						}else if(regTS.test(st1.stid) && regTS.test(st2.stid) ){
							if((data.dir==1&& (tim-st1.dep > st2.arr-tim-baseRate*2)) || (data.dir==0 && (3*(tim-st1.dep) > st2.arr-tim-baseRate)) ){
								specY = st2.beforePos[1]; tmpY = specY;
							}
						}else if(regKNnagang2ZhangShuWan.test(st1.stid) && regKNnagang2ZhangShuWan.test(st2.stid) && TT.rail.mode<=3 && data.dir==0 && data.line=='k'){
							tmpY = TT.rail.baseKLRTHeight;
						}
						//if(regBaifuQidu.test(st1.stid) && regBaifuQidu.test(st2.stid) && data.trainType=='w') console.log(tim + ',' + tmpY);
						if(st2.arr-baseRate-baseRate <= tim){
							if(!st2.pass){
								tmpX = st2.beforePos[0];
								tmpY = st2.beforePos[1];
							}else{
								tmpY = st2.beforePos[1];
							}
						}
						if(st2.arr-baseRate <= tim){
							if(!st2.pass){
								trainStep = 'stop';
							}
							tmpX = st2.pos[0];
							tmpY = st2.pos[1];
						}
					break;
				}
				if(st2.arr-baseRate <= tim){//時間已走到下一站
					idx++;
				}
			}else{//端點站
				switch(trainStep){
					case 'stop':
						trainStep = 'wait';
						tmpX = st1.pos[0];
						tmpY = st1.pos[1];
					break;
					case 'running':
						tmpX = st1.pos[0];
						tmpY = st1.pos[1];
					break;
				}
			}
			stStepAry.push(md);
			tim += baseRate;
		}
		return stStepAry;
	}
	var createTrain = function(){
		if(me.train) return me.train;
		var rt = '',
			alignTop = carOutHeight - alignHeight,
			carData = '',
			carLeft = Math.ceil((carOutWidth - carInWidth) /2),
			carCls = 'car' + data.trainType.toUpperCase(),
			dom = document.createElement('div');
		
		if(TT.rail.mode==5){
			if(data.trainType=='p' && (data.from=='tra_1006' || data.to=='tra_1006')){
				carCls = 'carK';
			}
		}
		
		var giveTopLeftWidthHeight = function(top, left, width, height){
			var stl = (top || top===0) ? 'top:' + top + 'px;' : '';
			stl += (left || left===0) ? 'left:' + left + 'px;' : '';
			stl += (width || width===0) ? 'width:' + width + 'px;' : '';
			stl += (height || height===0) ? 'height:' + height + 'px;' : '';
			return stl;
		}
		carData = '<div>' + data.tag + '</div>';
		rt = '<div class="carClass ' + carCls + '" id="' +me.divInID+ '" style="' + giveTopLeftWidthHeight(0, carLeft, carInWidth, carInHeight) + '">' + TT.fn.getCarByTrainType(data.trainType).name + '</div>'+
			'<div class="carAlign ttHide" style="' + giveTopLeftWidthHeight(alignTop, 0, alignWidth, alignHeight) + '" id="' + me.divAlignID + '">' + carData + '</div>';
		dom.id = me.divOutID;
		dom.className = 'carOut speedRate' + TT.rate + 'x';
		dom.style.width = carOutWidth + 'px';
		dom.style.height = carOutHeight + 'px';
		dom.trainOffsetLeft = 0 - (carOutWidth/2);
		dom.trainOffsetTop = 0 - (carInHeight/2);
		dom.addEventListener('click', function(e){
			var css = e.target.className,
				ad = dom.querySelector('div.carAlign');
			if(/carClass/.test(css)){
				var flg = !(/ttHide/.test(ad.className));
				if(flg){
					ad.className = ad.className + ' ttHide';
				}else{
					ad.className = ad.className.replace(' ttHide','');
				}
			}
		});
		dom.innerHTML = rt;
		
		return dom;
	}
	//me.getStepAry = function(){return me.stepAry;}
	me.readyGo = function(){
		data.isRegistered = true;
		me.stepAry = createStep();
		me.train = createTrain();
		document.getElementById('stationLayer').appendChild(me.train);
		me.isRendered = true;
		me.setPosition(0);
	}
	var trainRunningClass = {"running": '', "wait": ' carOnStation', "go": ' carOnStation', "stop": ''},
		divTrain = false;
		
	me.setPosition = function(idx){
		var pos = me.stepAry[idx];
		var t = me.train;
		divTrain = divTrain || document.getElementById(me.divInID);
		t.style.left = pos.x + t.trainOffsetLeft + 'px'; 
		t.style.top = pos.y + t.trainOffsetTop + 'px';
		me.lastStepIndex = idx;
		divTrain.className = divTrain.className.replace(' carOnStation','') + trainRunningClass[pos.action];
		
	}
	me.moveTrain = function(time){
		time = time || TT.nowTime;
		for(var i = me.lastStepIndex; i<me.stepAry.length; i++){
			if(me.stepAry[i].time >= time){
				me.setPosition(i);
				break;
			}
		}
	}
	me.removeTrain = function(){
		document.getElementById('stationLayer').removeChild(me.train);
	}
	me.offline = function(){
		data.bye = true;
		me.removeTrain();
	}
	
}
TT.registerTrain = function(cfg){
	cfg = cfg || {};
	var tmpRemoveIndexAry = [],
		tmpA = false, tmpB = false;
	//先將到達終點站的列車下線，並移動其他車輛
	for(var i=TT.timeGo.length-1; i>=0; i--){
		if(TT.timeGo[i].data.offlineTime <= TT.nowTime){
			TT.timeGo[i].offline();
			TT.timeGo.splice(i,1);
		}else{
			TT.timeGo[i].moveTrain();
		}
	}
	//1.根據 TT.readyGoIndexAry 找 TT.timeTable 中所有未上線列車註冊到 TT.timeGo 
	TT.readyGoIndexAry.map(function(c,idx){
		tmpA = TT.timeTable[c];
		if(!tmpA.isRegistered && tmpA.registerTime <= TT.nowTime){
			tmpRemoveIndexAry.push(idx);
			tmpB = new TT.classTrain(tmpA);
			TT.timeGo.push(tmpB);
			TT.simTrain.push(tmpB);
			tmpB.readyGo();
		}
	});
	//2.從 TT.readyGoIndexAry 移除 index
	for(var j=tmpRemoveIndexAry.length-1; j>=0; j--){
		TT.readyGoIndexAry.splice(tmpRemoveIndexAry[j],1);
	}
	
}
TT.sim = function(){
	
	var arg = this;
	var endTime = (TT.startHour + TT.runHour) *60*60;
	var jump = TT.baseRate;
	var controlTimer = function(){
		TT.nowTime = TT.nowTime + jump;
		if(TT.nowTime <= endTime || TT.timeGo.length>0){//跑到所有列車結束運轉
			arg.time = TT.nowTime;
		}else{
			stopTimer();
		}
		
		TT.registerTrain();//執行看是否需要註冊列車
	}
	var stopTimer = function(){
		clearInterval(TT.timerID);
		TT.timerID = false;
		arg.flagGo = false;
	}
	var initTimer = function(){
		arg.flagGo = true;
		TT.timerID = setInterval(controlTimer, TT.timerInterval);
	}
	
	if(TT.timerID && TT.timerID!==0){
		stopTimer();
		return false;
	}
	//先產生要使用的時刻表
	TT.timeTable = TT.makeAllRouteTimeTable(TT.startHour, TT.runHour);
	//產生一組和 TT.timeTable 相對的 index 陣列，每次上線發車後用 splice 移除，當陣列長度將為 0 時代表所有車都上線發車
	var readyGoIndexAry = new Array(TT.timeTable.length);
	for(var i=0; i<readyGoIndexAry.length; i++){readyGoIndexAry[i]=i;}
	TT.readyGoIndexAry = readyGoIndexAry;
	TT.timeGo.map(function(t){
		t.offline();
	});
	TT.timeGo = [];//重置上線列車清為零
	TT.simTrain = [];
	
	//基準為每 1000ms 執行 20 秒鐘模擬，若 rate 調為 40 則用 1000x20/40 = 500
	TT.timerInterval = 1000 * jump / TT.rate;
	TT.nowTime = TT.startHour*60*60 - 60;//倒退一分鐘準備發車
	
	initTimer();
	return TT.timerID;
}


TT.parseModule = (function(){
	//trainGoTime 轉換網址列作法t=y_1-3&t=w_1-20 , 因 "," 會被轉 %2C 增長網址故捨棄
		//數字直接換算，停靠較久用 ~ 連接，待避用 w 連接，過站不停的時間用 p 寫前綴
		//轉換網址列作法 a=t_1&b=t&c=e&d=1&e=1002&f=1008&g=%E5%8F%B0%E6%9D%B1-%E6%A8%B9%E6%9E%97&h=p32-p34-p36-p39-p40-p41-45-50-57~60&q=   <<< q 為斷符代表一個 module 的結束
	var pek = {a:"mod",b:"trainType",c:"line",d:"dir",e:"from",f:"to",g:"tag",h:"time"}, mk;
	var getPek = function(ta){for(mk in pek){if(ta==pek[mk]){return mk;}};}
	var tmpA, tmpB, tmpC, tmpD, sk, drt;
	
	var trainGoTimeStr = '', trainModuleTimeStr = '';
	var se = TT.fn.getSearch();
	function time2str(){
		tmpA = [];
		TT.trainGoTime.map(function(c){
			tmpA.push(c[0] + '-' + c[1]);
		});
		return tmpA.join('*');
	}
	function str2time(str){
		if(!str) return false;
		tmpA = str.split('*'), tmpC = [];
		tmpA.map(function(c){
			tmpB = c.split('-');
			tmpC.push([tmpB[0], parseInt(tmpB[1])]);
		});
		return tmpC;
	}
	function module2str(){
		tmpA = [], tmpB = [], tmpC = [];
		TT.trainModuleTime.map(function(c){
			tmpB = [];
			for(sk in c){
			//console.log(sk);
				tmpC = c[sk];
				switch(sk){
					case "from":
					case "to":
						tmpC = c[sk].replace('tra_','');
					break;
					case "time":
						tmpC = c[sk].join('-');
					break;
				}
				tmpB.push(getPek(sk) + '*' + tmpC);
			}
			tmpA.push(tmpB.join('!'));
		});
		return tmpA.join('()');
	}
	function str2module(str){
		if(!str) return false;
		tmpA = str.split('()'), tmpB = [], tmpC = [], tmpD = '';
		var objB = {}, aryA = [];
		tmpA.map(function(c){
			tmpB = c.split('!');
			objB = {};
			tmpB.map(function(ca){
				tmpC = ca.split('*');
				sk = pek[tmpC[0]];
				drt = tmpC[1];
				switch(sk){
					case "from":
					case "to":
						drt = 'tra_' + tmpC[1];
					break;
					case "time":
						drt = tmpC[1].split('-');
						
						for(var i=0; i<drt.length; i++){
							if(/^[0-9]*$/.test(drt[i])){
								drt[i] = parseInt(drt[i]);
							}
						}
					break;
				}
				objB[sk] = drt;
			});
			aryA.push(objB);
		});
		return aryA;
	}
	
	function getURL(){
		var w = location.href.toString().replace(location.search,'');
		return w + '?pr=1&r=' + TT.rail.mode + '&t=' + encodeURIComponent(time2str()) + '&m=' + encodeURIComponent(module2str()) + '&h=' + TT.startHour + '*' + TT.runHour;
	}
	function parseURL(){
		var objA = TT.parseModule.search;
		var spt = (objA.h) ? objA.h.split('*') : [false,false];
		return {
				startHour: spt[0],
				runHour: spt[1],
				pr: objA.pr ,
				guideKLRT: objA.q,
				stationInfoWindow: objA.sw,
				railMode: objA.r,
				trainGoTime: str2time(objA.t),
				trainModuleTime: str2module(objA.m)
		}
	}
	function updateCarData(objA){
		objA = objA || parseURL();
			
        if(objA.trainGoTime) TT.trainGoTime = objA.trainGoTime;
        if(objA.trainModuleTime) TT.trainModuleTime = objA.trainModuleTime;
        if(objA.trainGoTime || objA.trainModuleTime){
        	TT.editTimeTableByPeople = true;
        }
        if(objA.startHour) TT.startHour = objA.startHour;
        if(objA.runHour) TT.runHour = objA.runHour;
        if(objA.railMode) TT.rail.mode = objA.railMode;
        if(objA.pr==1) TT.autoPlayTrain = true;
        if(objA.stationInfoWindow) TT.open_stationInfoWindow = objA.stationInfoWindow;
        if(objA.guideKLRT){
        	TT.startHour = objA.startHour || 6;
        	TT.runHour = objA.runHour || 4;
        	TT.rail.mode = function(){
        		var rt = 4;
        		switch(objA.guideKLRT) {
        			case '2':
        			case '3':
        			case '4':
        			case '5':
        				rt = parseInt(objA.guideKLRT);
        			break;
        			case '14':
        			case '24':
        				rt = 4;
        			break;
        		}
        		return rt;
			}();
        	TT.autoPlayTrain = true;
			TT.showDescription = parseInt(objA.guideKLRT);
		}
		return objA;
	}
	
	return {
		search: se,
		getURL: getURL,
		parseURL: parseURL,
		updateCarData: updateCarData,
		module2str: module2str,
		time2str: time2str,
		str2module: str2module,
		str2time: str2time
	}
})();


TT.createMenuBar = function(){
	
	var tpl = Vue.compile('<div id="menuBarRenderDiv">' +
		'<div class="menuBar">' +
			'<div v-on:click="railSwitch()" class="menuItem menuItem2 railSwitch">切換軌道模式</div>' +
			'<div v-on:click="vSimulate()" class="setItem setItem2 hiasd" v-bind:class="ren(\'sim\')">基隆輕軌暨台鐵基隆台北模擬器</div>' +
			'<div v-on:click="vParam()" class="setItem setItem2" v-bind:class="ren(\'param\')">設定參數</div>' +
			'<div v-on:click="back()" class="menuItem menuItem2 back">回到接軌時刻</div>' +
		'</div>' +
		'<div class="railSwitchArea" v-show="flagShowRailSwitch" style="padding:0px 10px;border-radius:5px; display:inline-block;overflow:hidden; transition:all 0.3s ease-in-out; min-width:1400px;">' +
			'<div class="setItem" v-bind:class="getButtonCls(4)" v-on:click="setRailMode(4)">台鐵南港至八堵間四軌化、基隆輕軌雙軌化</div>' +
			'<div class="setItem" v-bind:class="getButtonCls(3)" v-on:click="setRailMode(3)">第三軌給基隆輕軌專用，新增南港展覽館、樟樹灣及北五堵做交會車站</div>' +
			'<div class="setItem" v-bind:class="getButtonCls(2)" v-on:click="setRailMode(2)">第三軌給基隆輕軌專用，只新建南港展覽館站</div>' +
			'<div class="setItem" v-bind:class="getButtonCls(5)" v-on:click="setRailMode(5)">台鐵四軌化</div>' +
		'</div>' +
	'</div>');

	var vm = new Vue({
		el: '#menuBarRenderDiv',
		render: tpl.render,
		staticRenderFns: tpl.staticRenderFns,
		data: {
			flagShowRailSwitch: false,
			railMode: TT.rail.mode,
			page: 'sim'
		},
		methods: {
			back: function(){
				location.href = './';
			},
			ren: function(id){
				return (id==this.page) ? 'selected' : '';
			},
			getButtonCls: function(n){
				if(n==this.railMode) return 'selected';
				return '';
			},
			setRailMode: function(n){
				if(n) TT.rail.mode = n;
				this.railMode = TT.rail.mode;
				TT.showDescription = false;
				TT.map.clearMarStr();
				TT.processFirst();
				TT.map.reDrawMap();
				this.flagShowRailSwitch = false;
				TT.timeTableArea.updateTimeTableRawData(TT.makeAllRouteTimeTable(7));
			},
			railSwitch: function(){
				var dom = this.$el.querySelector('.railSwitchArea');
				var me = this;
				this.flagShowRailSwitch = !this.flagShowRailSwitch;
				if(this.flagShowRailSwitch){
					dom.style.height = '0px';
					setTimeout(function(){
						dom.style.height = '40px';
					},10);
				}
			},
			vSimulate: function(){
				this.page='sim';
				TT.timeArea.seen = true;TT.map.seen = true;TT.timeTableArea.seen = true;
				TT.setPage.seen = false;
			},
			vParam: function(){
				this.page='param';
				TT.timeArea.seen = false;TT.map.seen = false;
				if(!TT.setPage.flagShowPreviewTable) TT.timeTableArea.seen = false;
				TT.setPage.seen = true;
			}
		}
	});
	return vm;
}
TT.createTimeArea = function(){
	numAry = [];while(numAry.length < 20){numAry.push(numAry.length+1)}
	var tpl = Vue.compile('<div class="timeShowArea" id="timeShowArea"  v-show="seen">' +
		'<div class="time" >模擬時刻 {{displayTime()}}</div>' +
		'<div class="status" v-html="getGoStatus()"></div>' +
		'<div v-on:click="sim4Rail()" class="setItem sim4Rail">{{ flagGo ? \'停止模擬\' : \'啟動模擬\' }}</div>' +
		'<div style="margin:5px 0px 5px 20px;">' +
			'<span>從</span>' +
			'<select v-model="startHour"><option v-for="n1 in numAry" v-bind:value="n1">{{n1}}</option></select>' +
			'<span>點鐘開始以</span>' +
			'<select v-model="rateNum"><option value="20">20</option><option value="40">40</option><option value="60">60</option><option value="80">80</option></select>' +
			'<span>倍速模擬發車</span>' +
			'<select v-model="runHour"><option v-for="n2 in numAry" v-bind:value="n2">{{n2}}</option></select>' +
			'<span>個小時</span>' +
			//'<input type="checkbox" v-model="syncTimeShow" id="synctb"><label for="synctb" style="color:#AEAD2D;">同步更新下方時刻表</label>' +
		'</div>' +
	'</div>');
	var vm = new Vue({
		el: '#timeShowArea',
		render: tpl.render,
		staticRenderFns: tpl.staticRenderFns,
		data: {
			flagGo: false,
			seen: true,
			numAry: numAry,
			syncTimeShow: true,
			startHour: TT.startHour,
			runHour: TT.runHour,
			rateNum: TT.rate,
			time: TT.startHour*60*60
		},
		methods: {
			displayTime: function(){
				return TT.fn.transSec2Time(this.time);
			},
			getGoStatus: function(){
				var st = '';
				st += '<div class="hold">等待發車:' + TT.readyGoIndexAry.length + ' 列</div>';
				st += '<div class="running">線上運轉:' + TT.timeGo.length + ' 列</div>';
				return (this.flagGo) ? st : '';
			},
			sim4Rail: function(){
				var sthr = parseInt(this.startHour),
					rtn = parseInt(this.rateNum),
					rhr = parseInt(this.runHour);
					
				if(sthr < 1 || sthr > 23 || rhr < 1 || rhr > 20){
					alert("輸入值錯誤，啟動時間應介於 1 點至 23 點間，運轉時間最少 1 小時，最多 20 小時");
					return false;
				}
				TT.startHour = sthr; TT.runHour = rhr; TT.rate = rtn;
				TT.sim.call(this);
				
				if(this.syncTimeShow && this.flagGo){
					TT.timeTableArea.updateTimeTableRawData(TT.timeTable);
				}
			}
		},
		mounted: function(){
			var me = this;
			if(TT.autoPlayTrain){
				setTimeout(function(){me.sim4Rail()},1000);
				TT.autoPlayTrain = false;
			}
		}
	});
	return vm;
}

TT.genStationOnMap = function(){
	var aryA = [],
		pos = [],
		flgIsRotate = false,
		st = false;
	
	var makePlatform = function(st){
		var flagIsCommonStation = !!(/^tra_1001|^tra_1029|^tra_1002/.test(st.id));
		var aryP = [],
			flagPlatformHasTRA = /w|e/.test(st.line),
			flagPlatformHasKLRT = /k/.test(st.line) && !flagIsCommonStation,
			r = TT.rail,
			line = st.line,
			str = '',
			pa = {num:0, build: "a", comp: "TRA", main: false, ary: [false,{main: true, dir: 1}]},
			//陣列零為左股道，主幹通過此月台時 main 為 true, build :a左股側，b右股側，c島式，comp 為營運者 TRA 或 KLRT 無則填 false 代表側式月台
			platform = st.platform,
			platMain = st.platMain;
		var dir1MainTRA = platMain[0];
		var dir0MainTRA = platMain[1];
		var dir1MainKLRT = (st.line=="k") ? platMain[0] : platMain[2];
		var dir0MainKLRT = (st.line=="k") ? platMain[1] : platMain[3];
		
		if(!flgIsRotate){
			//先分析車站型態，再從platMain 的第一個月台定位
			var firstMainPlatformIndex = 0,
				firstMainPlatformSide = '',
				firstMainPatformTop = -1;
			
			for(var i=0; i<platform.length; i++){
				str = platform[i];
				if(line=="k" || (/k/.test(line) && /c|d/.test(str)&& !flagIsCommonStation)){//基隆輕軌月台
					pa = {
						num: str.substr(0,1),
						index: i,
						top: r.baseKLRTHeight - r.platformRailMargin - r.platformHeight,
						comp: 'KLRT'
					}
					pa.platformElTop = TT.fn.getPlatformElTop(pa.top);
					if(str.length==4){
						pa.build = 'c';
						pa.ary = [{main: false},{main: false}]
					}else{
						pa.build = /c/.test(str) ? 'a' : 'b';
						if(pa.build=='a'){
							pa.ary = [{main: false},false];
						}else{
							pa.ary = [false, {main: false}];
						}
					}
					if(str.indexOf(dir1MainKLRT)>=0 || str.indexOf(dir0MainKLRT)>=0){
						pa.main = true;
						if(str.indexOf(dir1MainKLRT)>=0){
							pa.ary[0] = {main:true, dir: 1};
						}
						if(str.indexOf(dir0MainKLRT)>=0){
							pa.ary[1] = {main:true, dir: 0};
						}
					}
				}else{//台鐵月台
					pa = {
						num: str.substr(0,1),
						index: i,
						top: -1,
						comp: 'TRA'
					}
					if(str.length==4){
						pa.build = 'c';
						pa.ary = [{main: false},{main: false}]
					}else{
						pa.build = /a/.test(str) ? 'a' : 'b';
						if(pa.build=='a'){
							pa.ary = [{main: false},false];
						}else{
							pa.ary = [false, {main: false}];
						}
					}
					if(str.indexOf(dir1MainTRA)>=0 || str.indexOf(dir0MainTRA)>=0){
						pa.main = true;
						if(str.indexOf(dir1MainTRA)>=0){
							pa.ary[1] = {main:true, dir: 1};
							firstMainPlatformIndex = i;
							firstMainPlatformSide = /a/.test(dir1MainTRA) ? 'a' : 'b';
							pa.top = (firstMainPlatformSide=='a') ? r.baseHeight - r.platformRailMargin - r.platformHeight : r.baseHeight + r.lineMainWidth + r.platformRailMargin;
							firstMainPatformTop = pa.top;
						}
						if(str.indexOf(dir0MainTRA)>=0){
							pa.ary[0] = {main:true, dir: 0};
						}
					}
					
				}
				
				aryP.push(pa);
			}
		}
		
		var tmpA = 0, tmpB = 0;
		for(var i=0; i<aryP.length; i++){
			if(aryP[i].comp != 'TRA') continue;
			if(aryP[i].index < firstMainPlatformIndex){
				tmpB = (firstMainPlatformSide=='b') ? r.platformHeight : 0;
				tmpA = ((r.platformSideOutMargin*2 + r.platformHeight) * (firstMainPlatformIndex - aryP[i].index)) + firstMainPatformTop;
			}else if(aryP[i].index > firstMainPlatformIndex){
				tmpB = (firstMainPlatformSide=='b') ? r.platformHeight + r.platformRailMargin : 0;
				tmpA = firstMainPatformTop - ((r.platformSideOutMargin*2 + r.platformHeight) * (aryP[i].index - firstMainPlatformIndex) + tmpB);
			}else{
				tmpA = firstMainPatformTop;
			}
			aryP[i].top = tmpA;
			aryP[i].platformElTop = TT.fn.getPlatformElTop(tmpA);
		}
		return aryP;
	}
	
	function getRailTop(platformAry){
		var num = '', rt = {}, p = false;
		for(var i=0; i<platformAry.length; i++){
			p = platformAry[i];
			num = 'p' + p.num;
			var leftString = (p.comp=='TRA') ? 'a' : 'c',
				rightString = (p.comp=='TRA') ? 'b' : 'd';
			switch(p.build){
				case 'c':
					rt[num+leftString] = p.platformElTop.leftRail;
					rt[num+rightString] = p.platformElTop.rightRail;
				break;
				case 'a':
					rt[num+leftString] = p.platformElTop.leftRail;
				break;
				case 'b':
					rt[num+rightString] = p.platformElTop.rightRail;
				break;
			}
		}
		return rt;
	}
	TT.station.map(function(c){
		st = JSON.parse(JSON.stringify(c));
		flgIsRotate = !!st.rotate;
		pos = st.pos;
		
		if(!flgIsRotate){
			st.x = pos[0] * TT.stBlockWidth;
			st.y = pos[1] * TT.stBlockHeight;
			st.boxWidth = TT.stBlockWidth;
			st.boxHeight = TT.stBlockHeight;
			
			st.platformAry = makePlatform(st);
			st.railTop = getRailTop(st.platformAry);
		}else{
			st.x = pos[0] * TT.stBlockWidth ;
			st.y = pos[1] * TT.stRotateBlockHeight + TT.stBlockHeight - TT.stRotateBlockHeight;
			st.boxWidth = TT.stRotateBlockWidth;
			st.boxHeight = TT.stRotateBlockHeight;
			
			st.platformAry = makePlatform(st);
			st.railTop = getRailTop(st.platformAry);
		}
		aryA.push(st);
	});
	return aryA;
}


TT.appendDrawLine = function(canvas, outDom, penDom){
	
	outDom = (typeof(outDom)=='string') ? document.getElementById(outDom) : outDom;
	canvas = (typeof(canvas)=='string') ? document.getElementById(canvas) : canvas;
	var caID = canvas.id, caWidth = canvas.width, caHeight = canvas.height, cc = canvas.getContext('2d');
	if(penDom){
		penDom = (typeof(penDom)=='string') ? document.getElementById(penDom) : penDom;
		penDom.style.width = caWidth + 'px';penDom.style.height = caHeight + 'px';
	}else{
		penDom = outDom;
	}
	if(penDom.alreadyRenderPen) return false;
	penDom.alreadyRenderPen = true;
	var sx=0,sy=0,ex=0,ey=0,flagDraw=false,svg1=false,svgLine1=false,colorS='#01FE0a',svgLineID = caID + '_svg_line';
	var getCalcXY=function(x,y){
		var pos = canvas.getBoundingClientRect();
		return {
			x: x - Math.floor(pos.left),
			y: y - Math.floor(pos.top)
		}
	}
	var createSVG = function(x,y){
		div = outDom;
		if(!svg1){
			svg1 = document.createElementNS("http://www.w3.org/2000/svg", "svg");
			svg1.id = caID + '_svg';
			svg1.setAttribute('height',caHeight); svg1.setAttribute('width',caWidth);
			svg1.style.position = 'absolute';  svg1.style.zIndex = '6';
			div.appendChild(svg1);
			svg1.innerHTML = '<line stroke="' + colorS + '" id="' + svgLineID + '" stroke-width="2" x1="0" y1="0" x2="1" y2="1"></line>';
			svgLine1 = document.getElementById(svgLineID);
		}
		svg1.style.display = '';
		svg1.style.left=x+'px'; svg1.style.top=y+'px';
		svg1.setAttribute('height',0); svg1.setAttribute('width',0);
		svgLine1 = document.getElementById(svgLineID);
	}
	penDom.addEventListener('mousedown', function(e){
		if(!penDom.alreadyDrawUserLine) return false;
		var pos = getCalcXY(e.x, e.y);
		sx = pos.x; sy = pos.y;
		flagDraw = true;
		createSVG(sx,sy);
	});
	penDom.addEventListener('mousemove', function(e){
		if(!svg1 || !flagDraw) return false;
		var pos = getCalcXY(e.x, e.y);
		var w = Math.abs(pos.x - sx), h = Math.abs(pos.y - sy);
		if(w<2)w=2; if(h<2) h=2;
		
		svg1.setAttribute('height',h); svg1.setAttribute('width',w);
		if(pos.x < sx){
			svg1.style.left = pos.x + 'px';
			svgLine1.setAttribute('x1', 0); svgLine1.setAttribute('x2', '100%');
		}else{
			svg1.style.left = sx + 'px';
			svgLine1.setAttribute('x1', '100%'); svgLine1.setAttribute('x2', 0);
		}
		if(pos.y < sy){
			svg1.style.top = pos.y + 'px';
			svgLine1.setAttribute('y1', 0); svgLine1.setAttribute('y2', '100%');
		}else{
			svg1.style.top = sy + 'px';
			svgLine1.setAttribute('y1', '100%'); svgLine1.setAttribute('y2', 0);
		}
	}, true);
	penDom.addEventListener('mouseup', function(e){
		if(!svg1 || !flagDraw) return false;
		var pos = getCalcXY(e.x, e.y);
		ex = pos.x; ey = pos.y;
		cc.fillStyle = colorS;cc.strokeStyle = colorS;
		cc.beginPath();
		cc.moveTo(sx,sy);
		cc.lineTo(ex,ey);
		cc.stroke();
		flagDraw = false;
		svg1.style.display = 'none';
	}, true);
	
	penDom.alreadyDrawUserLine = true;
	penDom.stopDrawUserLine = function(){
		penDom.alreadyDrawUserLine = false;
	}
	penDom.startDrawUserLine = function(){
		penDom.alreadyDrawUserLine = true;
	}
	return penDom;
}
TT.genRouteOnMap = function(canvasID, stAry){
	var canvas = document.getElementById(canvasID),
		cc = canvas.getContext('2d'),
		horCount = 0,
		klrtCount = 0,
		platfomDrawLineAry = [],
		platfomDrawKLRT3LineAry = [], platfomDrawKLRT3LineQidu = false,
		platformBoxAry = [],
		platformLeftMargin = Math.ceil((TT.stBlockWidth - TT.rail.platformWidth)/2),
		platformAry = false,
		stNameAry = [],
		transRailOffset = 12,
		platformSlaveLineWidth = TT.rail.platformWidth + 8,
		flgDir1 = false,
		stQidu = false, stBadu = false, stKeelung = false,
		tmpC = 0,
		r = TT.rail;
	var lineLeftRightMargin = ((TT.stBlockWidth - platformSlaveLineWidth) / 2);
	
	stAry.map(function(c){
		if(c.pos[1]==0){
			horCount++;
			if(!/^tra_1001|^tra_1029|^tra_1002/.test(c.id)){
				klrtCount++;
			}
		}
		stNameAry.push([c.name, c.pos[0]*TT.stBlockWidth]);
		if(/^tra_1002|^tra_1003/.test(c.id)){
			if(c.id=='tra_1002') stBadu = c;
			if(c.id=='tra_1003') stQidu = c;
		}
		c.platformAry.map(function(p){
			var offsetA = 0;
			platformBoxAry.push([c.pos[0]*TT.stBlockWidth + platformLeftMargin, p.top, p.num]);
			if(p.comp=='TRA' && c.id!='tra_1002'){
				if(p.ary[0] && !p.ary[0].main){
					platfomDrawLineAry.push([c.pos[0]*TT.stBlockWidth + lineLeftRightMargin, p.platformElTop.leftRail]);
				}
				if(p.ary[1] && !p.ary[1].main){
					platfomDrawLineAry.push([c.pos[0]*TT.stBlockWidth + lineLeftRightMargin, p.platformElTop.rightRail]);
				}
			}else if(TT.rail.mode<=3 && p.comp=='KLRT'){
				if(p.ary[1] && p.build=='c'){
					if(c.id=='tra_1003'){
						platfomDrawKLRT3LineQidu = ([c.pos[0]*TT.stBlockWidth + lineLeftRightMargin, p.platformElTop.rightRail]);
					}else{
						platfomDrawKLRT3LineAry.push([c.pos[0]*TT.stBlockWidth + lineLeftRightMargin, p.platformElTop.rightRail]);
					}
				}
			}
		});
	});
	canvas.width = TT.caWidth;
	canvas.height = TT.caHeight;
	var dir0TraMainHeight = r.baseHeight - (r.platformRailMargin*2 + r.platformHeight + r.lineMainWidth);
	var dir0KlrtMainHeight = r.baseKLRTHeight - (r.platformRailMargin*2 + r.platformHeight + r.lineMainWidth);
	var klrtEndOffset = lineLeftRightMargin;
	//1. Draw main line
	
	cc.beginPath();
	cc.moveTo(0, 0.5+r.baseHeight);
	cc.fillStyle = r.colorTRA;
	cc.strokeStyle = r.colorTRA;
	cc.lineTo(TT.stBlockWidth*horCount, 0.5+r.baseHeight);
	cc.lineWidth = r.lineMainWidth;
	cc.moveTo(0, 0.5+dir0TraMainHeight);
	cc.lineTo(TT.stBlockWidth*horCount, 0.5+dir0TraMainHeight);
	cc.stroke();
	
	if(TT.rail.mode<5){//5為不蓋基隆輕軌模式
		cc.beginPath();
		cc.moveTo(TT.stBlockWidth*2, 0.5+r.baseKLRTHeight);
		cc.fillStyle = r.colorKLRT;
		cc.strokeStyle = r.colorKLRT;
		cc.lineTo(TT.stBlockWidth*klrtCount - klrtEndOffset, 0.5+r.baseKLRTHeight);
		if(TT.rail.mode==4){//有蓋第四軌時基隆輕軌才為雙軌化
			cc.lineWidth = r.lineMainWidth;
			cc.moveTo(TT.stBlockWidth*2, 0.5+dir0KlrtMainHeight);
			cc.lineTo(TT.stBlockWidth*klrtCount - klrtEndOffset, 0.5+(r.baseKLRTHeight - (r.platformRailMargin*2 + r.platformHeight + r.lineMainWidth)));
		}
		cc.stroke();
	}else{
		cc.beginPath();
		var westSubTopOffset = TT.rail.westSubTopOffset, eastSubTopOffset = TT.rail.eastSubTopOffset,
			offsetXforSub = 16;
		cc.moveTo(TT.stBlockWidth*2 + 78, r.baseHeight);
		cc.lineTo(TT.stBlockWidth*2 + 85 , dir0TraMainHeight);
		cc.moveTo(TT.stBlockWidth*2 + 95, r.baseHeight + eastSubTopOffset);
		cc.lineTo(TT.stBlockWidth*2 + 78 , dir0TraMainHeight);
		cc.moveTo(TT.stBlockWidth*2 + offsetXforSub, 0.5+r.baseHeight + westSubTopOffset);
		cc.lineTo(TT.stBlockWidth*12 , 0.5+r.baseHeight + westSubTopOffset);
		cc.lineTo(TT.stBlockWidth*12 + offsetXforSub, 0.5+dir0TraMainHeight);
		cc.moveTo(TT.stBlockWidth*2 + offsetXforSub, 0.5+r.baseHeight + eastSubTopOffset);
		cc.lineTo(TT.stBlockWidth*12 , 0.5+r.baseHeight + eastSubTopOffset);
		cc.lineTo(TT.stBlockWidth*12 + offsetXforSub, 0.5+r.baseHeight);
		cc.stroke();
	}
	
	//2.畫所有月台和副線
	cc.beginPath();
	cc.fillStyle = '#000'; cc.strokeStyle = '#222'; cc.font = '14px Arial'; cc.textAlign = 'center';
	cc.lineWidth = TT.rail.platformBorderWidth;
	platformBoxAry.map(function(p){
		cc.rect(p[0]+0.5, p[1]-0.5, TT.rail.platformWidth, TT.rail.platformHeight);
		cc.fillText(p[2], p[0]+Math.floor(TT.rail.platformWidth/2), p[1] + 12);
	});
	stNameAry.map(function(c){
		cc.fillText(c[0], c[1]+TT.rail.platformWidth, 13);
	});
	cc.stroke();
	
	//+++++++++++++
	cc.beginPath();
	cc.fillStyle = r.colorTRA;
	cc.strokeStyle = r.colorTRA;
	cc.lineWidth = r.lineWidth;
	for(var i=0; i<platfomDrawLineAry.length; i++){
		flgDir1 = !!(platfomDrawLineAry[i][1] > r.baseHeight);
		if(flgDir1){
			cc.moveTo(platfomDrawLineAry[i][0] - transRailOffset, r.baseHeight);
			cc.lineTo(platfomDrawLineAry[i][0], platfomDrawLineAry[i][1]);
		}else{
			cc.moveTo(platfomDrawLineAry[i][0] - transRailOffset, dir0TraMainHeight);
			cc.lineTo(platfomDrawLineAry[i][0], platfomDrawLineAry[i][1]);
		}
		//cc.moveTo(platfomDrawLineAry[i][0], platfomDrawLineAry[i][1]);
		cc.lineTo(platfomDrawLineAry[i][0] + platformSlaveLineWidth, platfomDrawLineAry[i][1]);
		if(flgDir1){
			cc.lineTo(platfomDrawLineAry[i][0] + platformSlaveLineWidth + transRailOffset, r.baseHeight);
		}else{
			cc.lineTo(platfomDrawLineAry[i][0] + platformSlaveLineWidth + transRailOffset, dir0TraMainHeight);
		}
	}
	cc.stroke();
	
	if(TT.rail.mode<=3){
		cc.beginPath();
		cc.fillStyle = r.colorKLRT;
		cc.strokeStyle = r.colorKLRT;
		cc.lineWidth = r.lineWidth;
		for(var i=0; i<platfomDrawKLRT3LineAry.length; i++){
			cc.moveTo(platfomDrawKLRT3LineAry[i][0] - transRailOffset, r.baseKLRTHeight);
			cc.lineTo(platfomDrawKLRT3LineAry[i][0], platfomDrawKLRT3LineAry[i][1]);
			cc.lineTo(platfomDrawKLRT3LineAry[i][0] + platformSlaveLineWidth, platfomDrawKLRT3LineAry[i][1]);
			cc.lineTo(platfomDrawKLRT3LineAry[i][0] + platformSlaveLineWidth + transRailOffset, r.baseKLRTHeight);
		}
		if(platfomDrawKLRT3LineQidu){
			cc.moveTo(platfomDrawKLRT3LineQidu[0] - transRailOffset, r.baseKLRTHeight);
			cc.lineTo(platfomDrawKLRT3LineQidu[0], platfomDrawKLRT3LineQidu[1]);
			cc.lineTo(platfomDrawKLRT3LineQidu[0] + platformSlaveLineWidth, platfomDrawKLRT3LineQidu[1]);
		}
		cc.stroke();
	}
	
	//3.畫七堵到八堵間台鐵宜蘭線連接線
	cc.beginPath();
	cc.fillStyle = r.colorTRA;
	cc.strokeStyle = r.colorTRA;
	cc.lineWidth = r.lineMainWidth;
	var y1X = stBadu.pos[0] * TT.stBlockWidth,
		y1Y = stBadu.platformAry[1].platformElTop.leftRail,
		y2Y = stBadu.platformAry[0].platformElTop.rightRail;
	
	cc.moveTo(y1X, dir0TraMainHeight);
	cc.lineTo(y1X + transRailOffset + 5, y1Y);
	cc.lineTo(y1X + 100, y1Y);
	cc.moveTo(y1X, r.baseHeight);
	cc.lineTo(y1X + transRailOffset, y2Y);
	cc.lineTo(y1X + 100, y2Y);
	cc.stroke();
	
	//4.畫七堵到八堵間基隆輕軌連接線
	if(TT.rail.mode<5){//5為不蓋基隆輕軌模式
	cc.beginPath();
	cc.fillStyle = r.colorKLRT;
	cc.strokeStyle = r.colorKLRT;
	cc.lineWidth = r.lineWidth;
	
	var line1X = stQidu.pos[0] * TT.stBlockWidth + lineLeftRightMargin + platformSlaveLineWidth,
		line1Y = (TT.rail.mode==4 || true) ? stQidu.platformAry[stQidu.platformAry.length-1].platformElTop.rightRail : stQidu.platformAry[stQidu.platformAry.length-1].platformElTop.leftRail,
		line2Y = stQidu.platformAry[stQidu.platformAry.length-1].platformElTop.leftRail;
	
	var line1XEnd = stBadu.pos[0] * TT.stBlockWidth + lineLeftRightMargin,
		line1YEnd = stBadu.platformAry[2].platformElTop.rightRail - r.lineWidth,
		line2YEnd = stBadu.platformAry[2].platformElTop.leftRail + r.lineWidth;
	
	cc.moveTo(line1X, line1Y);
	cc.lineTo(line1XEnd, line1YEnd);
	cc.lineTo(horCount*TT.stBlockWidth, line1YEnd);
	
	cc.moveTo(line1X, line2Y);
	cc.lineTo(line1XEnd, line2YEnd);
	cc.lineTo(horCount*TT.stBlockWidth, line2YEnd);
	cc.stroke();
	}
	
	
}

TT.createMap = function(){
	var rail = TT.rail;
	var pen = false;
	var aryMarTx = [
		false, false,
		'使用南港到八堵間第三軌改造為基隆輕軌專用線，除南港展覽館外不增加車站，<span style="color:#CE2020;">汐止站移撥一個月台給基隆輕軌，此後南港到七堵間長達 13 公里無待避交會車站</span>，每小時最多行駛十班車，五班區間車、五班對號快車。'+
		'基隆出發的區間車 20 分鐘一班，TRAM TRAIN 輕軌 20 分鐘一班，八堵至南港間的車站每小時可額外增加宜蘭線區間車兩班，<span style="color:#2020FE;">板南線旅客往汐止基隆可在南港站視最近列車為台鐵列車或基隆輕軌而選擇，文湖線旅客只能轉乘 20 分鐘一班的基隆輕軌</span>。'+
		'基隆輕軌單線雙向，以七堵到汐止、汐止到南港為兩個單線運轉區間，在七堵及汐止列車交會，每一區間行駛十分鐘後交會，總行駛時間 30 分鐘。明顯缺點為一旦有列車延遲就會影響到整體行車時間且文湖線轉乘旅客候車要 20 分鐘過久。',
		
		'使用南港到八堵間第三軌改造為基隆輕軌專用線，除南港展覽館外並新增樟樹灣及北五堵為交會站，<span style="color:#CE2020;">汐止站移撥一個月台給基隆輕軌，此後南港到七堵間長達 13 公里無待避交會車站</span>，每小時最多行駛十班車，五班區間車、五班對號快車，且各車種分佈無法平均化。'+
		'基隆出發的台鐵區間車 20 分鐘一班，TRAM TRAIN 輕軌 20 分鐘一班，<span style="color:#1020A0;">另行駛南港至北五堵站 TRAM TRAIN 區間車，使南港至北五堵間加密到 10 分鐘一班 TRAM TRAIN 輕軌</span>。' +
		'八堵至南港間的車站每小時可額外增加宜蘭線區間車兩班，<span style="color:#2020FE;">板南線旅客往汐止基隆可在南港站視最近列車為台鐵列車或基隆輕軌而選擇，文湖線旅客只能轉乘 10 分鐘一班的基隆輕軌，但要往百福、七堵至基隆則依舊 20 分鐘一班</span>。' +
		'基隆輕軌單線雙向，以<span style="color:#CE2020;">七堵、北五堵、汐止、樟樹灣、南港展覽館分拆運轉區間並交會列車</span>，基本每一行駛區間內為五分鐘，但因汐止到樟樹灣時間很短而使得北上及南下列車會多等待對向列車一至兩分鐘進行交會，並在南港展覽館進行末端交會，進南港的列車要等往基隆的列車出來後再進去。總行駛時間 32 分鐘。明顯缺點為一旦有列車延遲就會影響到整體行車時間，但誤點發生在汐止至南港間時有機會修正，若條件允許，TRAM TRAIN 區間車可行駛至七堵折返，甚至增加開進基隆的班次。' +
		'<span style="color:#20A040;">保證可以增加班次受惠的為汐止地區</span>，其餘區間受限七堵至八堵間混線交叉班次以及貨運列車需使用來進出五堵貨調場未必可提升，',
		
		'南港到汐科間新建第四軌，汐科到五堵間於台五甲線大同路上高架新建 TRAM TRAIN 雙軌軌道，並可能於<span style="color:#CE2020;">汐止站前廣場新建第三月台作為基隆輕軌專用月台</span>，汐科和五堵則用原台鐵月台改造。五堵至八堵間新建雙軌，不經過百福車站，另外新增北五堵及六堵站。' +
		'全雙軌基隆輕軌可達成全時段五分鐘一班車，並有超過半數列車為全程車開進基隆站，<span style="color:#2020FE;">台北車站台鐵也可每五分鐘發一班車，每小時六班區間車及六班快車</span>，但基隆的區間車仍只有20分鐘一班，其餘時段可靠基隆輕軌及區間快車補足。'+
		'雖然第三軌被基隆輕軌使用，台鐵仍舊可靈活利用汐止站的待避功能增加區間車班次，但區間車明顯必需在汐止或七堵待避一次，若是板南線轉乘回基隆可以直接考慮基隆輕軌不用視情況搭台鐵。' +
		'<span style="color:#20A040;">此方案在汐科到汐止間台鐵也可以做到十分鐘一班車，五堵及百福因待避偶爾會隔 15 分鐘一班車</span>，等同可維持通往台北的班次密度，亦可連帶提升瑞芳的班次密度。'+
		'每小時三班基隆往返新竹的區間車中有兩班<span style="color:#CE2020;">可在汐止平行轉乘，如機場捷運長庚醫院站一樣快慢車乘客互轉</span>，加快五堵百福旅客往返松山、台北的速度。',
		
		'南港到八堵間新建第四軌，修改線型使之對稱，在南港到八堵間緩急分離，快車走內側軌道，慢車走外側軌道。<span style="color:#CE2020;">此方案需下足建設成本於南港站以北興建地下立體交叉穿越軌道避免交互干擾，七堵到八堵間亦需興建立體交叉橫渡線。</span>' +
		'完工後基隆每小時可維持六班往台北的列車，四班為區間車，兩班為自強號，另有六班往南港的區間車；<span style="color:#2020FE;">東部幹線台北一小時可發四班快車，南港站加發兩班快車，以及兩班宜蘭線區間車</span>大幅堤升東部幹線運能。' +
		'此方案雖可加密至基隆輕軌四軌化目標，但有南港與七堵快慢車東西線交錯之困擾，且不適合興趣樟樹灣及北五堵站。<span style="color:#CE2020;">八堵至南港間五分鐘一班區間車，八堵往來台北十分鐘一班區間車</span>，台北站五分鐘一班車一快一慢交叉發車。' +
		'<span style="color:#2EA42B;">基隆南港區間車使用立體軌道穿越至南港1月台，整備5分鐘後回頭往基隆，</span>南港站普悠瑪號使用第3月台整備；<span style="color:#CE2020;">基隆站設計為每列車發車後下一分鐘反向列車進站，區間車交錯使用月台兩側折返。</span>',
		false,false,false,false,false,//10
		false,false,false,//13
		'南港到汐科間新建第四軌，汐科到五堵間於台五甲線大同路上高架新建 TRAM TRAIN 雙軌軌道，並可能於<span style="color:#CE2020;">汐止站前廣場新建第三月台作為基隆輕軌專用月台</span>，汐科和五堵則用原台鐵月台改造。五堵至八堵間新建雙軌，不經過百福車站，另外新增北五堵及六堵站。' +
		'<span style="color:#2020FE;">台北車站台鐵也可每五分鐘發一班車，採每十五分鐘一輪兩快一慢車，每小時四循環</span>。基隆出發的台鐵區間車30分鐘一班，區間快車30分鐘一班，每小時有四班車可直達台北，另有四班基隆輕軌可至南港，頻率與機場捷運相等。' +
		'<span style="color:#CE2020;">所有區間車都在汐止待避快車，而其中往基隆的區間車均可與自強號快慢車平行轉乘</span>，因此可略微縮短基隆往返台北的時間。板南線旅客回基隆一律在南港轉車，但可視時間選擇搭台鐵或基隆輕軌。',
		false,//15
		false,false,false,false,false,//20
		false,false,false,//23
		'南港到汐科間新建第四軌，汐科到五堵間於台五甲線大同路上高架新建 TRAM TRAIN 雙軌軌道，並可能於<span style="color:#CE2020;">汐止站前廣場新建第三月台作為基隆輕軌專用月台</span>，汐科和五堵則用原台鐵月台改造。五堵至八堵間新建雙軌，不經過百福車站，另外新增北五堵及六堵站。' +
		'<span style="color:#2020FE;">台北車站台鐵也可每五分鐘發一班車，一小時四班 TEMU 往花東</span>，所有區間車都在汐止待避快車，但只能待避快車通過無法快慢車轉乘，八堵以南每小時四班區間車直達台北。' +
		'<span style="color:#CE2020;">基隆站不再駛入台鐵列車，一律五分鐘一班輕軌，可至七堵、汐止、南港轉台鐵其他列車</span>，板南線及文湖線旅客不用考慮直接搭基隆輕軌回基隆。'
	];
	var marID  = 0;
	var tpl = Vue.compile('<div class="mapOut" id="mapShowArea" v-show="seen">' +
		'<div class="routeLayer" v-html="printCanvas()" id="routeLayer"></div>' +
		'<div class="trainLayer" style="display:none;"></div>' +
		'<div class="stationLayer bs_no_select" id="stationLayer">' +
			'<div v-for="(st,idx) in stationAry" v-bind:style="getStationStyle(st.id)" class="stationOut">' +
				'<div class="stationName" v-on:click="popStation(st.id)" v-bind:class="(st.id)" v-bind:data-stid="(st.id)" v-bind:style="getStationNameStyle(st)">{{ st.name }}</div>' +
				'<div class="platformOut" v-html="printPlatform(st)"></div>' +
			'</div>' +
		'</div>' +
		'<div class="marArea"><div class="marIn" v-html="marStr"></div></div>' +
		'<div class="penArea">' +
			'<div class="penEnable" v-show="!enableDrawUserLine" v-on:click="setDrawUserLine(true)">我要畫線</div>' +
			'<div class="penDisable" v-show="enableDrawUserLine" v-on:click="setDrawUserLine(false)">關閉畫線</div>' +
			'<div class="penClear" v-on:click="reDrawMap">清除畫線</div>' +
			'<div class="penSave" v-on:click="saveCanvas">匯出圖檔</div>' +
		'</div>' +
	'</div>');
	var vm = new Vue({
		el: '#mapShowArea',
		render: tpl.render,
		data: {
			seen: true,
			neverDrawMap: true,
			enableDrawUserLine: false,
			marStr: aryMarTx[TT.showDescription],
			stationAry: TT.genStationOnMap()
		},
		methods: {
			drawMap: function(){
				if(!this.neverDrawMap){
					return false;
				}
				this.neverDrawMap = false;
				TT.genRouteOnMap('canvasRoute', this.stationAry);
				if(TT.showDescription) this.updateMar();
			},
			reDrawMap: function(){
				this.neverDrawMap = true;
				this.stationAry = TT.genStationOnMap();
				this.drawMap();
			},
			clearMarStr: function(){
				clearInterval(marID);
				this.marStr = '';
				var domMar = this.$el.querySelector('div.marIn');
				domMar.style.display = 'none';
			},
			updateMar: function(){
				this.marStr = aryMarTx[TT.showDescription];
				clearInterval(marID);
				var domMar = this.$el.querySelector('div.marIn');
				domMar.style.display = 'none';
				domMar.style.left = TT.caWidth + 100 + 'px';
				marID = setInterval(function(){
					var left = parseInt(domMar.style.left);
					if(left + parseInt(domMar.clientWidth) < 0){
						domMar.style.display = 'none';
						domMar.style.left = TT.caWidth + 100 + 'px';
					}else{
						domMar.style.display = '';
						domMar.style.left = left - 50 + 'px';
					}
				},1010);
			},
			getStationStyle: function(id){
				var st = TT.fn.getStationByID(id, this.stationAry);
				var rt = 'left:' + st.x + 'px; top:' + st.y + 'px; width:' + st.boxWidth + 'px; height:' + st.boxHeight + 'px';
				return rt;
			},
			getStationRailTop: function(id){
				var st = TT.fn.getStationByID(id, this.stationAry);
				return st.railTop;
			},
			getStationNameStyle: function(st){
				var rt = '';
				if(st.rotate){
					rt = 'width:60px;position:absolute;left:0px;text-align:left;'
				}
				if(st.id=='tra_1005'){
					rt += 'color:#2e2fef;text-decoration: underline;';
				}
				return rt;
			},
			popStation: function(stid){
				switch(stid){
					case 'tra_1005':
						TT.teachImp.showStation1005();
					break;
				}
			},
			printCanvas: function(){
				return '<canvas id="canvasRoute" width="' + TT.caWidth + '" height="' + TT.caHeight + '"></canvas>';
			},
			printPlatform: function(st){
				var rt = '';
				var pAry = st.platformAry;
				pAry.map(function(c){
					rt += '<div class="platformDiv" style="top:' + c.top + 'px;">' + c.num + '</div>';
				});
				return rt;
			},
			saveCanvas: function(){
				var canvas = document.getElementById('canvasRoute');
				var img = canvas.toDataURL("image/png");
				var aLink = document.createElement('a');
				window.open(img);
			},
			setDrawUserLine: function(flg){
				if(flg){
					pen.startDrawUserLine();
				}else{
					pen.stopDrawUserLine();
				}
				this.enableDrawUserLine = flg;
			}
		},
		mounted: function(){
			this.drawMap();
			pen = TT.appendDrawLine("canvasRoute", document.getElementById('stationLayer'));
			this.setDrawUserLine(this.enableDrawUserLine);
			if(TT.open_stationInfoWindow){
				setTimeout(function(){
				TT.map.popStation('tra_' + TT.open_stationInfoWindow);
				TT.open_stationInfoWindow = false;
				},1000);
			}
		}
	})
	return vm;
}

TT.drawDiagram = function(railAry, timeAry, comp, caID){
	var rt = '';
	var canvas = document.getElementById(caID),
		cc = canvas.getContext('2d'),
		r = TT.rail;
	var rowHeight = 100, per600secWidth = 120, timeStartLeft = 100, timeEndRight = 100, rowOffTop = 50, rowOffEnd = 50, kmHeight = 30;
	var secMoveX = per600secWidth/600;
	var timeObj = (function(){
		var stm = 900000, etm = 0;
		timeAry.map(function(c){
			if(c.registerTime < stm) stm = c.registerTime;
			if(c.offlineTime > etm) etm = c.offlineTime;
		})
		var drawStartHour = parseInt(TT.fn.transSec2Time(stm).split(':')[0]);
		var drawEndHour = parseInt(TT.fn.transSec2Time(etm).split(':')[0])+1;
		return { startTime: stm, endTime: etm , totalTime: etm-stm, drawStartHour:drawStartHour, drawEndHour: drawEndHour, totalHour: drawEndHour - drawStartHour};
	})();
	var kmObj = (function(){
		var firstStation = 0, lastStation = 0, min = 0, max = 0, aryDrawKM = [];
		railAry.map(function(c,idx){
			if(idx==0){
				firstStation = c.km;
				min = c.km;
				max = c.km;
			}
			lastStation = c.km;
			if(c.km > max) max = c.km;
			if(c.km < min) min = c.km;
			aryDrawKM[c.id] = c.km;
		});
		if(firstStation > lastStation){
			for(var k in aryDrawKM){
				//aryDrawKM[k] = max - aryDrawKM[k];
			}
		}
		return {firstStation:firstStation, lastStation:lastStation, min:min, max:max, aryDrawKM:aryDrawKM}
	})();
	var caWidth = timeStartLeft + (timeObj.totalHour * 6 * per600secWidth) + timeEndRight,
		caHeight = rowOffTop + (kmObj.max*kmHeight) + rowOffEnd;;//caHeight = rowOffTop + (railAry.length*rowHeight) + rowOffEnd;
	
	canvas.width = caWidth; canvas.height = caHeight; canvas.className = 'diagram';//canvas.style.backgroundColor = '#FFF';
	cc.clearRect(0, 0, canvas.width, canvas.height);
	var stationDrawTop = [];
	
	//寫時間
	var aryTCol = [];
	for(var i=timeObj.drawStartHour ; i<=timeObj.drawEndHour; i++){
		for(var j=0; j<6; j++){
			aryTCol.push(i*3600 + j*600);
		}
	}
	var baseStartTime = aryTCol[0];
	aryTCol.map(function(c,idx){
		var timX = idx*per600secWidth + timeStartLeft;
		cc.font = '16px Arial'; cc.fillStyle = '#1a1a1a';
		cc.fillText(TT.fn.transTime2HM(c), timX - 20, rowOffTop - 20);
		cc.fillText(TT.fn.transTime2HM(c), timX - 20, caHeight - 10);
		cc.beginPath();
		cc.moveTo(timX, rowOffTop);
		cc.fillStyle = '#DDD'; cc.strokeStyle = '#DDD'; cc.setLineDash([10]);
		if(c % 1800==0){ cc.fillStyle = '#666'; cc.strokeStyle = '#666'; cc.setLineDash([15,5]);};
		cc.lineTo(timX, caHeight - rowOffTop);
		cc.stroke();
	});
	var getMoveX = function(time){
		return Math.ceil((time-baseStartTime) * secMoveX + timeStartLeft);
	}
	//寫站名
	for(var i=0; i<railAry.length; i++){
		cc.font = '16px Arial'; cc.fillStyle = '#1a1a1a';
		var stationTop = kmObj.aryDrawKM[railAry[i].id] * kmHeight + rowOffTop;//stationTop = i*rowHeight + rowOffTop
		cc.fillText(railAry[i].name, 10, stationTop);
		for(var j=1; j<timeObj.totalHour; j++){
			cc.fillText(railAry[i].name, j*(per600secWidth*6), stationTop);
		}
		cc.beginPath();
		cc.moveTo(timeStartLeft, stationTop);
		cc.fillStyle = '#DDD'; cc.strokeStyle = '#DDD'; cc.setLineDash([10]);
		cc.lineTo(caWidth, stationTop);
		cc.stroke();
		stationDrawTop[railAry[i].id] = stationTop;
	}
	//畫列車線
	var tmpA = false, tmpB = false, tmpD = false, tmpCY = false, tmpCX1 = false, tmpCX2 = false;
	cc.setLineDash([]);
	for(var i=0; i<timeAry.length; i++){
		tmpA = timeAry[i];
		tmpB = TT.fn.getCarByTrainType(tmpA.trainType);
		cc.fillStyle = tmpB.color; cc.strokeStyle = tmpB.color;
		cc.beginPath();
		cc.moveTo(getMoveX(tmpA.timeAry[0].arr), stationDrawTop[tmpA.timeAry[0].stid]);
		for(var j=0; j<tmpA.timeAry.length; j++){
			tmpD = tmpA.timeAry[j];
			tmpCX1 = getMoveX(tmpD.arr);
			tmpCX2 = getMoveX(tmpD.dep);
			tmpCY = stationDrawTop[tmpD.stid];
			if(tmpCX1==tmpCX2 && !tmpD.pass){
				tmpCX1--;
				tmpCX2++;
			}
			cc.lineTo(tmpCX1, tmpCY);
			cc.lineTo(tmpCX2, tmpCY);
		}
		cc.stroke();
		cc.fillText(tmpB.name, tmpCX1 - 10, tmpCY + 20);
	}
	
	TT.appendDrawLine(canvas, document.getElementById(caID + '_out'), document.getElementById(caID + '_pen'));//測試 Draw Line
	return rt;
}

TT.createTimeTableArea = function(cfg){
	cfg = cfg || {};
	cfg.elID = cfg.elID || '#timeTableArea';
	cfg.editor = cfg.editor || false;
	var calcTimeTable = function(tmpTime){
		var h4Table = [[],[],[],[]],
			stAry = [[],[],[],[]];
		tmpTime.map(function(c){
			if(c.line=='k'){
				if(c.dir==1){
					h4Table[2].push(c);
					stAry[2] = TT.getRailAry('k', 'tra_1001', 'tra_1006', 1, true);
				}else{
					h4Table[3].push(c);
					stAry[3] = TT.getRailAry('k', 'tra_1006', 'tra_1001', 0, true);
				}
			}else{
				if(c.dir==1){
					h4Table[0].push(c);
					stAry[0] = TT.getRailAry('w', 'tra_1001', 'tra_1008', 1, true);
				}else{
					h4Table[1].push(c);
					stAry[1] = TT.getRailAry('w', 'tra_1008', 'tra_1001', 0, true);
				}
			}
		});
		return {
			h4Table: h4Table,
			stAry: stAry
		}
	}
	var tkm = calcTimeTable(TT.makeAllRouteTimeTable(7));
	var h4Table = tkm.h4Table,
		stAry = tkm.stAry;
	
	var tpl = Vue.compile('<div class="timeTableOut" id="' + cfg.elID + '" v-bind:class="(getCompOutClass())" v-show="seen">' +
		'<div class="btnSwitchArea">' +
			'<div class="btnSwitchTable bgTRA" v-on:click="(switchTable(\'t1\'))">台鐵火車 (基隆往台北)</div>' +
			'<div class="btnSwitchTable bgTRA" v-on:click="(switchTable(\'t0\'))">台鐵火車 (台北往基隆)</div>' +
			'<div class="btnSwitchTable bgKLRT" v-on:click="(switchTable(\'k1\'))">基隆輕軌 (基隆往南港)</div>' +
			'<div class="btnSwitchTable bgKLRT" v-on:click="(switchTable(\'k0\'))">基隆輕軌 (南港往基隆)</div>' +
			'<div class="btnSwitchTable " v-on:click="drawDiagram" style="background-color:#5c2c5e;">運行圖</div>' +
			'<div class="btnSwitchTable " v-on:click="drawDiagram(2)" style="background-color:#2c6c8e;">雙向</div>' +
		'</div>' +
		'<div class="timeTableIn">' +
			'<table cellpadding="0" cellspacing="0">' +
				'<tr>' +
					'<th></th>' +
					'<th v-for="(ta,aidx) in timeAry" v-bind:style="getCarColorStyle(ta.trainType)">{{getCarName(ta.trainType)}}</th>' +
				'</tr>' +
				'<tr>' +
					'<td>行駛區間</td>' +
					'<td v-for="(tb,bidx) in timeAry">{{tb.tag}}</td>' +
				'</tr>' +
				'<tr v-for="(st,idx) in railAry" v-bind:class="idx%2==1 ? \'row2\' : \'\'">' +
					'<td>{{st.name}}</td>' +
					'<td v-for="(tc,cidx) in timeAry" v-bind:style="getCarColorStyle(tc.trainType)" v-html="getStationTIme(st,tc,cidx)"></td>' +
				'</tr>' +
			'</table>' +
		'</div>' +
	'</div>');
	var vm = new Vue({
		el: cfg.elID,
		render: tpl.render,
		staticRenderFns: tpl.staticRenderFns,
		data: {
			seen: true,
			comp: 'tra',
			callIndex: 0,
			railAry: stAry[0],
			timeAry: h4Table[0]
		},
		methods: {
			switchTable: function(s){
				this.comp = (/k/.test(s)) ? 'klrt' : 'tra';
				switch(s){
					case 0:
					case 't1':
						this.callIndex = 0;
					break;
					case 1:
					case 't0':
						this.railAry = stAry[1];
						this.callIndex = 1;
					break;
					case 2:
					case 'k1':
						this.callIndex = 2;
					break;
					case 3:
					case 'k0':
						this.callIndex = 3;
					break;
				}
				this.railAry = stAry[this.callIndex];
				this.timeAry = h4Table[this.callIndex];
			},
			updateTimeTableRawData: function(ary){
				ary = ary || TT.makeAllRouteTimeTable(TT.startHour, TT.runHour);
				var tkm = calcTimeTable(ary);
				h4Table = tkm.h4Table;
				stAry = tkm.stAry;
				
				this.switchTable('t1');
			},
			drawDiagram: function(nf){
				var tm = this.timeAry, caID = 'canvas_diagram';
				var ins = '<canvas id="' + caID + '"></canvas>' +
					'<div id="' + caID + '_pen" style="position:absolute;top:0px;left:0px;display:inline-block;z-index:10;"></div>';
				TT.popupArea.pop('<div style="position:relative;display:inline-block;" id="' + caID + '_out">' + ins + '</div>', true);
				if(nf==2){
				var aryA = JSON.parse(JSON.stringify(h4Table));
				var aryB = (this.callIndex<=1) ? aryA[0].concat(aryA[1]) : aryA[2].concat(aryA[3])
					TT.drawDiagram(this.railAry, aryB, this.comp, caID);
				}else{
					TT.drawDiagram(this.railAry, this.timeAry, this.comp, caID);
				}
			},
			getCarColorStyle: function(t){
				var color = TT.fn.getCarByTrainType(t).color;
				return 'color:' + color + ';';
			},
			getCarName: function(t){
				return TT.fn.getCarByTrainType(t).name;
			},
			getCompOutClass: function(){
				return (this.comp=='tra') ? 'tra' : 'klrt';
			},
			getStationTIme: function(st, tc, idx){
				var stid = st.id;
				var tmpTime = false, rt = '';
				for(var i=0; i<tc.timeAry.length; i++){
					if(tc.timeAry[i].stid==stid){
						tmpTime = tc.timeAry[i];
						break;
					}
				}
				if(tmpTime){
					rt = TT.fn.transTime2HM(tmpTime.dep);
					if(tmpTime.pass){
						//rt = '--';
						rt = '--' + '<span class="passTrainTime">' + TT.fn.transTime2HM(tmpTime.dep) + '</span>';
					}else if(tmpTime.wait){
						rt = '<div>' + TT.fn.transTime2HM(tmpTime.arr)+ '到</div>' + '<div>' + TT.fn.transTime2HM(tmpTime.dep) + '開</div>';
					}else if(stid=='tra_1008'){
						if(tc.dir==1){
							rt = '<div>' + TT.fn.transTime2HM(tmpTime.arr)+ '到</div>' + '<div>' + TT.fn.transTime2HM(tmpTime.dep) + '開</div>';
						}
					}
				}
				return rt;
			}
		}
	});
	return vm;
}


TT.createSetPage = function(){
	var myID = 'setPage';
	var ti1 = 0, ti2 = 0;
	var tpl = Vue.compile('<div class="setPage" id="' + myID + '" v-show="seen">' +
		'<div style="display:inline-block;"><textarea class="jsonText" v-model="jsonText"></textarea><textarea class="paramText" readonly="TRUE" v-model="paramText"></textarea></div>' +
		'<div class="createBtnArea">' +
			'<div class="setItem" v-on:click="previewTable()">{{ (flagShowPreviewTable) ? \'切回說明\' : \'開啟預覽\' }}</div>' +
			'<div class="setItem" v-on:click="copyURL()" v-if="flagUseBrowserCopy" v-show="!flagShowPreviewTable">複製網址</div>' +
			'<div class="setItem" v-on:click="setToTrainModule()">產生新的定型化時刻表運行列車</div>' +
			'<div class="sucMsg" v-show="flagShowMsg" v-bind:class="getSucMsgCls()">{{ msgText }}</div>' +
		'</div>' +
		'<div><textarea id="setPage_textURL" class="textURL" v-model="textURL" v-show="!flagShowPreviewTable"></textarea></div>' +
		'<div class="helpText" v-html="getHelp()" v-show="!flagShowPreviewTable" v-on:click="clickHelp"></div>' +
	'</div>');
	var vm = new Vue({
		el: '#setPage',
		render: tpl.render,
		staticRenderFns: tpl.staticRenderFns,
		data: {
			seen: false,
			jsonText: '',
			paramText: '',
			textURL: '',
			msgText: '',
			flagUseBrowserCopy: TT.flagUseBrowserCopyCheck,
			flagShowPreviewTable: false,
			flagShowMsg: false,
			flagLinerByeMsg: false,
			flagCreateURL: false
		},
		methods: {
			updateText: function(){
				this.clearText();
				this.jsonText = TT.fn.getData2JSON();
				this.paramText = (function(){
					var obj = {
						station: TT.station,
						line: TT.line,
						car: TT.car						
					}
					var a = JSON.stringify(obj, undefined, '  ');
					a = a.replace(/\n\s{8}/gi,'').replace(/\n\s{6}\]/gi,']');
					return a;
				})();
			},
			copyURL: function(){
				var clipArea = document.getElementById('setPage_textURL');
				clipArea.select();
				document.execCommand('copy');
				this.showMsgText('複製執行完成');
			},
			clearText: function(){
				this.jsonText = '';
				this.textURL = '';
				this.paramText = '';
			},
			clickHelp: function(e){
				var dom = e.target;
				var act = (dom.dataset.act) ? dom.dataset.act : false;
				if(act && TT.teachImp[act]){
					TT.teachImp[act]();
					return true;
				}
			},
			getSucMsgCls: function(){
				return (this.flagLinerByeMsg) ? 'bye' : '';
			},
			getHelp: function(){
				var ks = '', ts = '';
				TT.car.map(function(c){
					ks += '<li><span style="color:#4E8C9D;">' + c.trainType + ':</span> ' + c.name + '</li>';
				});
				TT.station.map(function(c){
					ts += '<li><span style="color:#4E8C9D;">' + c.id + ':</span> ' + c.name + '</li>';
				});
				return '<div style="max-width:1200px;">' + 
				'<h3><span style="color:red">程式說明</span></h3>' +
				'<p>' +
					//'<span style="color:blue;cursor:pointer;" onclick="TT.openNews()">緣由</span> | '+
					'<span style="color:blue;cursor:pointer;" data-act="showProgramStep">運算流程</span> | '+
					//'<span style="color:blue;cursor:pointer;" data-act="showClassTrain">列車物件原始碼</span> | '+
					//'<span style="color:blue;cursor:pointer;" data-act="showSimReg">註冊列車啟動模擬</span> | '+
					'<span style="color:blue;cursor:pointer;" data-act="showPeopleThink">程式的缺點和應用面</span> | '+
					'<span style="color:blue;cursor:pointer;" data-act="showDemoLink">各種展示模式</span> | '+
				'</p>' +
				'<h3><span style="color:red">操作說明</span></h3>' +
				'<p>可直接在編輯器上以 JSON 格式修改，或複製到電腦上的編輯器修改完再貼回來測試。產生新的定型化時刻表運行列車會更新程式運行表並產生一組網址，複製網址即可分享給其他人，進入網頁後將會以編輯後的時刻表為預設時刻表。開啟預覽時每次產生時刻表均會在下方即時運算更新，以每小時產生的一輪班次為計算基礎。 </p>' +
				'<h3><span style="color:red">編輯格式說明</span></h3>' +
				'<p>目前可編輯的項目分成兩塊，第一塊為 trainGoTime，第二塊為 trainModuleTime </p>' +
				'<h4><span style="color:green"> trainGoTime 格式說明</span></h4>' +
				'<p>它的格式相對簡單，只有一組兩個元素的陣列，分別是 [車種 , 發車時刻]。車種的部分由第二部分的 trainModuleTime 定義，請在陣列 0 填入該車種的 mod 值；發車時刻的部分請填入每小時的第幾分鐘由第一站發車，第一站是固定而相對於 trainModuleTime 中的 from 值。' +
				'要注意的是發車時間會與 time 值的第一個元素做比對，假設一個 time 陣列是 time:[20,24,26....] 的型式，填入 20 那列車時刻會使用 20,24,26... 運行；若填入 50 則列車時刻會用 50,54,56... 運行。</p>' +
				'<h4><span style="color:green"> trainModuleTime 格式說明</span></h4>' +
				'<p>trainModuleTime 為陣列，用於定義行駛在所有軌道上的列車型態以及定型化班表的運轉時間，可設定內容如下</p>' +
				'<ul>' +
					'<li>mod: 模組名稱，不能重複，習慣命名法為 trainType_number</li>' +
					'<li>trainType: 車種，目前有以下幾種可用' +
						'<ul>' + ks + '<br>' + '</ul>' +
					'</li>' +
					'<li style="color:#6CAF45;">line: 西部幹線列車請填 w，東部幹線列車請填 e，基隆輕軌請填 k，此值會影響月台的停靠位置。</li>' +
					'<li>dir: 行車方向，由台北或南港往基隆方向順行北上為 0，由基隆往南港台北方向逆行南下為 1</li>' +
					'<li>from: 起站，請填入車站代號。</li>' +
					'<li style="">to: 終點站，請填入車站代號。' + '<ul>' + ts + '<br>' + '</ul>' + '</li>' +
					'<li style="color:#BC8F45;">tag: 顯示於按下列車的說明視窗中顯示的文字</li>' +
					'<li>time: 陣列，為起站至終站間經過的每一站停靠時間。台鐵或基隆輕軌未停靠的車站不用輸入，只需輸入軌道上經過的每一站，有以下幾種輸入法' +
						'<ul>' +
							'<li>純數字，例如 34，代表 34 分到達此站載客後開車。</li>' +
							'<li>文字，不停靠直接通過請輸入 p 及通過時間，例如 p25 代表 25 分時通過該站</li>' +
							'<li>文字，要在車站待避請輸入 w 連接進站及出站時間，例如 23w27 代表 23 分進車站直到 27 分才出站。可待避車站目前只有規劃松山、南港、汐止及七堵四站會進入待避月台</li>' +
							'<li>文字，若有車站停靠時間要比較久則輸入 ~ 連接進站及出站時間，例如 9~11 會從 9 分進站停到 11 分才開車，所有車站皆可用</li>' +
						'</ul>' +
				'</ul>' +
				'<div>';
			},
			previewTable: function(){
				this.flagShowPreviewTable = !this.flagShowPreviewTable;
			},
			showMsgText: function(tx, sec1, sec2){
				var me = this;
				sec1 = sec1 || 2000;
				sec2 = sec2 || 2000;
				this.msgText = tx;
				this.flagLinerByeMsg = false;
				this.flagShowMsg = true;
				ti1 = setTimeout(function(){
					me.flagLinerByeMsg = true;
					ti2 = setTimeout(function(){
						me.flagShowMsg = false;
						me.flagLinerByeMsg = false;
					},sec1);
				},sec2);
			},
			setToTrainModule: function(){
				this.textURL = '';
				TT.editTimeTableByPeople = true;
				var gi = TT.fn.setData2trainRawData(this.jsonText);
				clearTimeout(ti1);clearTimeout(ti2);
				var tx = (gi) ? '已更新完成，可按複製網址儲存結果' : '更新失敗，請檢查輸入格式是否有錯，例如字串未用雙引號包住或陣列內最後多了 , 而視為未完成';
				this.showMsgText(tx, 2000, (gi)?2000:6000);
				//Make url
				var val = TT.parseModule.getURL();
				this.textURL = val;
				if(this.flagShowPreviewTable){
					var cIdx = TT.timeTableArea.callIndex;
					var tmpTimeTable = TT.makeAllRouteTimeTable(TT.startHour);
					TT.timeTableArea.updateTimeTableRawData(tmpTimeTable);
					TT.timeTableArea.switchTable(cIdx);
				}
			}
		},
		watch: {
			seen: function(){
				if(this.seen==true){
					this.updateText();
				}
			},
			flagShowPreviewTable: function(){
				TT.timeTableArea.seen = this.flagShowPreviewTable;
			}
		}
	})
	return vm;
}

TT.initFn = function(){
	TT.parseModule.updateCarData();
	TT.processFirst(true);
	var body = document.body;
	TT.menuBar = TT.createMenuBar();
	TT.timeArea = TT.createTimeArea();
	TT.map = TT.createMap();
	TT.timeTableArea = TT.createTimeTableArea();
	document.getElementById('helpArea').innerHTML = TT.descriptionText.join('<br>');
	
	TT.setPage = TT.createSetPage();
	
	document.addEventListener('touchmove', function(e){
		TT.isMobileMove = true;
	});
	TT.popupArea = TT.popupArea();
}
</script>
<!-- -->
<!-- -->
</head>
<body onload="TT.initFn()">
	<div id="menuBarRenderDiv"></div>
	<div id="timeShowArea"></div>
	<div id="mapShowArea"></div>
	<div id="setPage"></div>
	<div id="timeTableArea"></div>
	<div id="helpArea" class="helpArea"></div>
	<div id="popupArea" class="popupArea" style="display:none;"><div id="popupIn" class="popupIn"></div><div class="close" onclick="TT.popupArea.close()">X</div></div>
</body>
</html>
