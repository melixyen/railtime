
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="zh-TW" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width; initial-scale=1.0" />
<meta name="description" content="列車行駛模式群組化系統" />
<meta name="keywords" content="台鐵,火車,鐵路,時刻表,轉乘,TRA,Timetable,Taiwan Railway,接軌時刻" />
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<title>接軌時刻 - 列車行駛模式群組化系統</title>
<style type="text/css">
@charset "utf-8";

body {
    /*font-family:'細明體', "PMingLiU";*/
    font-size: 14px;
    margin: 0px;
}

.headerBar{
    position: fixed;
    height: 40px;
    max-height: 40px;
    overflow: hidden;
    top: 0px;
    left: 0px;
    width: 100%;
    line-height: 28px;
    background-color: #FFF;
}
.headerButton, .headerButton2{
    display: inline;
    margin: 3px 6px;
    border: 2px solid #22CCEF;
    background-color: #4BE9F2;
    color: #5E5E5E;
    text-align: center;
    cursor: pointer;
    border-radius: 4px;
    overflow: hidden;
}
.headerButton2{
    border: 2px solid #a2a912;
    background-color: #dbc932;
}
@supports (display: flex) {
    .headerBar{
        display: -webkit-flex;
        display: flex;
    }
    .headerButton{
        -webkit-flex: 1;
        flex: 1;
    }
}

.statusBar{
    position: fixed;
    height: 20px;
    bottom: 0px;
    left: 0px;
    width: 100%;
    background-color: #DDD;
    padding-left: 20px;
    color: #5E3B70;
    line-height: 18px;
    font-size: 12px;
}

.center{
    border: 2px solid #4EBCD5;
    margin: 40px 10px 20px;
    overflow: auto;
}

.centerPage{
    margin: 3px;
    display: none;
    padding-top: 15px;
}
.centerPage.show{
    display: block;
}
.centerPage .selectStationOut{background-color: #E2FAE4;}
.centerPage .selectWeekOut, .centerPage .selectTimeOut{background-color: #FAFAE2;}
.centerPage .selectStationOut .selectStationIn,  .centerPage .findButtonDiv,
.centerPage .selectWeekOut .selectWeekIn,
.centerPage .selectTimeOut .selectTimeIn{
    padding: 5px;
}

.centerPage .selectTimeOut .selectTimeIn .setNow{
    display: inline-block;
    font-size: 12px;
    margin: 0 5px;
    border-radius: 10px;
    border: 2px solid #7CE;
    background-color: #8EF;
    color: #357;
    padding: 0px 8px;
    cursor: pointer;
}

.help_selectStationByLine,
.centerPage .selectStationOut .selectStationIn .selectStationByLine,
.centerPage .selectStationOut .selectStationIn .selectStationExchange{
    display: inline-block;
    border: 2px solid #1A2;
    border-radius: 10px;
    background-color: #2E3;
    color: #131;
    padding: 0px 8px;
    cursor: pointer;
    margin-left: 5px;
}
.centerPage .selectStationOut .selectStationIn .selectStationExchange{
    border: 2px solid #7CE;
    background-color: #8EF;
    color: #357;
}
.centerPage .inputStation{
    display: inline-block;
    width: 120px;
    margin: 0 10px;
}
#ttc_stationSelect_start, #ttc_stationSelect_end{
    background-color: #EEF;
}

.center .frameA{
    border: 1px solid #2E9CB5;
    margin: 10px auto;
    max-width: 1600px;
    padding: 3px;
}
.center .frameA .title{
    font-weight: bold;
    font-size: 16px;
    color: #444;
    margin: 3px;
}

.center .frameB{
    border: 1px solid #4E9CD5;
    margin: 10px auto;
    padding: 3px;
}

.center .ttbDisplay{
    border: 1px solid #4E8CE5;
    margin: 10px auto;
    max-width: 1600px;
}

.center .ttbDisplay .route{
    background-color: #FCF9FD;
    border-bottom: 1px solid #4A4C55;
    margin: 0px;
    width: 100%;
}
.center .ttbDisplay .train{
    background-color: #FEFEFE;
    margin: 0px;
    min-height: 200px;
    width: 100%;
}

.center .preSetting{
    border-bottom: 1px solid #2C2C2C;
    margin-bottom: 5px;
    padding-bottom: 5px;
}

.inputListStation{
    position: absolute;
    background-color: #FDFDFD;
    border: 1px solid #CACACA;
    top: 0px;
    left: 0px;
    cursor: pointer;
}
.inputListStation .name{
    padding: 5px 10px;
    font-size: 13px;
    color: #2D4DFF;
}
.inputListStation .name:hover{
    background-color: #DFD;
}

.define_rail_bgcolor_tra_xibu, .define_rail_bgcolor_tra_shan, .define_rail_bgcolor_tra_zhjy, .define_rail_bgcolor_tra_jygx, .define_rail_bgcolor_tra_pingdong, .define_rail_bgcolor_tra_yilan, .define_rail_bgcolor_tra_beihui,
.define_rail_bgcolor_tra_pingxi, .define_rail_bgcolor_tra_liujia, .define_rail_bgcolor_tra_huadong, .define_rail_bgcolor_tra_shalun, .define_rail_bgcolor_tra_hai, .define_rail_bgcolor_tra_jiji,
.define_rail_bgcolor_tymetro_1,
.define_rail_bgcolor_trtc_2, .define_rail_bgcolor_trtc_3, .define_rail_bgcolor_trtc_4, .define_rail_bgcolor_trtc_5{
    color: #EEF !important;
}
.define_rail_bgcolor_tra_xibu{
    background-color: #000050 !important;
}
.define_rail_bgcolor_tra_shan{
    background-color: #104020 !important;
}
.define_rail_bgcolor_tra_zhjy{
    background-color: #707010 !important;
}
.define_rail_bgcolor_tra_jygx{
    background-color: #302040 !important;
}
.define_rail_bgcolor_tra_pingdong{
    background-color: #7D3810 !important;
}
.define_rail_bgcolor_tra_yilan{
    background-color: #500000 !important;
}
.define_rail_bgcolor_tra_beihui{
    background-color: #004060 !important;
}
.define_rail_bgcolor_tra_huadong{
    background-color: #605040 !important;
}
.define_rail_bgcolor_tra_hai{
    background-color: #2050C0 !important;
}
.define_rail_bgcolor_tra_pingxi{
    background-color: #003030 !important;
}
.define_rail_bgcolor_tra_liujia{
    background-color: #403090 !important;
}
.define_rail_bgcolor_tra_jiji{
    background-color: #22A050 !important;
}
.define_rail_bgcolor_tra_shalun{
    background-color: #124060 !important;
}
.define_rail_bgcolor_tymetro_1{
    background-color: #8e47ad !important;
}
.define_rail_bgcolor_trtc_2{
    background-color: #cb2c30 !important;
}
.define_rail_bgcolor_trtc_3{
    background-color: #007749 !important;
}
.define_rail_bgcolor_trtc_4{
    background-color: #ffa300 !important;
    color: #555 !important;
}
.define_rail_bgcolor_trtc_5{
    background-color: #005eb8 !important;
}


@keyframes ccblink{
    0%{color: #F0FE46;}
    40%{color: #A0FE66;}
    70%{color: #80FE86;}
    100%{color: #A0FE66;}
}


@media screen and (max-width: 579px) {
    .timeTableTrainRouteBox .table .info, .timeTableTrainRouteBox .table .line, .timeTableTrainRouteBox .table .other{
        display: none;
    }
}
@media screen and (min-width: 580px) and (max-width: 779px) {
    .timeTableTrainRouteBox .table .line, .timeTableTrainRouteBox .table .other{
        display: none;
    }
}
@media screen and (min-width: 780px) and (max-width: 909px) {
    .timeTableTrainRouteBox .table .other{
        display: none;
    }
}
@media screen and (min-width: 910px) {
    .timeTableTrainRouteBox .timeRouteDiv .more{
        display: none;
    }
}

.ckWeekLoaded{
    background-color: #FF0000;
    color: #FFF;
    display: inline;
    padding: 0 10px;
}

.defineFontStyle1{
    color: #302010;
    font-weight: 500;
    background-color: #D0C0F0;
}

.mask{
    display: none;
    position: fixed;
    width: 100%;
    height: 100%;
    top: 0px;
    left: 0px;
    background-color: rgba(210,210,210,0.6);
    text-align: center;
    z-index: 105;
    -webkit-align-items: center;
    align-items: center;
    -webkit-justify-content: center;
    justify-content: center;
}
.mask .text{
    position: relative;
    font-size: 24px;
    color: #EF7879;
}
.mask.show{
    display: -webkit-flex;
    display: flex;
}
.systemButton{
    cursor: pointer;
    border: 2px solid #999;
    background-color: #DDD;
    min-height: 30px;
    line-height: 26px;
    padding: 2px 12px;
    display: inline;
    margin: 0px 5px;
}

.ttWindow{
    display: inline-block;
    padding: 20px;
    background-color: #3F9EED;
    border: 2px solid #948522;
    position: absolute;
    top: 0px;
    height: 0px;
    max-width: 95%;
    max-height: calc(100% - 50px);
}
.ttWindow .inner{
    background-color: #F2F2F2;
    min-width: 160px;
    min-height: 100px;
    display: inline-block;
    max-width: 100%;
    max-height: 90vh;
    overflow: auto;
}
.ttWindow .ttWindowClose, .ttMapSelector .ttWindowClose{
    width: 16px;
    height: 16px;
    line-height: 16px;
    font-size: 16px;
    font-weight: bold;
    color: #4D5F5F;
    position: absolute;
    right: 0px;
    top: 2px;
    cursor: pointer;
}

.ttMapSelector{
    display: inline-block;
    background-color: #FFF;
    background-color: rgba(255,255,255,1);
    border: none;
    position: absolute;
    top: 0px;
    left: 0px;
    min-height: 500px;
    overflow: hidden;
}
.ttMapSelector .main{
    position: relative;
    left: 0px;
}
.ttMapSelector .header{
    position: relative;
    left: 0px;
    height: 30px;
    max-height: 30px;
    overflow: hidden;
}
.ttMapSelector .header .tabName{
    float: left;
    padding: 2px 5px;
    border: 2px solid #FC98DA;
    height: 20px;
    font-size: 16px;
    color: #3D6A7B;
    line-height: 20px;
    background-color: #FDB8EC;
    cursor: pointer;
}
.ttMapSelector .header .tabName.onUse{
    border: 2px solid #98FCDA;
    color: #6A3D7B;
    background-color: #B8FDEC;
    border-bottom-color: #FFF;
    border-top-color: #28AC3A;
}
.line_selector{
    position: relative;
}
.line_selector .allLine{
    color: #FFF;
    font-size: 110%;
    width: 300px;
    max-width: 300px;
    float: left;
    left: 20px;
    top: 10px;
    overflow: hidden;
    cursor: pointer;
}
.line_selector .allLine .lineName{
    height: 24px;
    line-height: 22px;
    border-top: 0px solid transparent;
    padding-left: 10px;
}
.line_selector .allLine .lineName.select{
    border-right: 0px solid transparent;
}
.line_selector .allStation{
    color: #FFF;
    font-size: 110%;
    width: 210px;
    text-align: center;
    max-width: 210px;
    float: left;
    left: 320px;
    top: 10px;
    overflow: hidden;
    cursor: pointer;
}
.line_selector .allStation .stationName{
    border-bottom: 1px solid #FFF;
    height: 24px;
    line-height: 22px;
    margin: 0px 30px;
}
.line_selector .allStation .stationName:hover{
    background-color: rgba(255,255,255,0.4);
}
@media (-webkit-min-device-pixel-ratio: 1.25), (min-resolution: 120dpi){ 
    .line_selector .allLine, .line_selector .allStation{
        font-size: 130%;
    }
    .line_selector .allStation .stationName, .line_selector .allLine .lineName{
        height: 40px;
        line-height: 38px;
    }
}
@media (-webkit-min-device-pixel-ratio: 1.5), (min-resolution: 144dpi){ 
    .line_selector .allLine, .line_selector .allStation{
        font-size: 160%;
    }
    .line_selector .allStation .stationName, .line_selector .allLine .lineName{
        height: 50px;
        line-height: 48px;
    }
}

/* Group Station Check Div */
.groupStationDiv{
    background-color: #EFB1EA;
    padding: 10px;
    display: inline-block;
}

.groupStationDiv .modeFunction{
    float: left;
    padding: 5px;
    border:1px solid #444;
    border-radius:5px;
    cursor: pointer;
    margin-right: 10px;
}
.groupStationDiv .big1{
    background-color: #EDE8F3;
    display: inline-block;
    width: 100%
}
.groupStationDiv .big2{
    background-color: #E8F2F3;
    display: inline-block;
    width: 100%
}
.groupStationDiv .customGoupStation{
	background-color: #C8D2F3;
    display: inline-block;
    width: 100%
}
.groupStationDiv .stationBtn{
    float: left;
    margin: 5px 10px;
    border: 1px solid #A55;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 14px;
    cursor: pointer;
}
.groupStationDiv .stationBtn.checked{
    background-color: #EBB;
}

#tt_timeTable_d_route .routeBox{
    margin: 5px 10px;
}
#tt_timeTable_d_route .routeBtn{
    display: inline-block;
    margin: 5px 10px;
    border: 1px solid #55A;
    border-radius: 4px;
    padding: 4px 8px;
    font-size: 14px;
    cursor: pointer;
}
#tt_timeTable_d_route .routeBtn.checked{
    background-color: #BBE;
}
#tt_timeTable_d_route .routeBtn .lineBox{
    padding: 3px 6px;
    display: inline;
}

/* Group Search Result */
.resultTable{
    margin: 4px 8px;
    border-spacing: 0px 2px;
}
.resultTable tr.bigStation{
    background-color: #F3F3F3;
}
.resultTable tr.bigStation td.stationName{
    font-weight: 700;
}
.resultTable td{
    padding: 2px 10px;
}
.resultTable td.head{
    margin: 3px 6px;
    cursor: pointer;
}

.trainTimeTable{
	margin-right: 20px;
}
.trainTimeTable td{
	padding: 7px;
	min-width: 50px;
}


/* All common CSS */
.tt_display_none{display: none;}
</style>
<!--<link rel="stylesheet" type="text/css" href="x.css" />-->

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
<script type="text/javascript" src="ttlib/defined.js"></script>
<script type="text/javascript" src="ttlib/data.js"></script>
<script type="text/javascript" src="ttlib/fn.js"></script>
<script type="text/javascript" src="ttlib/fn_tymetro.js"></script>
<script type="text/javascript">

var TT = (function(){

    var TT = $trainTaiwanLib;
    TT.stationGroupAry = ["tra_1008", "tra_1011", "tra_1015", "tra_1017", "tra_1025", "tra_1319", "tra_1120", "tra_1215", "tra_1228", "tra_1238","tra_1305","tra_1210","tra_1406","tra_1411","tra_1820","tra_1823","tra_1715","tra_1619","tra_1632","tra_1019","tra_1032","tra_1016"];
    TT.minGroupCount = 1;
    
    TT.defined.programAbout = {
            "程式名稱": "列車行駛模式群組化系統",
            "作者": "Melix Yen (melixyen@gmail.com)",//修改後請將自己的名稱以 , 分隔加在前人後面，可帶括號標誌匿名或電子郵件等其他資訊，例如 test (test@abc.com)
            '發行單位': '<span style="background-color: #BBB;"><span style="color:blue;">極</span><span style="color:#FEFE11;">光</span><span style="color:#005530;">駭</span><span style="color:red;">客</span></span>',
            "版本": "Beta 0.1.2",
            "產生日期": "2018/12/11"
    };
    TT.defined.programUpdateInfo = [
                    'Beta 0.1.2: 新增製圖功能。',
                    'Beta 0.1.1: 新增路由選擇。',
                    'Beta 0.1: 新增車站選擇器。'
    ];
    
    
    
    function groupTrain(aryTime, from, to, cfg){
        cfg = cfg || {};
        var a = TT.fn.getTRA_stationID(from), b = TT.fn.getTRA_stationID(to);
        var aryGroupTag = {}, aryList = [], stStepFlag = 0;//{id: 'tra_1001,tra_1002...', list: [trainInfo]}
        var idName = '', collsName = '', aryStations = [], rangeAryStations = [], rte = false;
        var filterTrainNumber = ['1','2'];
        var anyStopStation = [];
        aryTime.map(function(tr){
            if(filterTrainNumber.indexOf(tr.Train)!=-1) return false;
            collsName = ''; aryStations = []; rangeAryStations = []; stStepFlag = 0;
            aryStations = tr.TimeInfo.map(function(ts, idx, arr){
                rte = '';
                if(stStepFlag===0){
                    if(ts.Station == a){
                        stStepFlag = 1;
                        tr.sortTime = TT.fn.transTime2Sec(ts.DepTime);
                    }
                }
                
                if(stStepFlag==1){
                    rangeAryStations.push('tra_' + ts.Station);
                    rte = 'tra_' + ts.Station;
                    
                    if(ts.Station == b) stStepFlag = 2;
                }
                return rte;
            });
            tr.rangeAryStations = rangeAryStations;
            aryStations = aryStations.filter(function(c){
                return c != '';
            });
            //如果有大站模式，只歸類大站
            if(TT.stationGroupAry.length > 0){
                aryStations = aryStations.filter(function(c){
                    return !!(TT.stationGroupAry.indexOf(c) != -1);
                });
            }
            idName = aryStations.join(',');
            if(idName=='') idName = 'none';
            collsName = 't' + aryStations.join(',');
            if(aryGroupTag[collsName] || aryGroupTag[collsName]===0){
                var mList = aryList[aryGroupTag[collsName]];
                rangeAryStations.forEach(function(c){
                    mList.stationStopCount[c] = (mList.stationStopCount[c]) ? mList.stationStopCount[c] + 1 : 1;
                    if(anyStopStation.indexOf(c)==-1) anyStopStation.push(c);
                });
                mList.trainNumber.push(tr.Train);
                mList.classCount['c' + tr.CarClass] = (mList.classCount['c' + tr.CarClass]) ? mList.classCount['c' + tr.CarClass] + 1 : 1;
                mList.list.push(tr);
            }else{
                aryList.push({
                    id: idName,
                    stationStopCount: {},
                    trainNumber: [],
                    classCount: {},
                    list: [tr]
                });
                var mList = aryList[aryList.length -1];
                rangeAryStations.forEach(function(c){
                    mList.stationStopCount[c] = (mList.stationStopCount[c]) ? mList.stationStopCount[c] + 1 : 1;
                    if(anyStopStation.indexOf(c)==-1) anyStopStation.push(c);
                });
                mList.trainNumber.push(tr.Train);
                mList.classCount['c' + tr.CarClass] = (mList.classCount['c' + tr.CarClass]) ? mList.classCount['c' + tr.CarClass] + 1 : 1;
                aryGroupTag[collsName] = aryList.length -1;
            }
        });
        aryList.anyStopStation = anyStopStation;
        aryList.forEach(function(tm){
        	tm.stationStopAry = Object.keys(tm.stationStopCount);
        	var classAry = Object.keys(tm.classCount).map(function(c){
        		return {
					id: c,
        			cnt: tm.classCount[c]
        		}
        	});
        	classAry.sort(function(a,b){ return (a.cnt < b.cnt) ? 1 : -1;});
        	tm.classCountAry = classAry;
        	tm.classObj = getTrainClass(classAry[0].id);
        });
        return aryList;
    }
    
    function getLinkRoute(from, to){
        var aryA = TT.fn.getTRA_linkMap(from, to);
        aryA = aryA.map(function(routeA){
            routeA.displayRoute = routeA.allBig;
            if(routeA.displayRoute.length < 2) routeA.displayRoute = routeA.allStation;
            routeA.lineAry = routeA.map(function(m){
                return m.line;
            });
            return routeA;
        });
        return aryA;
    }
    
    function getTrainClass(val){
    		val = val.replace('c','');
            var data = TT.data.tra.defined["CarClass"], rt = '';
            for(var i=0; i<data.length; i++){
                if(data[i].id==val){
                    return data[i];
                }
            }
    }
    
    function makeRouteSelectDiv(elID){
            var tpl = Vue.compile('<div class="route" id="' + elID + '" >' +
                '<div class="routeBox">' +
                    '<div v-for="(rr,aidx) in aryRoute" class="routeBtn bs_no_select" v-bind:class="ckCls(aidx)" v-on:click="toggleRoute(aidx)" v-html="getName(rr)"></div>' +
                '</div>' +
	        '</div>');
            var vm = new Vue({
    		    el: '#' + elID,
    		    render: tpl.render,
    		    staticRenderFns: tpl.staticRenderFns,
    		    data: {
                    flagGo: false,
                    selIndex: 0,
                    aryRoute: []
                },
                methods: {
                    ckCls: function(st){
                        return (this.selIndex==st) ? ' checked' : '';
                    },
                    getName: function(rr){
                        var routeS = rr.lineAry.map(function(c){
                            var colorSt = 'define_rail_bgcolor_' + c;
                            return '<div class="lineBox ' + colorSt + '">' + TT.fn.getCommon_lineData(c).name + '</div>';
                        });
                        var div2 = '<div style="display:inline; padding-left: 10px;">' + rr.displayRoute.map(function(c){return TT.fn.getTRA_stationDataOfID(c).name}).join(' - ') + '</div>';
                        return routeS.join('') + div2;
                        
                    },
                    toggleRoute: function(st){
                        this.selIndex = st;
                        TT.ui.printTrain();
                    }
                },
                watch: {
                    selIndex: function(){
                        
                    }
                },
                mounted: function(){
                
                }
            });
            return vm;
    }
    
    TT.ui = TT.lib.apply(TT.ui, {
        centerScroll: function(val, isDirect){
            var sysTop;
            if(val || val===0){
                if(isDirect){
                    $(TT.ui.centerDiv).scrollTop(val);
                }else{
                    $(TT.ui.centerDiv).animate({ scrollTop: val }, 400);
                }
            }
            sysTop = document.body.scrollTop;
            return sysTop;
        },
        createBaseDiv: function(){
            TT.ui.maskDiv = TT.ui.createDiv('tt_mask', 'mask', 'body');
            TT.ui.maskText = TT.ui.createDiv('tt_mask_text', 'text', 'tt_mask');
            TT.ui.maskText.innerHTML = 'Loading...';
            
            TT.ui.centerDiv = TT.ui.createDiv('tt_center', 'center', 'body');
            TT.ui.center = {};
        },
        createHome: function(){
            TT.ui.center.home = TT.ui.createDiv('tt_home', 'centerPage home', TT.ui.centerDiv.id);
            
            //HELP Frame
            TT.ui.center.home.help = TT.ui.createDiv('tt_home_help', 'frameA help', TT.ui.center.home.id);
            var helpDiv = TT.ui.center.home.help;
            helpDiv.divTitle = TT.ui.createDiv(helpDiv.id + '_title', 'title', helpDiv.id);
            helpDiv.divTitle.innerHTML = '說明';
            helpDiv.divText1 = TT.ui.createDiv(helpDiv.id + '_text1', 'text', helpDiv.id);
            helpDiv.divText1.innerHTML = '<p>' + '本程式可選擇一組起迄站，將兩站間的所有班車列出來，選定要分析的停靠站後依照停靠站的不同將列車停靠模式自動帶出。' + '</p>' +
                '<p>' + '有關搜尋出結果之簡單說明如下' + '</p>' +
                '<ul>' +
                    '<li><b>起迄站原則：</b>選擇的起迄站代表分析器會抓取所有直通這兩站的列車，任何未停靠或只停靠其中一站的列車都不會被加入，因此像分析基隆到中壢時最好選七堵到中壢。</li>' +
                    '<li><b>起迄站技巧：</b>起迄站選擇絕對大站如台北、高雄、花蓮可分析最多列車，選擇台中時將不會有海線列車，起迄站選擇太遠時可能不會有區間車等短途列車。</li>' +
                    '<li><b>模式化選站基礎：</b>請至少選擇起站、迄站及兩站間的任何一站非全停站，才能有效鑑別與分類行車模式。</li>' +
                    '<li><b>選站原則：</b>任何被選擇的車站都會被列入分析獨立的停靠模式，例如選擇了浮洲站或汐科站，因為它只停區間車，所以所有的區間車會被獨立出來。</li>' +
                    '<li><b>選站技巧：</b>若沒有選擇小站，則小站會被併入停靠站數最多的行駛模式中作為選擇性停靠站標記；若沒有選擇大站，則難有列車停靠模式鑑別度。</li>' +
                    '<li><b>選站清空：</b>不選擇任何車站，代表所有列車都為獨立模式，只整合所有停靠站相同的列車為同一模式。</li>' +
                    '<li><b>路由切換：</b>若起迄站間可能需要顯示兩種以上路由時，可透過路由切換搜尋結果左側顯示的停靠站名稱。</li>' +
                    '<li>&nbsp;</li>' +
                    '<li><b>時刻表依據：</b>同 [接軌時刻] App 之時刻表資料來源，由台鐵提供之公開時刻表 JSON 檔擷取其中七天作為一星期的時刻表選項。</li>' +
                    '<li><b>顯示結果的車種：</b>車種顯示以相同模式中最多類型的 CarClass 作代表，不見得完全都是該車種。</li>' +
                '</ul>' +
                '<p>' + '支援台鐵的幹線為主，海線只有選擇起迄站在相鄰路段時會顯示，其餘以山線為主。目前無法查詢南迴線車站，因尚未處理南迴線路由，也無法顯示南迴線車站。' + '</p>' +
                '<p>使用 DEMO 按鈕時，將會自動選取兩站之間建議的模式群組化原則依據車站做參考，您仍可以按車站修改。請注意，沒有放在歸屬大站列表中的車站將全部顯示於其他車站列表中，按下 [+] 可開啟更多車站選擇。</p>';
            //HELP Frame
            TT.ui.center.home.update = TT.ui.createDiv('tt_home_update', 'frameA update', TT.ui.center.home.id);
            var updateDiv = TT.ui.center.home.update;
            updateDiv.divTitle = TT.ui.createDiv(updateDiv.id + '_title', 'title', updateDiv.id);
            updateDiv.divTitle.innerHTML = '更新';
            updateDiv.divText1 = TT.ui.createDiv(updateDiv.id + '_text1', 'text', updateDiv.id);
            updateDiv.divText1.innerHTML = '' +
                '<div style="height: 80px; overflow-y:scroll; overflow-x:hidden;"><ul>' +
                (function(){ return '<li>' + TT.defined.programUpdateInfo.join('</li><li>') + '</li>'; })() +
                '</ul><div>';
            //Program Frame
            TT.ui.center.home.prog = TT.ui.createDiv('tt_home_prog', 'frameA prog', TT.ui.center.home.id);
            TT.ui.center.home.prog.divTitle = TT.ui.createDiv('tt_home_prog_title', 'title', TT.ui.center.home.prog.id);
            TT.ui.center.home.prog.divTitle.innerHTML = '列車行駛模式群組化原則系統';
            TT.ui.center.home.prog.divText1 = TT.ui.createDiv('tt_home_prog_text1', 'text', TT.ui.center.home.prog.id);
            TT.ui.center.home.prog.divText1.innerHTML = '<p>列車行駛模式群組化原則系統是用來研究特定路線、區段、列車運行模式的輔助工具。</p>' +
                '<p>關於' +
                    (function(){
                        var rt = '';
                        for(var k in TT.defined.programAbout){
                            rt += '<li>' + k + ': ' + TT.defined.programAbout[k] + '</li>';
                        }
                        return '<ul>' + rt + '</ul>';
                    })() +
                '</p>' +
                '<p></p>' +
            '';
            
        },
        createTimeTable: function(){
            if(TT.ui.center.timeTable){
                TT.ui.center.timeTable.innerHTML = '';
            }else{
                TT.ui.center.timeTable = TT.ui.createDiv('tt_timeTable', 'centerPage timeTable', TT.ui.centerDiv.id);
            }
            var localDataFn = TT.fn.localData;
            
            //Control Frame
            TT.ui.center.timeTable.controlDiv = TT.ui.createDiv('tt_timeTable_control', 'frameA control', TT.ui.center.timeTable.id);
            TT.ui.center.timeTable.controlDiv.stationSelectDiv = TT.ui.createTakeStation({id: 'ttc_stationSelect', renderID: 'tt_timeTable_control'});
            //TT.ui.center.timeTable.controlDiv.timeSelectDiv = TT.ui.createTakeTimeSelect({id: 'ttc_timeSelect', renderID: 'tt_timeTable_control'});
            TT.ui.center.timeTable.controlDiv.weekSelectDiv = TT.ui.createWeekSelect({id: 'ttc_weekSelect', renderID: 'tt_timeTable_control'});
            TT.ui.center.timeTable.controlDiv.groupStationSelectDiv = TT.ui.createGroupStationSelect({id: 'ttc_groupStationSelect', renderID: 'tt_timeTable_control'});
            TT.ui.center.timeTable.controlDiv.depArrDiv = TT.ui.createTakeTimeFindDepArr({id: 'ttc_ADSelect', renderID: 'tt_timeTable_control'});
            TT.ui.center.timeTable.controlDiv.findButtonDiv = TT.ui.createTakeFindButton({id: 'ttc_findButton', renderID: 'tt_timeTable_control'});
            //Set default param
            var defaultFromStation = (localDataFn.getItem('defaultFromStation')) ? localDataFn.getItem('defaultFromStation') : 'tra_1008',
                defaultToStation = (localDataFn.getItem('defaultToStation')) ? localDataFn.getItem('defaultToStation') : 'tra_1238',
                defaultSearchDay = new Date().getDay(),
                defaultStartTime = (localDataFn.getItem('defaultStartTime')) ? localDataFn.getItem('defaultStartTime') : '07:00',
                defaultEndTime = (localDataFn.getItem('defaultEndTime')) ? localDataFn.getItem('defaultEndTime') : '09:00';
            //Use Get param
            var GetP = TT.defined.GetP;
            if(GetP){
                if(GetP['a']) defaultFromStation = GetP['a'];
                if(GetP['b']) defaultToStation = GetP['b'];
                if(GetP['w']) defaultSearchDay = GetP['w'];
                if(GetP['startTime']) defaultStartTime = decodeURIComponent(GetP['startTime']);
                if(GetP['endTime']) defaultEndTime = decodeURIComponent(GetP['endTime']);
            }
            TT.ui.center.timeTable.controlDiv.stationSelectDiv.fnSetStart(defaultFromStation);
            TT.ui.center.timeTable.controlDiv.stationSelectDiv.fnSetEnd(defaultToStation);
            //TT.ui.center.timeTable.controlDiv.timeSelectDiv.fnSetStartTime(defaultStartTime);
            //TT.ui.center.timeTable.controlDiv.timeSelectDiv.fnSetEndTime(defaultEndTime);
            TT.ui.center.timeTable.controlDiv.weekSelectDiv.fnSetDay(defaultSearchDay);
            
            //Display Frame
            TT.ui.center.timeTable.displayDiv = TT.ui.createDiv('tt_timeTable_display', 'ttbDisplay', TT.ui.center.timeTable.id);
            TT.ui.center.timeTable.displayDiv.routeDiv = TT.ui.createDiv('tt_timeTable_d_route', 'route', TT.ui.center.timeTable.displayDiv.id);
            TT.ui.center.timeTable.displayDiv.trainDiv = TT.ui.createDiv('tt_timeTable_d_train', 'train', TT.ui.center.timeTable.displayDiv.id);
            
            //Vue create div
            TT.ui.center.timeTable.displayDiv.routeDiv = makeRouteSelectDiv(TT.ui.center.timeTable.displayDiv.routeDiv.id);
            
        },
        createHeader: function(){
            var dom = document.createElement('div');
            dom.id = 'tt_headerBar';
            document.body.appendChild(dom);
            dom.className = 'headerBar';
            
            TT.ui.buttonHome = TT.ui.createHeaderButton({id: 'tt_hdBtn_home', text: '說明', clickFn: function(e){TT.ui.setCenterActive('home');}});
            TT.ui.buttonTimeTable = TT.ui.createHeaderButton({id: 'tt_hdBtn_timeTable', text: '停靠站整理', clickFn: function(e){TT.ui.setCenterActive('timeTable');}});
            TT.ui.buttonBack = TT.ui.createHeaderButton({id: 'tt_hdBtn_back', text: '返回接軌時刻', clickFn: function(e){location.href = './'}});
            TT.ui.buttonBackTop = TT.ui.createHeaderButton({id: 'tt_hdBtn_backTop', text: '回到頂端', cls: 'headerButton2', clickFn: function(e){TT.ui.centerScroll(0);TT.ui.bodyScroll(0);}});
            
            dom.appendChild(TT.ui.buttonHome);
            dom.appendChild(TT.ui.buttonTimeTable);
            dom.appendChild(TT.ui.buttonBack);
            dom.appendChild(TT.ui.buttonBackTop);
        },
        createButton: function(cfg){
            //cfg = id, text, cls(class), clickFn
            if(!cfg.cls){cfg.cls = ' systemButton';}
            var div = document.createElement('div');
            div.className = cfg.cls;
            div.id = cfg.id;
            div.innerHTML = '<span>' + cfg.text + '</span>';
            div.addEventListener('click', cfg.clickFn);
            if(cfg.appendT){
                if(cfg.appendT == 'body'){
                    document.body.appendChild(dom);
                }else{
                    document.getElementById(cfg.appendT).appendChild(div);
                }
            }
            return div;
        },
        createSystemButton: function(cfg){
            if(!cfg.cls){cfg.cls = '';}
            cfg.cls = cfg.cls + ' systemButton';
            return TT.ui.createButton(cfg);
        },
        createHeaderButton: function(cfg){
            if(!cfg.cls){cfg.cls = '';}
            cfg.cls = cfg.cls + ' headerButton';
            return TT.ui.createButton(cfg);
        },
        createStatus: function(){
            var dom = document.createElement('div');
            dom.id = 'tt_statusBar';
            document.body.appendChild(dom);
            dom.className = 'statusBar';
            TT.ui.statusBar = dom;
        },
        createTakeFindButton: function(cfg){
            cfg = cfg || {};
            if(!cfg.id) cfg.id = TT.ui.genRandomId();
            if(!cfg.text) cfg.text = '尋找';
            if(!cfg.cls) cfg.cls = '';
            if(!cfg.btnCls) cfg.btnCls = '';
            if(!cfg.clickFn){
                cfg.clickFn = function(){
                    TT.ui.findBeforeTrain();
                }
            }
            
            var btn = document.createElement('button');
            btn.id = cfg.id;
            btn.className = cfg.btnCls + ' findButton';
            btn.innerHTML = cfg.text;
            btn.addEventListener('click', cfg.clickFn);
            
            var btnMakeImg = document.createElement('button');
            btnMakeImg.className = cfg.btnCls + ' makeButton';
            btnMakeImg.innerHTML = '製圖';
            btnMakeImg.addEventListener('click', TT.ui.trainToSVG);
            
            var div = document.createElement('div');
            div.className = cfg.cls + ' findButtonDiv';
            div.id = cfg.id+'_div';
            
            div.appendChild(btn);
            div.appendChild(btnMakeImg);
            
            if(cfg.renderID && cfg.renderID!=''){document.getElementById(cfg.renderID).appendChild(div);}
            return div;
        },
        createMapSelector: function(){
            if(TT.ui.mapSelector) return false;
            var cfg = {}, afterSelectCbFn, win;
            var astObj = TT.fn.getCommon_allTrainStation();
            var astLine = {};
            cfg.autoScroll = false;//(TT.os.isAndroidBrowser) ? false : true;
            astObj.allAry.map(function(objA){
                var line = (objA.byLine);
                if(!astLine[line]) astLine[line] = new Array();
                astLine[line].push(objA);
            });
            
            var divLine = (function(){
                var div = document.createElement('div');
                div.className = 'line_selector';
                var allHTML, htLine = '', tmpST, htStation = ''; 
                for(var k in astLine){
                    htLine += '<div class="lineName ' + TT.defined.railBgcolor + k + '" clickOnLine="1" lineID="' + k + '">' + TT.fn.getCommon_lineName(k) + '</div>';
                    tmpST = '';
                    astLine[k].map(function(sta){
                        tmpST += '<div class="stationName ' + 'mmm'+TT.defined.railBgcolor + k + '" clickOnStation="1" stationID="' + sta.id + '">' + TT.fn.getCommon_stationDataOfID(sta.id).name + '</div>';
                    });
                    htStation += '<div style="display:none;" class="stationGroup ' + k + ' ' + TT.defined.railBgcolor + k + '" lineID="' + k + '">' + tmpST + '</div>';
                }
                htLine = '<div class="allLine">' + htLine +'</div>';
                htStation = '<div class="allStation">' + htStation +'</div>';
                allHTML = htLine + htStation;
                div.innerHTML = allHTML;
                div.headerText = '使用路線列表選擇車站';
                
                div.addEventListener('click', function(e){
                    var t = e.target;
                    if(t.attributes.getNamedItem('clickOnLine')){
                        var id = t.attributes.getNamedItem('lineID').value;
                        $('.line_selector .allLine .lineName').each(function(idx,dom){
                            dom.className = dom.className.replace(' select','');
                        });
                        $('.line_selector .allStation .stationGroup').hide();
                        $('.line_selector .allStation .stationGroup.' + id).show();
                        t.className = t.className + ' select';
                    }else if(t.attributes.getNamedItem('clickOnStation')){
                        var id = t.attributes.getNamedItem('stationID').value;
                        if(afterSelectCbFn){
                            afterSelectCbFn(id);
                        }
                        win.close();
                        TT.ui.msg.show(TT.fn.getCommon_stationDataOfID(id).name,600);
                    }
                }, false);
                return div;
            })();
            var divLineAfterFn = function(){
            
            }
            
            
            var divNet = (function(){
                var div = document.createElement('div');
                div.className = 'line_selector';
                div.headerText = '使用路網圖選擇車站';
                return div;
            })();
            
            cfg.items = [divLine, divNet];
            cfg.onShow = function(wwin, wcfg, scfg){
                //scfg from call show take parameter
                scfg = scfg || {};
                afterSelectCbFn = scfg.afterSelectCbFn;
                win = wwin;
                if(TT.lib.canvasMap && !TT.ui.mapSelector.canvasMap){
                    var canvasMap = new TT.lib.canvasMap({
                        drawPlanLine: true,
                        drawPlanLineOriginalColor: false
                        //,baseWidth: 1550, baseHeight: 2350
                    });
                    canvasMap.initAll();
                    divNet.style.width = canvasMap.cfg.baseWidth + 'px';
                    divNet.style.height = canvasMap.cfg.baseHeight + 'px';
                    divNet.appendChild(canvasMap.div);
                    TT.ui.mapSelector.canvasMap = canvasMap;
                }
            }
            TT.ui.mapSelector = new TT.lib.classMapSelector(cfg);
            TT.ui.mapSelector.el.addEventListener('click', function(e){
                var me = TT.ui.mapSelector;
                var t = e.target;
                if(t.className.indexOf('canvasTWRMapButton')!=-1){
                    if(me.itemActiveString==divNet.headerText){
                        var id = t.className.split('caTWRMap_')[1];
                        if(afterSelectCbFn){
                            afterSelectCbFn(id);
                        }
                        win.close();
                        TT.ui.msg.show(TT.fn.getCommon_stationDataOfID(id).name,600);
                    }else{
                        me.itemSwitch(divNet.headerText);
                    }
                }
                if(t.className.indexOf('canvasTWRMapClickDiv')!=-1){
                    me.itemSwitch(divNet.headerText);
                }
            }, false);
        },
        createTakeStation: function(cfg){
            cfg = cfg || {};
            if(!cfg.id) cfg.id = TT.ui.genRandomId();
            
            var astObj = TT.fn.getCommon_allTrainStation();
            var traAry = astObj.traAry, trtcAry = astObj.trtcAry, allAry = astObj.allAry;
            
            if(!TT.ui.mapSelector) TT.ui.createMapSelector();
            
            if(!cfg.fieldText) cfg.fieldText = '';
            if(!cfg.fieldStartText) cfg.fieldStartText = '出發站:';
            if(!cfg.fieldEndText) cfg.fieldEndText = '到達站:';
            var div = document.createElement('div');
            div.id = cfg.id;
            
            var optSt = (function(){
                var company, cmpStr = '', lineC, rt='';
                for(var i=0; i<allAry.length; i++){
                    company = TT.fn.getCompanyOfStation(allAry[i].id);
                    //lineC = (allAry[i].byLine) ? 'background-color:' + TT.fn.getCommon_lineColor(allAry[i].byLine) + ';' : '';
                    cmpStr = '(' + company.toUpperCase() + ')';
                    rt += '<option value="' + allAry[i].id + '" class="' + TT.defined.railBgcolor + allAry[i].byLine + '">' + allAry[i].name + cmpStr + '</option>';
                }
                return rt;
            })();
            
            var fieldTextDiv = (cfg.fieldText=='') ? '' : '<div id="' + div.id + '_fieldText">' + '<span>' + cfg.fieldText + '</span>' + '</div>';
            div.innerHTML = fieldTextDiv +
            '<div class="selectStationOut">' +
                '<div class="selectStationIn" id="' + cfg.id + '_fromin">' +
                    '<span>' + cfg.fieldStartText + '</span>' +
                    '<span><select id="' + cfg.id + '_start">' + optSt + '</select></span>' +
                    '<div class="selectStationByLine sta_from">' + '選擇車站' + '</div>' +
                    '<input type="text" class="inputStation" id="' + cfg.id + '_inputFrom" placeholder="' + '搜尋站名(拼音可)' + '" />' +
                    '<div class="selectStationExchange">' + '起訖點對調' + '</div>' +
                '</div>' +
                '<div class="selectStationIn" id="' + cfg.id + '_toin">' +
                    '<span>' + cfg.fieldEndText + '</span>' +
                    '<span><select id="' + cfg.id + '_end">' + optSt + '</select></span>' +
                    '<div class="selectStationByLine sta_to">' + '選擇車站' + '</div>' +
                    '<input type="text" class="inputStation" id="' + cfg.id + '_inputTo" placeholder="' + '搜尋站名(拼音可)' + '" />' +
                '</div>' +
            '</div>';
            
            if(cfg.renderID && cfg.renderID!=''){document.getElementById(cfg.renderID).appendChild(div);}
            
            div.addEventListener('click', function(e){
                var t = e.target, scfg = {};
                if(t.className.indexOf('selectStationByLine') != -1){
                    if(/sta_from/.test(t.className)){
                        scfg.afterSelectCbFn = function(staID){
                            div.fnSetStart(staID);
                        }
                    }else if(/sta_to/.test(t.className)){
                        scfg.afterSelectCbFn = function(staID){
                            div.fnSetEnd(staID);
                        }
                    }
                    TT.ui.mapSelector.show(scfg);
                }else if(t.className.indexOf('selectStationExchange') != -1){
                    var tmpV = div.fnGetStart();
                    div.fnSetStart(div.fnGetEnd());
                    div.fnSetEnd(tmpV);
                }else if(t.className.indexOf('inputStation') != -1){
                    renderInputEvent(t);
                }
            }, false);
            
            div.fnGetStart = function(){
                return document.getElementById(cfg.id + '_start').value;
            }
            div.fnGetEnd = function(){
                return document.getElementById(cfg.id + '_end').value;
            }
            div.fnSetStart = function(val){
                return document.getElementById(cfg.id + '_start').value = val;
            }
            div.fnSetEnd = function(val){
                return document.getElementById(cfg.id + '_end').value = val;
            }
            
            var renderInputEvent = function(t){
                var dom, isFrom = false, isTo = false;
                if(t.id== cfg.id + '_inputFrom'){ isFrom = true; }else if(t.id== cfg.id + '_inputTo'){ isTo = true; }
                if(!isFrom && !isTo) return false;
                if(t.tt_isRenderKeyEvent) return false;
                t.tt_isRenderKeyEvent = (isFrom) ? 'from' : 'to';
                
                function clearInput(){
                    t.value = '';
                }
                
                function giveValue(val){
                        var tarID = (isFrom) ? cfg.id + '_start' : cfg.id + '_end';
                        document.getElementById(tarID).value = val;
                        listDiv.style.display = 'none';
                        clearInput();
                }
                
                var listDiv = document.createElement('div');
                listDiv.className = 'inputListStation';
                listDiv.id = t.id + '_list';
                listDiv.addEventListener('click', function(e){
                    if(e.target.className=='name'){
                        var stid = e.target.attributes.getNamedItem('stid').value;
                        giveValue(stid);
                    }
                });
                
                document.body.appendChild(listDiv);
                t.tt_listDiv = listDiv;
                
                t.addEventListener('keyup', function(e){
                    var t = e.target;
                    var val = t.value.replace(/\s/g,''), displayAry = new Array(), comp;
                    var pos = $('#' + t.id).position();
                    if(t.oldValue && t.oldValue==val && e.keyCode!=13) return false;
                    t.oldValue = val;
                    var allStAry = TT.fn.findStationByString(val);
                    if(!allStAry) return false;
                    allStAry.map(function(st){
                        if(st.noShow) return false;
                        comp = TT.defined.stringSimpleOfCompany[TT.fn.getCompanyOfStation(st.id)];
                        comp = (comp) ? ' (' + comp + ')' : '';
                        displayAry.push({
                            value: st.id,
                            text: st.name + comp
                        });
                    });
                    
                    if(e.keyCode==13 && displayAry[0]){
                        giveValue(displayAry[0].value);
                        return false;
                    }
                    t.tt_listDiv.style.left = pos.left + 'px';
                    t.tt_listDiv.style.top = (pos.top+22) + 'px';
                    t.tt_listDiv.style.display = '';
                    var ht = '';
                    for(var i=0; i<displayAry.length; i++){
                        ht += '<div class="name" stid="' + displayAry[i].value + '">' + displayAry[i].text + '</div>';
                        if(i>10) break;
                    };
                    t.tt_listDiv.innerHTML = ht;
                });
                
                t.addEventListener('blur', function(e){
                    var t = e.target;
                    setTimeout(function(){if(t.tt_listDiv) t.tt_listDiv.style.display = 'none';},500);
                });
            }
            
            return div;
            
        },
        createTakeTimeFindDepArr: function(cfg){
            cfg = cfg || {};
            if(!cfg.id) cfg.id = TT.ui.genRandomId();
            if(!cfg.flagAD) cfg.flagAD = true;//true=Dep, Default Dep
            if(!cfg.fieldText) cfg.fieldText = '';
            var div = document.createElement('div');
            div.id = cfg.id;
            
            var f0ck = (cfg.flagAD) ? '' : ' checked';
            var f1ck = (cfg.flagAD) ? ' checked' : '';
            
            var fieldTextDiv = (cfg.fieldText=='') ? '' : '<div id="' + div.id + '_fieldText">' + '<span>' + cfg.fieldText + '</span>' + '</div>';
            div.innerHTML = fieldTextDiv;
            
            div.fnGetValue = function(){
                return document.getElementById(cfg.id+'_1').checked;
            }
            
            if(cfg.renderID && cfg.renderID!=''){document.getElementById(cfg.renderID).appendChild(div);}
            
            return div;
        },
        createTakeTimeSelect: function(cfg){
            cfg = cfg || {};
            if(!cfg.id) cfg.id = TT.ui.genRandomId();
            if(!cfg.cls) cfg.cls = '';
            if(!cfg.fieldText) cfg.fieldText = '';
            if(!cfg.fieldStartText) cfg.fieldStartText = '從這個時間開始：';
            if(!cfg.fieldEndText) cfg.fieldEndText = '到這個時間為止：';
            var div = document.createElement('div');
            div.id = cfg.id;
            
            var hourOpt = (function(){
                var rt = '', tmp='';
                for(var i=0; i<24; i++){
                    tmp = TT.fn.transNum2StrA(i);
                    rt += '<option value="' + tmp + '">' + tmp + '</option>';
                }
                return rt;
            })();
            
            var minOpt = (function(){
                var rt = '', tmp='';
                for(var i=0; i<60; i+=5){
                    tmp = TT.fn.transNum2StrA(i);
                    rt += '<option value="' + tmp + '">' + tmp + '</option>';
                }
                return rt;
            })();
            
            var fieldTextDiv = (cfg.fieldText=='') ? '' : '<div id="' + div.id + '_fieldText">' + '<span>' + cfg.fieldText + '</span>' + '</div>';
            div.innerHTML = fieldTextDiv +
            '<div class="selectTimeOut">' +
                '<div class="selectTimeIn" id="' + cfg.id + '_startTimeDiv">' +
                    '<span>' + cfg.fieldStartText + '</span>' +
                    '<span><select id="' + cfg.id + '_startHour">' + hourOpt + '</select></span>' +
                    '<span>:</span>' + 
                    '<span><select id="' + cfg.id + '_startMin">' + minOpt + '</select></span>' +
                    '<span><div class="setNow">' + '設成現在' + '</div></span>' +
                '</div>' +
                '<div class="selectTimeIn" id="' + cfg.id + '_endTimeDiv">' +
                    '<span>' + cfg.fieldEndText + '</span>' +
                    '<span><select id="' + cfg.id + '_endHour">' + hourOpt + '</select></span>' +
                    '<span>:</span>' + 
                    '<span><select id="' + cfg.id + '_endMin">' + minOpt + '</select></span>' +
                '</div>' +
            '</div>';
            
            var sh = cfg.id + '_startHour', sm = cfg.id + '_startMin', eh = cfg.id + '_endHour', em = cfg.id + '_endMin';
            
            div.fnGetStartTime = function(){
                var h = document.getElementById(sh).value;
                var m = document.getElementById(sm).value;
                return h + ':' + m + ':00';
            }
            div.fnGetEndTime = function(){
                var h = document.getElementById(eh).value;
                var m = document.getElementById(em).value;
                return h + ':' + m + ':00';
            }
            div.fnSetStartTime = function(val){
                var aryA = val.split(':');
                document.getElementById(sh).value = aryA[0];
                document.getElementById(sm).value = aryA[1];
                return true;
            }
            div.fnSetEndTime = function(val){
                var aryA = val.split(':');
                document.getElementById(eh).value = aryA[0];
                document.getElementById(em).value = aryA[1];
                return true;
            }
            div.addEventListener('click', function(e){
                var t = e.target;
                if(t.className=='setNow'){
                    var nowT = new Date();
                    var h = nowT.getHours(), m = Math.ceil(nowT.getMinutes()/5)*5;
                    if(m==60){
                        h = (h==23) ? 0 : h+1;
                        m = 0;
                    }
                    var h2 = (h + 2) % 24;
                    var w = nowT.getDay();
                    h = h.toString();
                    h2 = h2.toString();
                    m = m.toString();
                    if(h.length==1) h = '0' + h;
                    if(h2.length==1) h2 = '0' + h2;
                    if(m.length==1) m = '0' + m;
                    div.fnSetStartTime(h + ':' + m);
                    div.fnSetEndTime(h2 + ':' + m);
                    TT.ui.center.timeTable.controlDiv.weekSelectDiv.fnSetDay(w);
                }
            }, false);
            
            if(cfg.renderID && cfg.renderID!=''){document.getElementById(cfg.renderID).appendChild(div);}
            
            return div;
        },
        createWeekSelect: function(cfg){
            cfg = cfg || {};
            if(!cfg.id) cfg.id = TT.ui.genRandomId();
            if(!cfg.cls) cfg.cls = '';
            if(!cfg.fieldText) cfg.fieldText = '星期幾的時刻表？';
            var div = document.createElement('div');
            div.id = cfg.id;
            
            var weekOpt = (function(){
                var rt = '', sty = '', weekStringAry = TT.defined.weekStringAry;
                for(var i=0; i<7; i++){
                    sty = (i==0) ? ' style="background-color:#FFAABC;"' : (i==6) ? ' style="background-color:#44DFAA;"' : ' style="background-color:#EEE;"'
                    rt += '<option value="' + i + '" ' + sty + '>' + weekStringAry[i] + '</option>';
                }
                return rt;
            })();
            
            div.innerHTML = '' +
            '<div class="selectWeekOut">' +
                '<div class="selectWeekIn" id="' + cfg.id + '_startTimeDiv">' +
                    '<span>' + cfg.fieldText + '</span>' +
                    '<span><select id="' + cfg.id + '_selector">' + weekOpt + '</select></span>' +
                '</div>' +
            '</div>';
            
            if(cfg.renderID && cfg.renderID!=''){document.getElementById(cfg.renderID).appendChild(div);}
            
            div.fnSetDay = function(val){
                val = val.toString();
                document.getElementById(cfg.id + '_selector').value = val;
                return val;
            }
            div.fnGetDay = function(){
                return document.getElementById(cfg.id + '_selector').value;
            }
            
            return div;
        
        },
        createGroupStationSelect: function(cfg){
            cfg = cfg || {};
            if(!cfg.id) cfg.id = TT.ui.genRandomId();
            if(!cfg.cls) cfg.cls = '';
            var div = document.createElement('div');
            div.id = cfg.id;
            if(cfg.renderID && cfg.renderID!=''){document.getElementById(cfg.renderID).appendChild(div);}
            var tmpSTS = '';
            var otherStations = TT.data.tra.station_ary.map(function(c){
            	tmpSTS = c.id;
            	return (TT.stationBigAll.indexOf(tmpSTS)==-1) ? tmpSTS : false;
            }).filter(function(c){
				return !!c;
			});
            

            var tpl = Vue.compile('<div class="' + 'groupStationDiv' + '" id="' + cfg.id + '" >' +
                '<div style="display: inline-block; margin: 5px;">' +
                    '<div style="float: left; margin-right: 20px;">針對以下車站做停靠模式差異分組，清空將以所有停靠站做群組歸納</div>' +
                    '<div class="modeFunction" v-on:click="clearSaveAry()">清空</div>' +
                    '<div class="modeFunction" v-on:click="makeGroup(1)">DEMO 七堵到新竹</div>' +
                    '<div class="modeFunction" v-on:click="makeGroup(2)">DEMO 台北到高雄</div>' +
                    '<div class="modeFunction" v-on:click="makeGroup(3)">DEMO 台北到花蓮</div>' +
                    '<div class="modeFunction" v-on:click="makeGroup(4)">DEMO 松山到台中</div>' +
                    '<div class="modeFunction" v-on:click="makeGroup(5)">DEMO 高雄到嘉義</div>' +
                    '<div class="modeFunction" v-on:click="makeGroup(6)">DEMO 彰化到新竹</div>' +
                    '<div class="modeFunction" v-on:click="makeGroup(7)">DEMO 基北線</div>' +
                '</div>' +
                '<div class="big1">' +
                    '<div style="float:left;margin:8px 0 0 6px;">第一級大站</div>' +
                    '<div v-for="(st1,aidx) in big1Ary" class="stationBtn bs_no_select" v-bind:class="ckCls(st1)" v-bind:style="getStationBtnStyle(st1)" v-on:click="toggleStation(st1)">{{getName(st1)}}</div>' +
                '</div>' +
                '<div class="big2">' +
                    '<div style="float:left;margin:8px 0 0 6px;">第二級大站</div>' +
                    '<div v-for="(st2,bidx) in big2Ary" class="stationBtn bs_no_select" v-bind:class="ckCls(st2)" v-bind:style="getStationBtnStyle(st2)" v-on:click="toggleStation(st2)">{{getName(st2)}}</div>' +
                '</div>' +
                '<div class="customGoupStation">' +
                    '<div style="float:left;margin:8px 0 0 6px;">其他車站</div>' +
                    '<div style="float:left;margin:8px 0 0 6px; color:blue; cursor:pointer;" v-on:click="toggleShowOtherStation">[ + ]</div>' +
                    '<div v-for="(st3,bidx) in otherStations" class="stationBtn bs_no_select" v-bind:class="ckCls(st3)" v-show="flagShowOtherStation" v-on:click="toggleStation(st3)">{{getName(st3)}}</div>' +
                '</div>' +
                '<div class="minGroupCountDiv">'+
                    '<span>模式化成形最少列次數：</span>' +
                    '<span><select v-model="minGroupCount">' +
                        '<option v-for="optline in groupNumbers" v-bind:value="optline">{{ optline }}</option>' +
                    '</select></span>' +
                '</div>' +
	        '</div>');
            var vm = new Vue({
    		    el: '#' + cfg.id,
    		    render: tpl.render,
    		    staticRenderFns: tpl.staticRenderFns,
    		    data: {
                    flagGo: false,
                    flagShowOtherStation: false,
                    minGroupCount: TT.minGroupCount,
                    groupNumbers: [1,2,3,4,5,6,7,8,9],
                    big1Ary: TT.stationBig1.slice(),
                    big2Ary: TT.stationBig2.slice(),
                    otherStations: otherStations,
                    saveAry: TT.stationGroupAry.slice()
                },
                methods: {
                    ckCls: function(st){
                        return (this.saveAry.indexOf(st)>=0) ? ' checked' : '';
                    },
                    clearSaveAry: function(){
                        this.saveAry = [];
                    },
                    getName: function(st){
                        return TT.fn.getTRA_stationDataOfID(st).name;
                    },
                    getStationBtnStyle: function(st){
                        
                        return '';
                    },
                    makeGroup: function(intM){
                        var selector = TT.ui.center.timeTable.controlDiv.stationSelectDiv;//.fnSetStart
                        switch(intM){
                            case 1:
                                selector.fnSetStart('tra_1003');selector.fnSetEnd('tra_1025');
                                this.saveAry = ["tra_1008", "tra_1011", "tra_1032", "tra_1015", "tra_1016", "tra_1017", "tra_1019", "tra_1025", "tra_1005"];
                                this.minGroupCount = 1;
                            break;
                            case 2:
                                selector.fnSetStart('tra_1008');selector.fnSetEnd('tra_1238');
                                this.saveAry = ["tra_1008", "tra_1011", "tra_1017", "tra_1305", "tra_1317", "tra_1319", "tra_1203", "tra_1028", "tra_1019"];
                                this.minGroupCount = 1;
                            break;
                            case 3:
                                selector.fnSetStart('tra_1008');selector.fnSetEnd('tra_1715');
                                this.saveAry = ["tra_1008", "tra_1804", "tra_1824", "tra_1816", "tra_1810", "tra_1820", "tra_1715"];
                                this.minGroupCount = 1;
                            break;
                            case 4:
                                selector.fnSetStart('tra_1007');selector.fnSetEnd('tra_1319');
                                this.saveAry = ["tra_1007", "tra_1120", "tra_1319", "tra_1032", "tra_1016", "tra_1019", "tra_1028", "tra_1017", "tra_1025"];
                                this.minGroupCount = 1;
                            break;
                            case 5:
                                selector.fnSetStart('tra_1238');selector.fnSetEnd('tra_1215');
                                this.saveAry = ["tra_1215", "tra_1238", "tra_1236", "tra_1233", "tra_1242", "tra_1225"];
                                this.minGroupCount = 1;
                            break;
                            case 6:
                                selector.fnSetStart('tra_1120');selector.fnSetEnd('tra_1025');
                                this.saveAry = ["tra_1305", "tra_1319", "tra_1317", "tra_1314", "tra_1120", "tra_1318", "tra_1028"];
                                this.minGroupCount = 1;
                            break;
                            case 7:
                                selector.fnSetStart('tra_1001');selector.fnSetEnd('tra_1008');
                                this.saveAry = [];
                                this.minGroupCount = 1;
                            break;
                        }
                        setTimeout(function(){TT.ui.findBeforeTrain();},500);
                    },
                    toggleShowOtherStation: function(){
                    	this.flagShowOtherStation = !this.flagShowOtherStation;
                    },
                    toggleStation: function(st){
                        if(this.saveAry.indexOf(st)==-1){
                            this.saveAry.push(st);
                        }else{
                            this.saveAry.splice(this.saveAry.indexOf(st),1);
                        }
                    }
                },
                watch: {
                    saveAry: function(){
                        TT.stationGroupAry = this.saveAry.slice();
                    },
                    minGroupCount: function(){
                        TT.minGroupCount = this.minGroupCount;
                    }
                },
                mounted: function(){
                
                }
            });
            return vm;
        },
        findBeforeTrain: function(cbFn){
            TT.ui.findTrain(cbFn);
        },
        findTrain: function(cbFn){
            var w = TT.ui.center.timeTable.controlDiv.weekSelectDiv.fnGetDay();
            var localDataFn = TT.fn.localData;
            function fnAfterCheck(){
                
                var controlDiv = TT.ui.center.timeTable.controlDiv;
                var a = controlDiv.stationSelectDiv.fnGetStart();
                var b = controlDiv.stationSelectDiv.fnGetEnd();
                //var w = controlDiv.weekSelectDiv.fnGetDay();
                if(!/^tra/.test(a) || !/^tra/.test(b)){
                    alert('目前只有台鐵車站可以被加入模式化歸類');
                    return false;
                }
                var aryTime = TT.fn.getTRA_allTimeByFromTo(a,b,w);
                var aryGPT = groupTrain(aryTime, a, b, {});
                var aryRoute = getLinkRoute(a, b);
                TT.now = {
                    allTrain: aryTime,
                    train: aryGPT,
                    route: aryRoute,
                    from: a,
                    to: b
                }
                
                //var aryRoute = TT.fn.getCommon_timeRangeBestByFromTo(a,b,startTime,endTime,flagAD,w);
                TT.ui.printStatus('整理列車模式完成');TT.msg.show('整理完成',200);
                TT.ui.printRoute();
                TT.ui.printTrain();
                
                
                localDataFn.setItem('defaultFromStation', a);
                localDataFn.setItem('defaultToStation', b);
                //rewrite url Get param
                var sObj = {
                    a: a,
                    b: b,
                    w: w
                }
                //var sParam = '?a=' + a + '&b=' + b + '&w=' + w + //'&findTrain=1' +
                     //'&startTime=' + encodeURIComponent(startTime) +
                     //'&endTime=' + encodeURIComponent(endTime);
                //if(window.history) history.pushState(sObj,'',sParam);
            }
            
            function fnCheck(){
                var a1 = TT.fn.checkTRA_dayTimeIsLoaded(w);
                if(!a1){
                    TT.fn.getTRA_TimeTable2Data(w, fnCheck);
                    return false;
                }
                //var a2 = TT.fn.checkTRTC_rnwTimeTableIsLoaded();
                //if(!a2){
                    //TT.fn.getTRTC_timeTable2Data(fnCheck);
                    //return false;
                //}
                //var a3 = TT.fn.tymetro.check_timeTableIsLoaded();
                //if(!a3){
                    //TT.fn.tymetro.get_timeTable2Data(fnCheck);
                    //return false;
                //}
                fnAfterCheck();
            }
            fnCheck();
        },
        getCenterPage: function(str){
            for(var k in TT.ui.center){
                if(TT.ui.center[k].id == 'tt_' + str){
                    return TT.ui.center[k];
                }
            }
            return false;
        },
        getCenterActive: function(){
            for(var k in TT.ui.center){
                if(TT.ui.center[k].className.indexOf('show')>=0){
                    return TT.ui.center[k];
                }
            }
            return false;
        },
        setCenterActive: function(str){
            for(var k in TT.ui.center){
                TT.ui.center[k].className = TT.ui.center[k].className.replace(' show','');
                if(TT.ui.center[k].id == 'tt_' + str){
                    var dom = TT.ui.center[k];
                    TT.ui.center[k].className = TT.ui.center[k].className + ' show';
                }
            }
            return dom;
        },
        mask: function(str){
            if(TT.ui.maskDiv.className.indexOf('show')<0){
                TT.ui.maskDiv.className = TT.ui.maskDiv.className + ' show';
            }
            if(str){
                TT.ui.maskText.innerHTML = str;
            }else{
                TT.ui.maskText.innerHTML = TT.defined.defaultMaskText;
            }
        },
        unmask: function(){
            TT.ui.maskDiv.className = TT.ui.maskDiv.className.replace(' show','');
        },
        msg: (function(){
            var rt = {};
            rt.show = function(str, delay){
                delay = (delay) ? delay : 3000;
                var div = TT.ui.createDiv('_gen', 'msg show', 'body');
                div.innerHTML = str;
                var divWidth = div.offsetWidth, divHeight = div.offsetHeight;
                var dw = TT.fn.getDocumentWidth(), dh = TT.fn.getDocumentHeight();
                div.style.top = (dh - divHeight) / 2 + 'px';
                div.style.left = (dw - divWidth) / 2 + 'px';
                var time1 = setTimeout(function(){
                    div.className += ' afterEffect';
                },delay);
                var time2 = setTimeout(function(){
                    document.body.removeChild(div);
                },delay+1000);
                div.addEventListener('click', function(e){
                    clearTimeout(time1);
                    clearTimeout(time2);
                    document.body.removeChild(div);
                }, false);
                return div;
            }
            rt.alert = function(st){
                alert(st);
            }
            
            return rt;
        })(),
        printStatus: function(str){
            TT.ui.statusBar.innerHTML = str;
        },
        printRoute: function(){
        
            TT.ui.center.timeTable.displayDiv.routeDiv.selIndex = 0;
            var tmpAF = JSON.parse(JSON.stringify(TT.now.route));
            tmpAF = tmpAF.map(function(rr,idx){
                rr.displayRoute = TT.now.route[idx].displayRoute;
                rr.lineAry = TT.now.route[idx].lineAry;
                return rr;
            });
            TT.ui.center.timeTable.displayDiv.routeDiv.aryRoute = tmpAF;
        },
        printTrain: function(){
            var controlDiv = TT.ui.center.timeTable.controlDiv;
            var a = controlDiv.stationSelectDiv.fnGetStart();
            var b = controlDiv.stationSelectDiv.fnGetEnd();
            var routeIndex = TT.ui.center.timeTable.displayDiv.routeDiv.selIndex;
            var allStation = TT.now.route[routeIndex].allStation;
            var stationOnUse = {};
            var anyStopStation = TT.now.train.anyStopStation;
            var allStopStation = [];
            var tmpA;
            allStation.forEach(function(c){
                tmpA = !(anyStopStation.indexOf(c)==-1);
                stationOnUse[c] = tmpA;
                if(tmpA) allStopStation.push(c);
            });
            //●▲◎⊙○〢●◎⊕⊙
            //Clear Old
            document.getElementById(TT.ui.center.timeTable.displayDiv.trainDiv.id).innerHTML = '';
            
            //整理需要顯示的車站
            var html = '';
            var train = TT.now.train;
            var storeMode = [], storeOther = [], storeNormal = [];
            train.forEach(function(c){
                c.stopList = c.id.split(',');
                if(c.id=='none') c.stopList = [];
                if(c.list.length >= TT.minGroupCount && c.stopList.length>0){
                    storeMode.push(c);
                }else{
                    storeOther.push(c);
                }
            });
            storeMode.sort(function(a , b){
                return (a.stationStopAry.length > b.stationStopAry.length) ? 1 : -1;
            });
            storeOther.sort(function(a , b){
                return (a.list.length > b.list.length) ? -1 : 1;
            });
            var modeNumber = TT.now.train.length + 2;
            var modeCount = 0;
            var tmpStr = '', tLen = 0, intA = 0;
            
            var displayHead = function(store){
                return store.map(function(c){
					modeCount++;
					var color = (c.classObj.color) ? c.classObj.color : '#47A';
					var cas = '<span style="color:' + color + ';" >' + c.classObj.name + '</span>';
                    var clickFn = ' onclick="TT.ui.clickTrainInfo(\'' + c.id + '\')"';
					return '<td class="head"' + clickFn + ' data-tid="' + c.id + '">' + '模式' + modeCount + '<div></div>' + cas + '<div></div>共' +c.trainNumber.length + '列</td>';
				}).join('');
            }
            var displayInside = function(store, st){
                return store.map(function(c){
                    //tmpStr = (c.stationStopCount[st]) ? c.stationStopCount[st] : '';
					var color = (c.classObj.color) ? c.classObj.color : '#47A';
					color = ' color:' + color + ';';
                    intA = (c.stationStopCount[st]) ? parseInt(c.stationStopCount[st]) : 0;
                    tLen = c.trainNumber.length;
                    var msdg = intA/tLen;
                    if(msdg == 1){
                        tmpStr = '<span style="font-size: 24px;' + color + '">●</span>';
                    }else if(msdg>0.8){
                        tmpStr = '<span style="font-size: 16px;' + color + '">▲</span><span style="' + color + '">(' + intA + ')</span>';
                    }else if(msdg>0.49){
                        tmpStr = '<span style="' + color + '">◎(' + intA + ')</span>';
                    }else if(msdg>0.3){
                        tmpStr = '<span style="' + color + '">⊙(' + intA + ')</span>';
                    }else if(msdg>0.001){
                        tmpStr = '<span style="font-size: 24px;' + color + '">○</span><span style="' + color + '">(' + intA + ')</span>';
                    }else{
                        tmpStr = '';
                    }
                    return '<td>' + tmpStr + '</td>';
                }).join('');
            }
            //var firstTR = '<tr><td></td><td>' + storeMode.map(function(c){return c.trainNumber.join('<br>');}).join('') + '</td><td>未分類區隔</td><td>' + storeOther.map(function(c){return c.trainNumber.join('<br>');}).join('') + '</td></tr>';
            var firstTR = '<tr><td></td>' +
                 displayHead(storeMode) +
                '<td>其他模式</td>' +
                displayHead(storeOther) + '</tr>';
            var nextTR = allStopStation.map(function(st){
                var stObj = TT.fn.getTRA_stationDataOfID(st);
                var clsTR = (stObj.big) ? ' bigStation' : '';
                var stBigStyle = (stObj.big) ? 'font-weight: 700;' : '';
                var rt = '<tr class="' + clsTR + '"><td class="stationName" style="' + stBigStyle + '">' + stObj.name + '</td>';
                rt += displayInside(storeMode,st);
                rt += '<td></td>';
                rt += displayInside(storeOther,st);
                rt += '</tr>';
                return rt;
            }).join('');
            html = '<table class="resultTable" cellpadding="0" cellspacing="0">' + firstTR + nextTR + '</table>';
            TT.now.allStopStation = allStopStation;
            
            var domA = document.getElementById(TT.ui.center.timeTable.displayDiv.trainDiv.id);
            domA.innerHTML = html;
            
            if(TT.now.train.length==0) TT.msg.show('糟糕，系統整理不出資料！');
        },
        clickTrainInfo: function(id){
            var mode = (function(){
                for(var i=0; i<TT.now.train.length; i++){
                    if(id==TT.now.train[i].id) return TT.now.train[i];
                }
            })();
            
            var stationStopAry = [];
			if(TT.now.route.length==1){
				stationStopAry = TT.now.allStopStation.filter(function(ast){
					return !!(mode.stationStopAry.indexOf(ast)!=-1);
				});
			}else{
				stationStopAry = mode.stationStopAry.sort(function(a,b){
					return (TT.now.allStopStation.indexOf(a) > TT.now.allStopStation.indexOf(b)) ? 1 : -1;
				});
				if(stationStopAry[0] != TT.now.from || stationStopAry[stationStopAry.length -1] != TT.now.to){
					var otherStation = [], tmpCBS;//存放不在預設路徑的車站
					stationStopAry = stationStopAry.filter(function(c){
						tmpCBS = !!(TT.now.allStopStation.indexOf(c)!=-1);
						if(!tmpCBS) otherStation.push(c);
						return tmpCBS;
					});
					
					var flagDiff = false, flagReSame = false, resameIdx = 0;
					TT.now.route.forEach(function(trt){//將其他路由車站塞回 stationStopAry 正確位置
						var allST = trt.allStation;
						var tmpAry = [];
						flagDiff = false, flagReSame = false;
						allST.forEach(function(c, idx){
							if(!flagDiff && stationStopAry.indexOf(c)==-1) flagDiff = true;
							if(stationStopAry.indexOf(c)==-1 && otherStation.indexOf(c)!=-1) tmpAry.push(c);
							if(flagDiff && stationStopAry.indexOf(c)!=-1){
								resameIdx = stationStopAry.indexOf(c);
								flagDiff = false;
								tmpAry.forEach(function(d){
									stationStopAry.splice(resameIdx, 0, d);
									resameIdx++;
								});
								tmpAry = [];
							}
						});
					});
				}
				
			}
            var list = mode.list.sort(function(a,b){
                return (a.sortTime > b.sortTime) ? 1 : -1;
            });
            
            var html = '<table class="trainTimeTable" border="1">';
            var displayHead = function(store){
                return store.map(function(c){
                    var classObj = getTrainClass(c.CarClass);
					var color = (classObj.color) ? classObj.color : '#47A';
					var cas = '<span style="color:' + color + ';" >' + classObj.name + '</span>';
                    var trainNum = '<span style="color:' + color + ';" >' + c.Train + '</span>';
                    var fromStr = TT.fn.getTRA_stationDataOfID('tra_'+c.TimeInfo[0].Station).name;
                    var toStr = TT.fn.getTRA_stationDataOfID('tra_'+c.TimeInfo[c.TimeInfo.length-1].Station).name;
					return '<td class="head">' + cas + '<br></br>' + trainNum + '<br></br>' + fromStr + '<br></br>' + '~' + '<br></br>' + toStr + '</td>';
				}).join('');
            }
            
            var displayInside = function(store, st){
                return store.map(function(c){
                    var classObj = getTrainClass(c.CarClass);
					var color = (classObj.color) ? classObj.color : '#47A';
					color = ' color:' + color + ';';
					st = TT.fn.getTRA_stationID(st);
					var timeStr = '', tmpB;
					for(var i=0; i<c.TimeInfo.length; i++){
						tmpB = c.TimeInfo[i];
						if(tmpB.Station==st){
							timeStr = tmpB.DepTime.substr(0,5);
							break;
						}
					};
					tmpStr = '<span style="' + color + '">' + timeStr + '</span>';
                    return '<td>' + tmpStr + '</td>';
                }).join('');
            }
            
            var tmpSTOBJ = '';
            var stationTimeAry = stationStopAry.map(function(st){
            	tmpSTOBJ = TT.fn.getTRA_stationDataOfID(st);
            	return '<tr><td>' + tmpSTOBJ.name + '</td>' + displayInside(list, st) + '</tr>';
            });
            
            var firstTR = '<tr><td></td>' + displayHead(list) + '</tr>';
            var nextTR = stationTimeAry.join('');
            
            html += firstTR + nextTR + '</table>';
            
            var win = new TT.lib.classWindow({
                html: html,
                mask: true
            });
            win.show();
        },
        resizeFn: function(e){
            var h = TT.fn.getDocumentHeight();
            var w = TT.fn.getDocumentWidth();
            var ch = h - 64;
            if(ch < 0) ch = 0;
            if(TT.os.isAndroidBrowser){
                TT.ui.centerDiv.style.height = 'auto';
            }else{
                TT.ui.centerDiv.style.height = ch + 'px';
            }
        },
        trainToSVG: function(){
            var domA = document.getElementById(TT.ui.center.timeTable.displayDiv.trainDiv.id);
            var str = domA.querySelector('table').innerHTML.toString();
            if(str==''){
                alert('必需先尋找列車停靠模式表後才能製圖');
                return false;
            }
            str = str.replace(/\<td class\=\"head\"/gi, '<td style="padding:3px 6px;" ').replace(/\<td\>/gi, '<td style="padding:2px 10px;">');
            str = str.replace(/\<tr class\=\"\ bigStation\"\>/gi, '<tr style="background-color:#F3F3F3;">');
            var rect = domA.querySelector('table').getBoundingClientRect();
            var canvas = document.createElement('canvas');
            canvas.style.width = rect.width + 'px'; canvas.style.height = rect.height + 'px';
            canvas.width = rect.width; canvas.height = rect.height;
            var ctx = canvas.getContext('2d');
            var data  = '<svg xmlns="http://www.w3.org/2000/svg" width="' + rect.width + '" height="' + rect.height + '">' +
                '<foreignObject width="100%" height="100%">' +
                    '<div xmlns="http://www.w3.org/1999/xhtml" style="font-size:14px; background-color:#FFF;">' +
                        str +
                        '<p style="font-size:10px;color:#111;">本圖片由<span style="color:#2244CC;">接軌時刻-列車行駛模式群組化系統</span>自動產生</p>' +
                    '</div>' +
                '</foreignObject>' +
            '</svg>';
            var DOMURL = window.URL || window.webkitURL || window;
            var img = new Image();
            var svg = new Blob([data], {type: 'image/svg+xml;charset=utf-8'});
            var url = DOMURL.createObjectURL(svg);
            
            var flgMake = false;
            img.onload = function () {
                if(flgMake) return false;
                flgMake = true;
                ctx.drawImage(img, 0, 0);
                DOMURL.revokeObjectURL(url);
                window.open(canvas.toDataURL());
                img.src = canvas.toDataURL();
            }
            
            img.src = url;
            domA.innerHTML += '<p>下方為產生的圖</p>';
            domA.appendChild(img);
            TT.msg.show('已產生圖檔，若無法自動開啟新視窗請注意封鎖彈出視窗');
            
            return canvas;
        },
        updateCenter: function(cmd){
            if(!cmd || /home/g.test(cmd)){
                //var aryCkWeekLoaded = $('.center .home .frameA.tra div.ckWeekLoaded').hide();
                if(TT.data.tra.timeTable){
                    for(var i=0; i<TT.data.tra.timeTable.length; i++){
                        if(TT.fn.checkTRA_dayTimeIsLoaded(i)){
                            //document.getElementById('tt_home_tra_ckWeekLoaded_' + i).style.display = '';
                        }
                    }
                }
            }
        }
    });
    
    TT.initFn = function(){
        //Remove HTML Element
        //var msff = document.getElementById(new Array('pre','_g','_text').join(''));
        //msff.innerHTML = '';
        //msff.style.display = 'none';
        //msff.remove();
        //.....
        
        //產生動態計算之固定路由資料
        TT.fn.createTRA_routeFile();
        //產生大站陣列
        var aryBig1 = TT.fn.getTRA_runningByID('wZi').mustStop.concat(TT.fn.getTRA_runningByID('eZi').mustStop).filter(function(c,idx,arr){ return !!(arr.indexOf(c)==idx) });
        var aryBig2 = TT.fn.getTRA_runningByID('wZi').maybeStop.concat(TT.fn.getTRA_runningByID('eJv').mustStop).concat(TT.fn.getTRA_runningByID('eTemu').maybeStop).filter(function(c,idx,arr){ return !!(arr.indexOf(c)==idx) && aryBig1.indexOf(c)==-1 });
        TT.stationBigAll = aryBig1.concat(aryBig2); TT.stationBig1 = aryBig1; TT.stationBig2 = aryBig2;
        
        //產生 UI
        TT.ui.createBaseDiv();
        TT.ui.createHeader();
        TT.ui.createStatus();
        
        TT.ui.createHome();
        TT.ui.createTimeTable();
        TT.ui.setCenterActive('timeTable');//home
        TT.ui.updateCenter();
        TT.msg.show('歡迎使用接軌時刻 Web APP。',2000);
        
        //TT.fn.getTRTC_timeTable2Data();//Initital get TRTC time
        //Check if auto search
        var GetP = TT.defined.GetP;
        if(GetP && GetP['findTrain'] && GetP['findTrain']==1) TT.ui.findTrain();
        
        //Resize function
        window.addEventListener('resize', TT.ui.resizeFn, false);
        TT.ui.resizeFn();
    }
        
    return TT;
})();

</script>
<script type="text/javascript" src="canvasTaiwanRailwayMap.js"></script>
<script type="text/javascript" src="html2canvas.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<!-- -->
<!-- -->
</head>
<body onload="TT.initFn()">
</body>
</html>
