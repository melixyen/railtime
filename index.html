
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html lang="zh-TW" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width; initial-scale=1.0" />
<meta name="description" content="接軌時刻 - 台灣鐵路火車捷運時刻表及路線轉乘查詢系統 Taiwan Railway MRT Timetable Web APP" />
<meta name="keywords" content="捷運,台鐵,火車,鐵路,時刻表,轉乘,TRA,TRTC,MRT,Timetable,Taiwan Railway,接軌時刻" />
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<title>接軌時刻 - Taiwan Railway MRT Timetable Web APP</title>
<link rel="stylesheet" type="text/css" href="ttlib/tm.css" />
<!--<link rel="stylesheet" type="text/css" href="x.css" />-->
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-143711253-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-143711253-1');
</script>


<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
<script type="text/javascript" src="ttlib/defined.js"></script>
<script type="text/javascript" src="ttlib/data.js"></script>
<script type="text/javascript" src="ttlib/fn.js"></script>
<script type="text/javascript" src="ttlib/fn_tymetro.js"></script>
<script type="text/javascript" src="ttlib/ptx.js"></script>
<script type="text/javascript">
//進度: 完成 getTRA_timeRangeByFromTo，可尋找某一時段間往來兩站的班次
//      完成 getTRA_timeRangeByFromTo 資料加上 getFromToTime , 接下來製作 TRTC 兩站時間查詢
//      完成 getTRTC_allTimeByFromTo 查全部兩站時間, 接下來製作時間範圍內查證
//      完成 getTRTC_timeRangeByFromTo 查台北捷運兩站範圍內時間 , 接下來製作跨台鐵捷運查詢
//      完成 getRoute_needRouteByFromTo 查兩站間是否需路由 , 接下來製作路由查詢正反向回傳路由
//      完成 getRoute_allRouteByFromTo 查兩站間路由 , 接下來製作路由上所有時間查詢
//      完成 getCommon_timeRangeByFromTo 查兩站間的時間 , 接下來 getCommon_timeTakeByFromTo
//      完成 getCommon_timeTakeByFromTo 對接時間內的 next prev , 接下按照 flagAD 整理每一組的最佳選擇
//      完成 getCommon_timeRangeBestByFromTo 整理最佳選擇 , 接下來 UI 印出最佳時間列車
//      完成 findTrain 與選項 UI , 接下來 printTrain 印出所有路線
//      完成 getData2JSON 及 saveDataJSON2Data 可由工具編輯 TT.data 內的資料但不含時刻表檔案
//      完成 createTrainRouteSelectBox 可勾選隱藏不想要經過的路徑
//      完成 createWeekSelect 可以選擇使用星期幾去搜尋
//      完成 getTRTC_stationOnOutArea 可查詢 TRTC 站是否在非重疊區
//      完成 classMapSelector 路線挑選器基礎視窗
//      完成 timeTableTrainRouteBox 及路線挑選器簡易的 media query 適應小寬度平台
//      完成 resetCountOfTrainRouteBox 獨立於所有 checkbox 結束後才呼叫重算 NO. 並改以獨立 ID 命名 span 加快更新速度
//      完成 getRoute_mapSystemOfFromToLine 跨出地區從系統上尋找路由
//      新增 getRoute_filterSameRoute 過濾不必要的路由 giveRoute_transStationOtherData
//		新增 getTRA_linkRouteV1 及 getTRA_linkMap 做自動化路由搜尋
rocptx.AppID = atob('bWVsaXh5ZW4tNGE3MDA1YWQtMWE0Ny00NDAx');
rocptx.AppKey = atob("MjlhOTM4MzUtNDM4OS00M2EyLTljOGMtMzBmYjgyMDdmZTA2");
var TT = (function(){

    var TT = $trainTaiwanLib;
    
    TT.defined.programAbout = {
            "程式名稱": "接軌時刻",
            "作者": "Melix Yen (melixyen@gmail.com)",//修改後請將自己的名稱以 , 分隔加在前人後面，可帶括號標誌匿名或電子郵件等其他資訊，例如 test (test@abc.com)
            '發行單位': '<span style="background-color: #BBB;"><span style="color:blue;">極</span><span style="color:#FEFE11;">光</span><span style="color:#005530;">駭</span><span style="color:red;">客</span></span>',
            "版本": "Beta 0.6.3",
            "產生日期": "2021/10/24",
            "資料源": "離線資料由台鐵及捷運公開資料轉換取得，線上資料介接交通部TDX服務平臺"
    };
    TT.defined.programUpdateInfo = [
                    'Beta 0.6.3: 動態資料源由 PTX 更新為 TDX。',
                    'Beta 0.6.2: 新增環狀線，使用假設時刻表。',
                    'Beta 0.6.1: 新增文湖線，使用頻率計算時刻表。',
                    'Beta 0.6.0: 新增公共交通整合平台 PTX API 呼叫 lib，有讀回時刻表則用該時刻表。',
                    'Beta 0.5.9: 新增台鐵補償式自動化搜尋連結處理屏東線及海線和集集線。',
                    'Beta 0.5.8: 新增台鐵捷運化 2018 年啟用之台中及高雄通勤站。',
                    'Beta 0.5.7: 新增台鐵速查系統連結及屏東線內部潮州轉乘。',
                    'Beta 0.5.6: 修正台鐵沙崙線轉平溪線無法查詢錯誤。',
                    'Beta 0.5.5: 新增台鐵新富站。',
                    'Beta 0.5.4: 新增機場捷運與台北捷運蘆洲線透過三重與大橋頭轉乘。',
                    'Beta 0.5.3: 新增機場捷運與台北捷運部分路線互相轉乘查詢。',
                    'Beta 0.5.2: 新增機場捷運與台鐵互相轉乘查詢。',
                    'Beta 0.5.1: 新增機場捷運時刻表，可在路網內查詢。',
                    'Beta 0.5.0: 調整路線圖內桃園機場捷運為正式路線，工具新增機場捷運時刻表計算器。',
                    'Beta 0.4.9: 新增台鐵三姓橋站及八斗子站。',
                    'Beta 0.4.8: 台鐵時刻表改讀公開資訊 JSON 格式檔加速時候表載入。',
                    'Beta 0.4.7: 新增沙崙線。',
                    'Beta 0.4.6: 新增西部幹線嘉義至高雄。',
                    'Beta 0.4.5: 新增西部幹線彰化至嘉義。',
                    'Beta 0.4.4: 新增山線。',
                    'Beta 0.4.3: 過濾部分迂迴的路徑。',
                    'Beta 0.4.2: 隱藏無班車的路由，新增輸入站名搜尋功能。',
                    'Beta 0.4.1: 更新 canvas map 及新增松山站轉乘教學。',
                    'Beta 0.4: 新增台東線。',
                    'Beta 0.3.9: 調整 canvas map，增加截圖功能。',
                    'Beta 0.3.8: 新增內灣線，修正東線可直達六家線。',
                    'Beta 0.3.7: 新增新竹地區至竹南以及六家線。',
                    'Beta 0.3.6: 修正東部幹線轉捷運互相查詢後路由會失效的錯誤。',
                    'Beta 0.3.5: 修正西部大站與東部小站間使用轉乘系統。',
                    'Beta 0.3.4: 新增北迴線的轉乘查詢。',
                    'Beta 0.3.3: 更新松山站提供轉乘教學影片。',
                    'Beta 0.3.2: 新增平溪線及宜蘭線的轉乘查詢。',
                    'Beta 0.3.1: 更新南港站提供轉乘教學影片。',
                    'Beta 0.3: 新增路網圖選擇器提供北台灣軌道運輸路網站點選擇。'
    ];
    
    
    TT.ui = TT.lib.apply(TT.ui, {
        centerScroll: function(val, isDirect){
            var sysTop;
            if(val || val===0){
                if(isDirect){
                    $(TT.ui.centerDiv).scrollTop(val);
                }else{
                    $(TT.ui.centerDiv).animate({ scrollTop: val }, 400);
                }
            }
            sysTop = document.body.scrollTop;
            return sysTop;
        },
        centerTimeTableDisplayDivClear: function(){
            TT.ui.center.timeTable.displayDiv.trainDiv.innerHTML = '';
            TT.ui.center.timeTable.displayDiv.routeDiv.innerHTML = '';
            TT.now = false;
        },
        createBaseDiv: function(){
            TT.ui.maskDiv = TT.ui.createDiv('tt_mask', 'mask', 'body');
            TT.ui.maskText = TT.ui.createDiv('tt_mask_text', 'text', 'tt_mask');
            TT.ui.maskText.innerHTML = 'Loading...';
            
            TT.ui.centerDiv = TT.ui.createDiv('tt_center', 'center', 'body');
            TT.ui.center = {};
        },
        createHome: function(){
            TT.ui.center.home = TT.ui.createDiv('tt_home', 'centerPage home', TT.ui.centerDiv.id);
            
            //HELP Frame
            TT.ui.center.home.help = TT.ui.createDiv('tt_home_help', 'frameA help', TT.ui.center.home.id);
            var helpDiv = TT.ui.center.home.help;
            helpDiv.divTitle = TT.ui.createDiv(helpDiv.id + '_title', 'title', helpDiv.id);
            helpDiv.divTitle.innerHTML = '說明';
            helpDiv.divText1 = TT.ui.createDiv(helpDiv.id + '_text1', 'text', helpDiv.id);
            helpDiv.divText1.innerHTML = '<p>' + '一般使用者進行查詢請使用時刻表功能，研究使用者要調整各項參數與路由可從工具內調整。' + '</p>' +
                '<p>' + '有關時刻表功能之簡單說明如下' + '</p>' +
                '<ul>' +
                    '<li><b>我在每個轉乘站的步行時間：</b>可依個人步行速度或預期誤點可能性調整轉車預留時間。</li>' +
                    '<li><b>出發站、到達站：</b>可從下拉選單中選擇一個車站，或者從右邊的<div class="help_selectStationByLine">選擇車站</div>中依照路線選擇車站。</li>' +
                    '<li><b>從這個時間開始、到這個時間為止：</b>調整預計搭車的時間，假設 08:00 後才出發可以設定 08:00 到 09:00 之間，建議間隔不要超過三小時避免搜尋出來的資料過多。</li>' +
                    '<li><b>出發的列車：</b>設定為出發的列車將會以出發站的時間來做計算。</li>' +
                    '<li><b>到達的列車：</b>設定為到達的列車將會以到達站的時間來做計算，例如 08:50 前要到市政府站可以設定時間 07:50 開始到 08:50 為止去做查詢。</li>' +
                '</ul>' +
                '<p>' + '有關搜尋出結果之簡單說明如下' + '</p>' +
                '<ul>' +
                    '<li><b>排序：</b>可依個人需求調整排序的方式，像是越早抵達、花費時間越短之類的需求。</li>' +
                    '<li><b>路徑：</b>搜尋完會將系統上所有可以轉車的方式列出來，並附有花費時間作參考，可以勾選清除不想看的路徑，例如花費時間太長的或轉車次數太多的。</li>' +
                    '<li><b>怎麼路徑上有<div class="tt_ck_route_filterPri">1</div><div class="tt_ck_route_filterPri">2</div><div class="tt_ck_route_filterPri">3</div>？</b>那是快速切換只看最快(1)到前三快(3)轉乘路徑。</li>' +
                    '<li><b>螢幕不夠寬怎麼看全部資訊？</b>網頁部分資訊採用 RWD　呈現，當螢幕不夠寬會隱藏部分資訊，想看完整資訊可點右邊的<div class="help_timeTableResultMore">&gt;&gt;</div>。</li>' +
                    '<li><b>搜尋完後網址變了？</b>在支援 HTML5 history 功能的瀏覽器上，網址會自動帶上搜尋參數，複製網址給別人連進來可以自動搜尋你當初搜尋的條件。</li>' +
                '</ul>';
            //HELP Frame
            TT.ui.center.home.update = TT.ui.createDiv('tt_home_update', 'frameA update', TT.ui.center.home.id);
            var updateDiv = TT.ui.center.home.update;
            updateDiv.divTitle = TT.ui.createDiv(updateDiv.id + '_title', 'title', updateDiv.id);
            updateDiv.divTitle.innerHTML = '更新';
            updateDiv.divText1 = TT.ui.createDiv(updateDiv.id + '_text1', 'text', updateDiv.id);
            updateDiv.divText1.innerHTML = '' +
                '<div style="height: 80px; overflow-y:scroll; overflow-x:hidden;"><ul>' +
                (function(){ return '<li>' + TT.defined.programUpdateInfo.join('</li><li>') + '</li>'; })() +
                '</ul><div>';
            
            //TRA Frame
            TT.ui.center.home.tra = TT.ui.createDiv('tt_home_tra', 'frameA tra', TT.ui.center.home.id);
            TT.ui.center.home.tra.divTitle = TT.ui.createDiv('tt_home_tra_title', 'title', TT.ui.center.home.tra.id);
            TT.ui.center.home.tra.divTitle.innerHTML = '台鐵 TRA';
            TT.ui.center.home.tra.divText1 = TT.ui.createDiv('tt_home_tra_text1', 'text', TT.ui.center.home.tra.id);
            TT.ui.center.home.tra.divText1.innerHTML = '<p>台鐵時刻表載入自政府資料開放平台之鐵路時刻表。</p>' +
                '<p>下載開發者替換時刻表檔案請在網頁同目錄下儲存w0.json ~ w6.json，w0為星期日。</p>';
            TT.ui.center.home.tra.divCkWeek = TT.ui.createDiv('tt_home_tra_ckWeek', 'option', TT.ui.center.home.tra.id);
            TT.ui.center.home.tra.divCkWeek.innerHTML = '<ul>' +
                '<li><input type="checkbox" id="tt_home_tra_ckWeek_1" class="ckWeek">讀取星期一<div id="tt_home_tra_ckWeekLoaded_1" class="ckWeekLoaded">已讀取</div></li>' +
                '<li><input type="checkbox" id="tt_home_tra_ckWeek_2" class="ckWeek">讀取星期二<div id="tt_home_tra_ckWeekLoaded_2" class="ckWeekLoaded">已讀取</div></li>' +
                '<li><input type="checkbox" id="tt_home_tra_ckWeek_3" class="ckWeek">讀取星期三<div id="tt_home_tra_ckWeekLoaded_3" class="ckWeekLoaded">已讀取</div></li>' +
                '<li><input type="checkbox" id="tt_home_tra_ckWeek_4" class="ckWeek">讀取星期四<div id="tt_home_tra_ckWeekLoaded_4" class="ckWeekLoaded">已讀取</div></li>' +
                '<li><input type="checkbox" id="tt_home_tra_ckWeek_5" class="ckWeek">讀取星期五<div id="tt_home_tra_ckWeekLoaded_5" class="ckWeekLoaded">已讀取</div></li>' +
                '<li><input type="checkbox" id="tt_home_tra_ckWeek_6" class="ckWeek">讀取星期六<div id="tt_home_tra_ckWeekLoaded_6" class="ckWeekLoaded">已讀取</div></li>' +
                '<li><input type="checkbox" id="tt_home_tra_ckWeek_0" class="ckWeek">讀取星期日<div id="tt_home_tra_ckWeekLoaded_0" class="ckWeekLoaded">已讀取</div></li>' +
            '</ul>';
            TT.ui.center.home.tra.buttonReadWeekTimeTable = TT.ui.createSystemButton({
                id: 'tt_home_tra_btnReadWeekTimeTable', 
                text: '手動讀取時刻表',
                appendT: TT.ui.center.home.tra.id,
                clickFn: function(e){
                    var aryCkWeek = $('.center .home .frameA.tra input.ckWeek');
                    var ws = '';
                    aryCkWeek.each(function(e,t){
                        var w = t.id.replace('tt_home_tra_ckWeek_','');
                        if(t.checked==true){
                            ws += w;
                        }
                    });
                    TT.fn.getTRA_TimeTable2Data(ws);
                }
            });
            
            //TRTC Frame
            TT.ui.center.home.trtc = TT.ui.createDiv('tt_home_trtc', 'frameA trtc', TT.ui.center.home.id);
            TT.ui.center.home.trtc.divTitle = TT.ui.createDiv('tt_home_trtc_title', 'title', TT.ui.center.home.trtc.id);
            TT.ui.center.home.trtc.divTitle.innerHTML = '台北捷運 TRTC';
            TT.ui.center.home.trtc.divText1 = TT.ui.createDiv('tt_home_trtc_text1', 'text', TT.ui.center.home.trtc.id);
            TT.ui.center.home.trtc.divText1.innerHTML = '<p>因沒有台北捷運如台鐵的每列班車資訊，目前台北捷運的資料以網友ronnywang自台北捷運官網轉換出來的csv檔轉成json後匯入，沒有時刻表的車站會以站間行駛時間做相對計算。<span style="color:#FF4020;">台北捷運無法查詢新北投線、小碧潭線、文湖線</span>，行車時間均以台北捷運官方網站查詢之<span style="color:#1FB020;">站間行駛時間相加或相減於南港站、松山站、淡水站及南勢角站</span>，故時間上可能與真正的到站時刻有一兩分鐘的誤差。</p>' +
                '<p>替換時刻表檔案請在網頁同目錄下儲存 <a target="_new" href="ronnywang_trtc.json">ronnywang_trtc.json</a> </p>';
            
            //Program Frame
            TT.ui.center.home.prog = TT.ui.createDiv('tt_home_prog', 'frameA prog', TT.ui.center.home.id);
            TT.ui.center.home.prog.divTitle = TT.ui.createDiv('tt_home_prog_title', 'title', TT.ui.center.home.prog.id);
            TT.ui.center.home.prog.divTitle.innerHTML = '接軌時刻 Web APP 概述';
            TT.ui.center.home.prog.divText1 = TT.ui.createDiv('tt_home_prog_text1', 'text', TT.ui.center.home.prog.id);
            TT.ui.center.home.prog.divText1.innerHTML = '<p>接軌時刻是建立台灣的跨營運系統間轉乘時間查詢程式，便於研究有效率的轉乘路徑。</p>' +
                '<p>接軌時刻的授權原則' +
                    '<ul>' +
                        '<li>任何使用均可 E-Mail 原作者取得授權，但修改網頁後執行於網頁伺服器上請加註作者名稱於取得版本的作者之後，以區別為個人化版本，版本、發行單位、日期可自由調整。</li>' +
                        '<li>台北捷運時刻表 JSON 資料轉換自網友 <a target="_new" href="https://sheethub.com/ronnywang/%E5%8F%B0%E5%8C%97%E6%8D%B7%E9%81%8B%E7%8F%AD%E6%AC%A1%E6%99%82%E5%88%BB%E8%A1%A8">ronnywang 網站</a>，相關授權請洽詢他本人</li>' +
                    '</ul>' +
                '</p>' +
                /*'<p>前導網頁的開發原則' +
                    '<ul>' +
                        //'<li>除非必要，否則不使用jQuery基本版以外的套件，網頁上的元件盡量以 HTML 原生元件操作以維持相容性並避免其他 library 授權問題，前導網頁不特別要求元件外觀與整體美觀，簡單易讀方便操作修改為原則。</li>' +
                        '<li>使用 HTML、Javascript、CSS構成，不使用任何伺服器端技術與資料庫，保持未來移植其他平台離線使用可能性。</li>' +
                        '<li>時刻表與路由資料原則採離線運作，所需要之台鐵或捷運公司時刻表下載後存放在網頁同目錄下讀取。</li>' +
                       // '<li>為方便由本機進行 Ajax 存取，本機開發需相容 Firefox 瀏覽器，在伺服器線上時必需相容 Chrome，其餘瀏覽器(如 Safari、Opera、IE)相容性在前導網頁不特別要求。</li>' +
                        //'<li>時刻表或大型資料以搜尋運用時才讀取為原則，加快進入網頁速度。</li>' +
                        //'<li>有更新開發進度時可以簡單寫一行在 Javascript 開頭的註解區。</li>' +
                        '<li>軌道的運轉方向與台鐵接近平行者採相同為原則，其餘視點由北往南、由東向西，若相近於逆時針時 dir 為 1，相近於順時針時 dir 為 0。</li>' +
                        '<li>不使用網路上或它處取得的圖檔以避免圖像授權問題，自行製作的圖檔盡量以 base64 編碼後存於 CSS 來利用。</li>' +
                        //'<li>前導網頁的 HTML、Javascript、CSS 存放於單一網頁檔內，不使用任何壓縮 code 或 Build 方式才運作，轉為正式版時才進行分拆作業。</li>' +
                        '<li>Name Space 為 TT，進入點為 TT.initFn()，底層演算法和工具存放於 TT.fn 下，與網頁外觀顯示相關存放於 TT.ui 下，基礎資料存放於 TT.data 下，基本定義存放於 TT.defined 下，當次搜尋結果存放於 TT.now 下。</li>' +
                        //'<li>HTML CODE 的 BODY 保持內容乾淨，UI以 createElement 的方式附加上去，元件內容則可以 innerHTML 直接設計。</li>' +
                        '<li>轉乘步行時間存在 TT.data.transStation 下各站的 walkMinute，理論上每一種轉乘方式都要建立一個轉乘站，例如台北站台鐵捷運之間就要建立台鐵至板南線、台鐵至淡水信義線、板南線至淡水信義線，分別存放步行時間並成為該種路線的路由點。</li>' +
                        '<li>轉乘路由方式存在 TT.data.routeMap 下，目前以人工方式整理可能的路由。</li>' +
                        //'<li>下拉上背景色，當車站下拉選單超過兩百個選項以上時需著手進行車站選擇器的新 UI 調整，不適合再使用單純的 SELECT 元件。</li>' +
                        //'<li></li>' +
                    '</ul>' +
                '</p>' +*/
                '<p>接軌時刻的運作現況' +
                    '<ul>' +
                        '<li><span style="color:#FE2010;">搜尋時間間隔超過三小時可能造成計算過久。</span></li>' +
                        '<li>台鐵部分目前只開放基隆至高雄站、八堵至台東站。</li>' +
                        '<li>台北捷運的部分目前僅建立部分車站資料台北捷運說明框內敘述。</li>' +
                        '<li>台北捷運無台鐵般詳細的每列車到站與離站資訊，時間上均採用相對計算方式於台北捷運說明框內敘述。</li>' +
                        '<li>因為將資料載入到前端做計算，好處是連續查詢都在前端完成不用跑伺服器速度快，壞處是在運算效能低落的裝置上計算較慢。</li>' +
                    '</ul>' +
                '</p>' +
                '<p>關於' +
                    (function(){
                        var rt = '';
                        for(var k in TT.defined.programAbout){
                            rt += '<li>' + k + ': ' + TT.defined.programAbout[k] + '</li>';
                        }
                        return '<ul>' + rt + '</ul>';
                    })() +
                '</p>' +
                '<p></p>' +
            '';
            
        },
        createTimeTable: function(){
            if(TT.ui.center.timeTable){
                TT.ui.center.timeTable.innerHTML = '';
            }else{
                TT.ui.center.timeTable = TT.ui.createDiv('tt_timeTable', 'centerPage timeTable', TT.ui.centerDiv.id);
            }
            var localDataFn = TT.fn.localData;
            
            //Control Frame
            TT.ui.center.timeTable.controlDiv = TT.ui.createDiv('tt_timeTable_control', 'frameA control', TT.ui.center.timeTable.id);
            TT.ui.center.timeTable.controlDiv.preSettingDiv = TT.ui.createPreSetting({id: 'ttc_preSetting', renderID: 'tt_timeTable_control'});
            TT.ui.center.timeTable.controlDiv.stationSelectDiv = TT.ui.createTakeStation({id: 'ttc_stationSelect', renderID: 'tt_timeTable_control'});
            TT.ui.center.timeTable.controlDiv.timeSelectDiv = TT.ui.createTakeTimeSelect({id: 'ttc_timeSelect', renderID: 'tt_timeTable_control'});
            TT.ui.center.timeTable.controlDiv.weekSelectDiv = TT.ui.createWeekSelect({id: 'ttc_weekSelect', renderID: 'tt_timeTable_control'});
            TT.ui.center.timeTable.controlDiv.depArrDiv = TT.ui.createTakeTimeFindDepArr({id: 'ttc_ADSelect', renderID: 'tt_timeTable_control'});
            TT.ui.center.timeTable.controlDiv.findButtonDiv = TT.ui.createTakeFindButton({id: 'ttc_findButton', renderID: 'tt_timeTable_control'});
            //Set default param
            var defaultFromStation = (localDataFn.getItem('defaultFromStation')) ? localDataFn.getItem('defaultFromStation') : 'tra_1005',
                defaultToStation = (localDataFn.getItem('defaultToStation')) ? localDataFn.getItem('defaultToStation') : 'trtc_093',
                defaultSearchDay = new Date().getDay(),
                defaultStartTime = (localDataFn.getItem('defaultStartTime')) ? localDataFn.getItem('defaultStartTime') : '07:00',
                defaultEndTime = (localDataFn.getItem('defaultEndTime')) ? localDataFn.getItem('defaultEndTime') : '09:00';
            //Use Get param
            var GetP = TT.defined.GetP;
            if(GetP){
                if(GetP['a']) defaultFromStation = GetP['a'];
                if(GetP['b']) defaultToStation = GetP['b'];
                if(GetP['w']) defaultSearchDay = GetP['w'];
                if(GetP['startTime']) defaultStartTime = decodeURIComponent(GetP['startTime']);
                if(GetP['endTime']) defaultEndTime = decodeURIComponent(GetP['endTime']);
            }
            TT.ui.center.timeTable.controlDiv.stationSelectDiv.fnSetStart(defaultFromStation);
            TT.ui.center.timeTable.controlDiv.stationSelectDiv.fnSetEnd(defaultToStation);
            TT.ui.center.timeTable.controlDiv.timeSelectDiv.fnSetStartTime(defaultStartTime);
            TT.ui.center.timeTable.controlDiv.timeSelectDiv.fnSetEndTime(defaultEndTime);
            TT.ui.center.timeTable.controlDiv.weekSelectDiv.fnSetDay(defaultSearchDay);
            
            //Display Frame
            TT.ui.center.timeTable.displayDiv = TT.ui.createDiv('tt_timeTable_display', 'ttbDisplay', TT.ui.center.timeTable.id);
            TT.ui.center.timeTable.displayDiv.routeDiv = TT.ui.createDiv('tt_timeTable_d_route', 'route', TT.ui.center.timeTable.displayDiv.id);
            TT.ui.center.timeTable.displayDiv.trainDiv = TT.ui.createDiv('tt_timeTable_d_train', 'train', TT.ui.center.timeTable.displayDiv.id);
            
            //Window
            TT.ui.createTransStationWalkTimeWindow();
        },
        createTool: function(){
            TT.ui.center.tool = TT.ui.createDiv('tt_tool', 'centerPage tool', TT.ui.centerDiv.id);
            TT.ui.center.tool.innerHTML = '<div style="padding-left: 40px;"><span><a href="busp.html">公車雲端站牌</a> | <a href="calc_tymetro.html">連結至桃園機場捷運時刻表產生器</a></span></div>' +
				'<div style="padding-left: 40px;"><span><a href="ft.html">台鐵快查系統</a> | </span><span><a href="klrt.html">基隆輕軌模擬器</a> | </span><span><a href="https://github.com/melixyen/rocptx">PTX library</a> | </span><span><a href="group_train.html">列車行駛模式群組化系統</a> | </span><span><a href="ctra2016.html">連結至台鐵 2016 年旅運量報表</a> | </span><span><a href="ctra2017.html">連結至台鐵 2017 年旅運量報表</a></span></div>';
            
            //DATA Frame
            TT.ui.center.tool.dataDiv = TT.ui.createDiv('tt_tool_data', 'frameA trtc', TT.ui.center.tool.id);
            TT.ui.center.tool.dataDiv.divTitle = TT.ui.createDiv('tt_tool_data_title', 'title', TT.ui.center.tool.dataDiv.id);
            TT.ui.center.tool.dataDiv.divTitle.innerHTML = '1. TT.data 編輯工具';
            TT.ui.center.tool.dataDiv.divText1 = TT.ui.createDiv('tt_tool_data_text1', 'text', TT.ui.center.tool.dataDiv.id);
            TT.ui.center.tool.dataDiv.divText1.innerHTML = '<p>請由下方選擇要編輯的 TT.data 子節點，資料以 JSON 格式編輯。如果編輯的資料需要重新產生時刻表的選單，例如車站，請儲存完後再按右邊的<span style="color:orange">[重新產生時刻表 UI]</span> 按鈕。</p>';
            
            TT.ui.center.tool.dataDiv.divEditTool = (function(dv){
                var tagDiv = TT.ui.createDiv('tt_tool_data_edit_tag', 'tag');
                var tagSelect1 = '';
                for(var k in TT.data){
                    tagSelect1 += '<div class="tagSelect ' + k + '" tttag="' + k + '">' + k + '</div>';
                }
                tagDiv.innerHTML = tagSelect1;
                
                var editorDiv = TT.ui.createDiv('tt_tool_data_edit_editor', 'editor');
                editorDiv.innerHTML = '<textarea class="textarea" id="' + editorDiv.id + '_textarea"></textarea>' +
                    '<div class="btnDiv"><button class="btnSaveTTDataEditTool">儲存編輯完成的資料</button></div>' +
                    '<div class="btnDiv"><button class="btnRebuildTimeTableUI">重新產生時刻表 UI</button></div>';
                
                var rtDiv = TT.ui.createDiv('tt_tool_data_edit', 'edit', dv.id);
                rtDiv.className = 'editTool';
                rtDiv.fnUpdateTag = function(){
                    var ts = $('.center .editTool .tag .tagSelect');
                    ts.each(function(m){
                        ts[m].className = ts[m].className.replace(' selected','');
                    });
                    var nowTs = $('.center .editTool .tag .tagSelect.' + TT.editToolTagOn)[0];
                    nowTs.className = nowTs.className + ' selected';
                };
                rtDiv.addEventListener('click', function(e){
                    var tcls = e.target.className; 
                    
                    if(tcls.indexOf('tagSelect')>=0){
                        tttag = e.target.attributes.getNamedItem('tttag').value;
                        TT.editToolTagOn = tttag;
                        document.getElementById(editorDiv.id + '_textarea').value = TT.fn.getData2JSON(tttag);
                        rtDiv.fnUpdateTag();
                    }
                    if(tcls.indexOf('btnSaveTTDataEditTool')>=0){
                        TT.fn.saveDataJSON2Data(TT.editToolTagOn, document.getElementById(editorDiv.id + '_textarea').value);
                        TT.msg.show('已更新 TT.data.' + TT.editToolTagOn + ' 的資料');
                    }
                    if(tcls.indexOf('btnRebuildTimeTableUI')>=0){
                        TT.ui.createTimeTable();
                    }
                }, false);
                
                rtDiv.appendChild(tagDiv);
                rtDiv.tagDiv = tagDiv;
                rtDiv.appendChild(editorDiv);
                rtDiv.editorDiv = editorDiv;
                return rtDiv;
            })(TT.ui.center.tool.dataDiv);
        },
        createHeader: function(){
            var dom = document.createElement('div');
            dom.id = 'tt_headerBar';
            document.body.appendChild(dom);
            dom.className = 'headerBar';
            
            TT.ui.buttonHome = TT.ui.createHeaderButton({id: 'tt_hdBtn_home', text: '說明', clickFn: function(e){TT.ui.setCenterActive('home');}});
            TT.ui.buttonTimeTable = TT.ui.createHeaderButton({id: 'tt_hdBtn_timeTable', text: '時刻表', clickFn: function(e){TT.ui.setCenterActive('timeTable');}});
            TT.ui.buttonTool = TT.ui.createHeaderButton({id: 'tt_hdBtn_tool', text: '工具', clickFn: function(e){TT.ui.setCenterActive('tool');}});
            TT.ui.buttonBackTop = TT.ui.createHeaderButton({id: 'tt_hdBtn_backTop', text: '回到頂端', cls: 'headerButton2', clickFn: function(e){TT.ui.centerScroll(0);TT.ui.bodyScroll(0);}});
            
            dom.appendChild(TT.ui.buttonHome);
            dom.appendChild(TT.ui.buttonTimeTable);
            dom.appendChild(TT.ui.buttonTool);
            dom.appendChild(TT.ui.buttonBackTop);
        },
        createButton: function(cfg){
            //cfg = id, text, cls(class), clickFn
            if(!cfg.cls){cfg.cls = ' systemButton';}
            var div = document.createElement('div');
            div.className = cfg.cls;
            div.id = cfg.id;
            div.innerHTML = '<span>' + cfg.text + '</span>';
            div.addEventListener('click', cfg.clickFn);
            if(cfg.appendT){
                if(cfg.appendT == 'body'){
                    document.body.appendChild(dom);
                }else{
                    document.getElementById(cfg.appendT).appendChild(div);
                }
            }
            return div;
        },
        createSystemButton: function(cfg){
            if(!cfg.cls){cfg.cls = '';}
            cfg.cls = cfg.cls + ' systemButton';
            return TT.ui.createButton(cfg);
        },
        createHeaderButton: function(cfg){
            if(!cfg.cls){cfg.cls = '';}
            cfg.cls = cfg.cls + ' headerButton';
            return TT.ui.createButton(cfg);
        },
        createStatus: function(){
            var dom = document.createElement('div');
            dom.id = 'tt_statusBar';
            document.body.appendChild(dom);
            dom.className = 'statusBar';
            TT.ui.statusBar = dom;
        },
        createTakeFindButton: function(cfg){
            cfg = cfg || {};
            if(!cfg.id) cfg.id = TT.ui.genRandomId();
            if(!cfg.text) cfg.text = '尋找';
            if(!cfg.cls) cfg.cls = '';
            if(!cfg.btnCls) cfg.btnCls = '';
            if(!cfg.clickFn){
                cfg.clickFn = function(){
                    TT.ui.findBeforeTrain();
                }
            }
            
            var btn = document.createElement('button');
            btn.id = cfg.id;
            btn.className = cfg.btnCls + ' findButton floatLeftStyle';
            btn.innerHTML = cfg.text;
            btn.addEventListener('click', cfg.clickFn);
            
            var div = document.createElement('div');
            div.className = cfg.cls + ' findButtonDiv';
            div.id = cfg.id+'_div';
            
            var iptID = cfg.id + '_ckpt';
            var ckUsePTXDiv = document.createElement('div');
            var ckDefaultValue = (TT.defined.usePTX) ? ' checked="true"' : '';
            ckUsePTXDiv.innerHTML = '<span><input id="' + iptID + '" type="checkbox" ' + ckDefaultValue + ' onclick="TT.ui.fnCheckUsePTX_boolean()" onchange="TT.ui.fnCheckUsePTX_boolean()">允許使用交通部 TDX 服務平臺 API 查找時刻</span>';
            TT.ui.fnCheckUsePTX_boolean = function(){
            	var dom = ckUsePTXDiv.querySelector('#' + iptID);
            	TT.defined.usePTX = !!(dom.checked);
            }
            
            div.appendChild(btn);
            div.appendChild(ckUsePTXDiv);
            
            if(cfg.renderID && cfg.renderID!=''){document.getElementById(cfg.renderID).appendChild(div);}
            return div;
        },
        createPreSetting: function(cfg){
            cfg = cfg || {};
            if(!cfg.id) cfg.id = TT.ui.genRandomId();
            
            var div = document.createElement('div');
            div.id = cfg.id;
            div.className = 'preSetting';
            div.innerHTML = '<div class="title">預先調整參數</div>' +
            '<div><span>' +
                '<button class="transStationWalkTimeWindow">' + '我在每個轉乘站的步行時間' + '</button>' +
            '</span></div>';
            div.addEventListener('click', function(e){
                if(e.target.className=='transStationWalkTimeWindow') TT.ui.transStationWalkTimeWindow.show();
            }, false);
            if(cfg.renderID && cfg.renderID!=''){document.getElementById(cfg.renderID).appendChild(div);}
            return div;
        },
        createMapSelector: function(){
            if(TT.ui.mapSelector) return false;
            var cfg = {}, afterSelectCbFn, win;
            var astObj = TT.fn.getCommon_allTrainStation();
            var astLine = {};
            cfg.autoScroll = false;//(TT.os.isAndroidBrowser) ? false : true;
            astObj.allAry.map(function(objA){
                var line = (objA.byLine);
                if(!astLine[line]) astLine[line] = new Array();
                astLine[line].push(objA);
            });
            
            var divLine = (function(){
                var div = document.createElement('div');
                div.className = 'line_selector';
                var allHTML, htLine = '', tmpST, htStation = ''; 
                for(var k in astLine){
                    htLine += '<div class="lineName ' + TT.defined.railBgcolor + k + '" clickOnLine="1" lineID="' + k + '">' + TT.fn.getCommon_lineName(k) + '</div>';
                    tmpST = '';
                    astLine[k].map(function(sta){
                        tmpST += '<div class="stationName ' + 'mmm'+TT.defined.railBgcolor + k + '" clickOnStation="1" stationID="' + sta.id + '">' + TT.fn.getCommon_stationDataOfID(sta.id).name + '</div>';
                    });
                    htStation += '<div style="display:none;" class="stationGroup ' + k + ' ' + TT.defined.railBgcolor + k + '" lineID="' + k + '">' + tmpST + '</div>';
                }
                htLine = '<div class="allLine">' + htLine +'</div>';
                htStation = '<div class="allStation">' + htStation +'</div>';
                allHTML = htLine + htStation;
                div.innerHTML = allHTML;
                div.headerText = '使用路線列表選擇車站';
                
                div.addEventListener('click', function(e){
                    var t = e.target;
                    if(t.attributes.getNamedItem('clickOnLine')){
                        var id = t.attributes.getNamedItem('lineID').value;
                        $('.line_selector .allLine .lineName').each(function(idx,dom){
                            dom.className = dom.className.replace(' select','');
                        });
                        $('.line_selector .allStation .stationGroup').hide();
                        $('.line_selector .allStation .stationGroup.' + id).show();
                        t.className = t.className + ' select';
                    }else if(t.attributes.getNamedItem('clickOnStation')){
                        var id = t.attributes.getNamedItem('stationID').value;
                        if(afterSelectCbFn){
                            afterSelectCbFn(id);
                        }
                        win.close();
                        TT.ui.msg.show(TT.fn.getCommon_stationDataOfID(id).name,600);
                    }
                }, false);
                return div;
            })();
            var divLineAfterFn = function(){
            
            }
            
            
            var divNet = (function(){
                var div = document.createElement('div');
                div.className = 'line_selector';
                div.headerText = '使用路網圖選擇車站';
                return div;
            })();
            
            cfg.items = [divLine, divNet];
            cfg.onShow = function(wwin, wcfg, scfg){
                //scfg from call show take parameter
                scfg = scfg || {};
                afterSelectCbFn = scfg.afterSelectCbFn;
                win = wwin;
                if(TT.lib.canvasMap && !TT.ui.mapSelector.canvasMap){
                    var canvasMap = new TT.lib.canvasMap({
                        drawPlanLine: true,
                        stationNameRenderStyle: 2,
                        drawPlanLineOriginalColor: false
                        //,baseWidth: 1550, baseHeight: 2350
                    });
                    canvasMap.initAll();
                    divNet.style.width = canvasMap.cfg.baseWidth + 'px';
                    divNet.style.height = canvasMap.cfg.baseHeight + 'px';
                    divNet.appendChild(canvasMap.div);
                    TT.ui.mapSelector.canvasMap = canvasMap;
                }
            }
            TT.ui.mapSelector = new TT.lib.classMapSelector(cfg);
            TT.ui.mapSelector.el.addEventListener('click', function(e){
                var me = TT.ui.mapSelector;
                var t = e.target;
                if(t.className.indexOf('canvasTWRMapButton')!=-1){
                    if(me.itemActiveString==divNet.headerText){
                        var id = t.className.split('caTWRMap_')[1];
                        if(afterSelectCbFn){
                            afterSelectCbFn(id);
                        }
                        win.close();
                        TT.ui.msg.show(TT.fn.getCommon_stationDataOfID(id).name,600);
                    }else{
                        me.itemSwitch(divNet.headerText);
                    }
                }
                if(t.className.indexOf('canvasTWRMapClickDiv')!=-1){
                    me.itemSwitch(divNet.headerText);
                }
            }, false);
        },
        createTakeStation: function(cfg){
            cfg = cfg || {};
            if(!cfg.id) cfg.id = TT.ui.genRandomId();
            
            var astObj = TT.fn.getCommon_allTrainStation();
            var traAry = astObj.traAry, trtcAry = astObj.trtcAry, allAry = astObj.allAry;
            
            if(!TT.ui.mapSelector) TT.ui.createMapSelector();
            
            if(!cfg.fieldText) cfg.fieldText = '';
            if(!cfg.fieldStartText) cfg.fieldStartText = '出發站:';
            if(!cfg.fieldEndText) cfg.fieldEndText = '到達站:';
            var div = document.createElement('div');
            div.id = cfg.id;
            
            var optSt = (function(){
                var company, cmpStr = '', lineC, rt='';
                for(var i=0; i<allAry.length; i++){
                    company = TT.fn.getCompanyOfStation(allAry[i].id);
                    //lineC = (allAry[i].byLine) ? 'background-color:' + TT.fn.getCommon_lineColor(allAry[i].byLine) + ';' : '';
                    cmpStr = '(' + company.toUpperCase() + ')';
                    rt += '<option value="' + allAry[i].id + '" class="' + TT.defined.railBgcolor + allAry[i].byLine + '">' + allAry[i].name + cmpStr + '</option>';
                }
                return rt;
            })();
            
            var fieldTextDiv = (cfg.fieldText=='') ? '' : '<div id="' + div.id + '_fieldText">' + '<span>' + cfg.fieldText + '</span>' + '</div>';
            div.innerHTML = fieldTextDiv +
            '<div class="selectStationOut">' +
                '<div class="selectStationIn" id="' + cfg.id + '_fromin">' +
                    '<span>' + cfg.fieldStartText + '</span>' +
                    '<span><select id="' + cfg.id + '_start">' + optSt + '</select></span>' +
                    '<div class="selectStationByLine sta_from">' + '選擇車站' + '</div>' +
                    '<input type="text" class="inputStation" id="' + cfg.id + '_inputFrom" placeholder="' + '搜尋站名(拼音可)' + '" />' +
                    '<div class="selectStationExchange">' + '起訖點對調' + '</div>' +
                '</div>' +
                '<div class="selectStationIn" id="' + cfg.id + '_toin">' +
                    '<span>' + cfg.fieldEndText + '</span>' +
                    '<span><select id="' + cfg.id + '_end">' + optSt + '</select></span>' +
                    '<div class="selectStationByLine sta_to">' + '選擇車站' + '</div>' +
                    '<input type="text" class="inputStation" id="' + cfg.id + '_inputTo" placeholder="' + '搜尋站名(拼音可)' + '" />' +
                '</div>' +
            '</div>';
            
            if(cfg.renderID && cfg.renderID!=''){document.getElementById(cfg.renderID).appendChild(div);}
            
            div.addEventListener('click', function(e){
                var t = e.target, scfg = {};
                if(t.className.indexOf('selectStationByLine') != -1){
                    if(/sta_from/.test(t.className)){
                        scfg.afterSelectCbFn = function(staID){
                            div.fnSetStart(staID);
                        }
                    }else if(/sta_to/.test(t.className)){
                        scfg.afterSelectCbFn = function(staID){
                            div.fnSetEnd(staID);
                        }
                    }
                    TT.ui.mapSelector.show(scfg);
                }else if(t.className.indexOf('selectStationExchange') != -1){
                    var tmpV = div.fnGetStart();
                    div.fnSetStart(div.fnGetEnd());
                    div.fnSetEnd(tmpV);
                }else if(t.className.indexOf('inputStation') != -1){
                    renderInputEvent(t);
                }
            }, false);
            
            div.fnGetStart = function(){
                return document.getElementById(cfg.id + '_start').value;
            }
            div.fnGetEnd = function(){
                return document.getElementById(cfg.id + '_end').value;
            }
            div.fnSetStart = function(val){
                return document.getElementById(cfg.id + '_start').value = val;
            }
            div.fnSetEnd = function(val){
                return document.getElementById(cfg.id + '_end').value = val;
            }
            
            var renderInputEvent = function(t){
                var dom, isFrom = false, isTo = false;
                if(t.id== cfg.id + '_inputFrom'){ isFrom = true; }else if(t.id== cfg.id + '_inputTo'){ isTo = true; }
                if(!isFrom && !isTo) return false;
                if(t.tt_isRenderKeyEvent) return false;
                t.tt_isRenderKeyEvent = (isFrom) ? 'from' : 'to';
                
                function clearInput(){
                    t.value = '';
                }
                
                function giveValue(val){
                        var tarID = (isFrom) ? cfg.id + '_start' : cfg.id + '_end';
                        document.getElementById(tarID).value = val;
                        listDiv.style.display = 'none';
                        clearInput();
                }
                
                var listDiv = document.createElement('div');
                listDiv.className = 'inputListStation';
                listDiv.id = t.id + '_list';
                listDiv.addEventListener('click', function(e){
                    if(e.target.className=='name'){
                        var stid = e.target.attributes.getNamedItem('stid').value;
                        giveValue(stid);
                    }
                });
                
                document.body.appendChild(listDiv);
                t.tt_listDiv = listDiv;
                
                t.addEventListener('keyup', function(e){
                    var t = e.target;
                    var val = t.value.replace(/\s/g,''), displayAry = new Array(), comp;
                    var pos = $('#' + t.id).position();
                    if(t.oldValue && t.oldValue==val && e.keyCode!=13) return false;
                    t.oldValue = val;
                    var allStAry = TT.fn.findStationByString(val);
                    if(!allStAry) return false;
                    allStAry.map(function(st){
                        if(st.noShow) return false;
                        comp = TT.defined.stringSimpleOfCompany[TT.fn.getCompanyOfStation(st.id)];
                        comp = (comp) ? ' (' + comp + ')' : '';
                        displayAry.push({
                            value: st.id,
                            text: st.name + comp
                        });
                    });
                    
                    if(e.keyCode==13 && displayAry[0]){
                        giveValue(displayAry[0].value);
                        return false;
                    }
                    t.tt_listDiv.style.left = pos.left + 'px';
                    t.tt_listDiv.style.top = (pos.top+22) + 'px';
                    t.tt_listDiv.style.display = '';
                    var ht = '';
                    for(var i=0; i<displayAry.length; i++){
                        ht += '<div class="name" stid="' + displayAry[i].value + '">' + displayAry[i].text + '</div>';
                        if(i>10) break;
                    };
                    t.tt_listDiv.innerHTML = ht;
                });
                
                t.addEventListener('blur', function(e){
                    var t = e.target;
                    setTimeout(function(){if(t.tt_listDiv) t.tt_listDiv.style.display = 'none';},500);
                });
            }
            
            return div;
            
        },
        createTakeTimeFindDepArr: function(cfg){
            cfg = cfg || {};
            if(!cfg.id) cfg.id = TT.ui.genRandomId();
            if(!cfg.flagAD) cfg.flagAD = true;//true=Dep, Default Dep
            if(!cfg.fieldText) cfg.fieldText = '';
            if(!cfg.fieldDepText) cfg.fieldDepText = '出發的列車';
            if(!cfg.fieldArrText) cfg.fieldArrText = '到達的列車';
            var div = document.createElement('div');
            div.id = cfg.id;
            
            var f0ck = (cfg.flagAD) ? '' : ' checked';
            var f1ck = (cfg.flagAD) ? ' checked' : '';
            
            var fieldTextDiv = (cfg.fieldText=='') ? '' : '<div id="' + div.id + '_fieldText">' + '<span>' + cfg.fieldText + '</span>' + '</div>';
            div.innerHTML = fieldTextDiv +
            '<div class="radioAD" id="' + cfg.id + '">' +
                '<input type="radio" name="' + cfg.id + '_gp" value="1" id="' + cfg.id + '_1" ' + f1ck + '>' + '</span>' + cfg.fieldDepText + '</span>' +
                '<div style="display:inline-block;width: 50px;"></div>' +
                '<input type="radio" name="' + cfg.id + '_gp" value="0" id="' + cfg.id + '_0" ' + f0ck + '>' + '</span>' + cfg.fieldArrText + '</span>' +
            '</div>';
            
            div.fnGetValue = function(){
                return document.getElementById(cfg.id+'_1').checked;
            }
            
            if(cfg.renderID && cfg.renderID!=''){document.getElementById(cfg.renderID).appendChild(div);}
            
            return div;
        },
        createTakeTimeSelect: function(cfg){
            cfg = cfg || {};
            if(!cfg.id) cfg.id = TT.ui.genRandomId();
            if(!cfg.cls) cfg.cls = '';
            if(!cfg.fieldText) cfg.fieldText = '';
            if(!cfg.fieldStartText) cfg.fieldStartText = '從這個時間開始：';
            if(!cfg.fieldEndText) cfg.fieldEndText = '到這個時間為止：';
            var div = document.createElement('div');
            div.id = cfg.id;
            
            var hourOpt = (function(){
                var rt = '', tmp='';
                for(var i=0; i<24; i++){
                    tmp = TT.fn.transNum2StrA(i);
                    rt += '<option value="' + tmp + '">' + tmp + '</option>';
                }
                return rt;
            })();
            
            var minOpt = (function(){
                var rt = '', tmp='';
                for(var i=0; i<60; i+=5){
                    tmp = TT.fn.transNum2StrA(i);
                    rt += '<option value="' + tmp + '">' + tmp + '</option>';
                }
                return rt;
            })();
            
            var fieldTextDiv = (cfg.fieldText=='') ? '' : '<div id="' + div.id + '_fieldText">' + '<span>' + cfg.fieldText + '</span>' + '</div>';
            div.innerHTML = fieldTextDiv +
            '<div class="selectTimeOut">' +
                '<div class="selectTimeIn" id="' + cfg.id + '_startTimeDiv">' +
                    '<span>' + cfg.fieldStartText + '</span>' +
                    '<span><select id="' + cfg.id + '_startHour">' + hourOpt + '</select></span>' +
                    '<span>:</span>' + 
                    '<span><select id="' + cfg.id + '_startMin">' + minOpt + '</select></span>' +
                    '<span><div class="setNow">' + '設成現在' + '</div></span>' +
                '</div>' +
                '<div class="selectTimeIn" id="' + cfg.id + '_endTimeDiv">' +
                    '<span>' + cfg.fieldEndText + '</span>' +
                    '<span><select id="' + cfg.id + '_endHour">' + hourOpt + '</select></span>' +
                    '<span>:</span>' + 
                    '<span><select id="' + cfg.id + '_endMin">' + minOpt + '</select></span>' +
                '</div>' +
            '</div>';
            
            var sh = cfg.id + '_startHour', sm = cfg.id + '_startMin', eh = cfg.id + '_endHour', em = cfg.id + '_endMin';
            
            div.fnGetStartTime = function(){
                var h = document.getElementById(sh).value;
                var m = document.getElementById(sm).value;
                return h + ':' + m + ':00';
            }
            div.fnGetEndTime = function(){
                var h = document.getElementById(eh).value;
                var m = document.getElementById(em).value;
                return h + ':' + m + ':00';
            }
            div.fnSetStartTime = function(val){
                var aryA = val.split(':');
                document.getElementById(sh).value = aryA[0];
                document.getElementById(sm).value = aryA[1];
                return true;
            }
            div.fnSetEndTime = function(val){
                var aryA = val.split(':');
                document.getElementById(eh).value = aryA[0];
                document.getElementById(em).value = aryA[1];
                return true;
            }
            div.addEventListener('click', function(e){
                var t = e.target;
                if(t.className=='setNow'){
                    var nowT = new Date();
                    var h = nowT.getHours(), m = Math.ceil(nowT.getMinutes()/5)*5;
                    if(m==60){
                        h = (h==23) ? 0 : h+1;
                        m = 0;
                    }
                    var h2 = (h + 2) % 24;
                    var w = nowT.getDay();
                    h = h.toString();
                    h2 = h2.toString();
                    m = m.toString();
                    if(h.length==1) h = '0' + h;
                    if(h2.length==1) h2 = '0' + h2;
                    if(m.length==1) m = '0' + m;
                    div.fnSetStartTime(h + ':' + m);
                    div.fnSetEndTime(h2 + ':' + m);
                    TT.ui.center.timeTable.controlDiv.weekSelectDiv.fnSetDay(w);
                }
            }, false);
            
            if(cfg.renderID && cfg.renderID!=''){document.getElementById(cfg.renderID).appendChild(div);}
            
            return div;
        },
        createWeekSelect: function(cfg){
            cfg = cfg || {};
            if(!cfg.id) cfg.id = TT.ui.genRandomId();
            if(!cfg.cls) cfg.cls = '';
            if(!cfg.fieldText) cfg.fieldText = '星期幾要搭乘呢？';
            var div = document.createElement('div');
            div.id = cfg.id;
            
            var weekOpt = (function(){
                var rt = '', sty = '', weekStringAry = TT.defined.weekStringAry;
                for(var i=0; i<7; i++){
                    sty = (i==0) ? ' style="background-color:#FFAABC;"' : (i==6) ? ' style="background-color:#44DFAA;"' : ' style="background-color:#EEE;"'
                    rt += '<option value="' + i + '" ' + sty + '>' + weekStringAry[i] + '</option>';
                }
                return rt;
            })();
            
            div.innerHTML = '' +
            '<div class="selectWeekOut">' +
                '<div class="selectWeekIn" id="' + cfg.id + '_startTimeDiv">' +
                    '<span>' + cfg.fieldText + '</span>' +
                    '<span><select id="' + cfg.id + '_selector">' + weekOpt + '</select></span>' +
                '</div>' +
            '</div>';
            
            if(cfg.renderID && cfg.renderID!=''){document.getElementById(cfg.renderID).appendChild(div);}
            
            div.fnSetDay = function(val){
                val = val.toString();
                document.getElementById(cfg.id + '_selector').value = val;
                return val;
            }
            div.fnGetDay = function(){
                return document.getElementById(cfg.id + '_selector').value;
            }
            
            return div;
        
        },
        createTrainRouteSelectBox: function(aryRoute){
            var rDiv = TT.ui.center.timeTable.displayDiv.routeDiv;
            var sortByNow = (TT.now.sortBy) ? TT.now.sortBy : '';
            //+++++++++++ Create sort select box +++++++++++
            var sdtx = '', sDiv = document.createElement('div');
            sdtx += '<div class="tt_ck_sortby_sh" id="tt_timeTable_seSortBy_">' + '越早抵達目的地的越上面' + '</div>';
            sdtx += '<div class="tt_ck_sortby_sh" id="tt_timeTable_seSortBy_travelMinute">' + '花費時間越短的越上面' + '</div>';
            sdtx += '<div class="tt_ck_sortby_sh" id="tt_timeTable_seSortBy_transCount">' + '轉乘次數越少的越上面' + '</div>';
            sDiv.innerHTML = sdtx + '<span class="helpForSortBySelectButton"><div class="arrow"></div>' + '點一下，你可以換個排列順序' + '</span>';
            sDiv.style.borderBottom = '1px solid #23C';
            sDiv.style.backgroundColor = '#332';
            sDiv.addEventListener('click', function(e){
                var t = e.target;
                var tid = t.id.replace('tt_timeTable_seSortBy_','');
                if(sortByNow != tid){
                    var aryCk = new Array();
                    function callback(){
                        $('.tt_ck_route_sh .ckRoute').each(function(idx,domA){
                            domA.checked = aryCk[idx];
                            changeChecked(domA);
                        });
                        resetCountOfTrainRouteBox();
                        TT.ui.unmask();
                        TT.msg.show('排序已調整',500);
                    }
                    $('.tt_ck_route_sh .ckRoute').each(function(idx,domA){
                        aryCk[idx] = domA.checked;
                    });
                    if(TT.now.sortRoute.length > 100){
                        TT.ui.mask();
                        setTimeout(function(){
                            TT.ui.printTrain(TT.now.totalRoute, tid, callback);
                        },100);
                    }else{
                        TT.ui.printTrain(TT.now.totalRoute, tid, callback);
                    }
                }
            }, false);
            //+++++++++++ End sort select box +++++++++++
            var routeBy = '', routeP, tmpS = '', st = '', ht ='', fastestStr='', dmClass='', ckDom, hDiv = document.createElement('div'), sortTC = new Array();
            for(var tc=0; tc<aryRoute.length; tc++){
                routeP = aryRoute[tc];
                routeBy = ''; st = ''; tmpS='';
                for(var i=0; i<routeP.length; i++){
                    if(routeP[i].transStation){
                        tmpS += '<div class="stag">' + routeP[i].transStation.name + '</div>';
                    }
                }
                fastestStr = '(' + '最快' + ' <span class="fmin">' + TT.ui.formatMinute2HM(routeP[0].total_fastestMinute) + '</span> ' + ')&nbsp;';
                dmClass = '';
                if(routeP[0].total_fastestMinute==9999){
                    fastestStr = '(無班車)&nbsp;';
                    dmClass = ' tt_display_none';
                }
                st = '經由' + ' ' + tmpS + fastestStr;
                if(routeP.length==1 && !(routeP[0].transStation)) st = '<span class="stag ' + TT.defined.railBgcolor + routeP[0].line + '">' + TT.fn.getCommon_lineName(routeP[0].line) + '</span>' + '直達' + fastestStr;
                routeBy = '<div class="tt_ck_route_sh' + dmClass + '">' +
                    '<input type="checkbox" id="tt_timeTable_ckRoute_' + tc + '" class="ckRoute" checked>' + st +
                '</div>';
                sortTC.push({id: 'tt_timeTable_ckRoute_' + tc, tc:tc, tt_sortTime: routeP[0].total_fastestMinute, routeBy:routeBy});
                //ht += routeBy;
            }
            if(sortTC.length > 1){
                sortTC = sortTC.sort(TT.fn.getTRA_sortByTTSortTime);
                ht += '<div class="tt_ck_route_filterPri" tmf="1">1</div>';
                if(sortTC.length > 2) ht += '<div class="tt_ck_route_filterPri" tmf="2">2</div>';
                if(sortTC.length > 3) ht += '<div class="tt_ck_route_filterPri" tmf="3">3</div>';
            }
            sortTC.map(function(objA){
                ht += objA.routeBy;
            });
            hDiv.innerHTML = ht + '<span class="helpForRouteCheckBox"><div class="arrow"></div>' + '把勾取消，隱藏你不想轉乘的路徑' + '</span>';
            hDiv.style.backgroundColor = '#DEF';
            hDiv.addEventListener('click', function(e){
                var t = e.target;
                var tmf = t.attributes.getNamedItem('tmf');
                if(tmf && tmf.value){
                    var domCk;
                    tmf = parseInt(tmf.value,10);
                    //sortTC.map(function(objA,idx){
                        //domCk = document.getElementById(objA.id);
                        //if(idx<tmf){
                            //domCk.checked = true;
                        //}else{
                            //domCk.checked = false;
                        //}
                        //changeChecked(domCk);
                    //});
                    function callChangeChk(objA, idx){
                        domCk = document.getElementById(objA.id);
                        if(idx<tmf){
                            domCk.checked = true;
                        }else{
                            domCk.checked = false;
                        }
                        changeChecked(domCk);
                        idx++;
                        if(sortTC.length > idx){
                            setTimeout(function(){
                                callChangeChk(sortTC[idx], idx);
                            },10);
                        }else{
                            resetCountOfTrainRouteBox();
                            TT.ui.unmask();
                        }
                    }
                    if(TT.now.sortRoute.length > 100){
                        TT.ui.mask();
                        setTimeout(function(){ callChangeChk(sortTC[0], 0); },100);
                    }else{
                        callChangeChk(sortTC[0], 0);
                    }
                }
            }, false);
            rDiv.appendChild(sDiv);
            rDiv.appendChild(hDiv);
            function changeChecked(domCk){
                    //if(typeof(domCk)=='string') domCk = document.getElementById(domCk);
                    var ckcss = domCk.id.replace('tt_timeTable_ckRoute_','.tt_search_route_css_');
                    if(domCk.checked==true){
                        $('#' + TT.ui.center.timeTable.displayDiv.trainDiv.id + ' ' + ckcss).show();
                    }else{
                        $('#' + TT.ui.center.timeTable.displayDiv.trainDiv.id + ' ' + ckcss).hide();
                    }
            }
            function resetCountOfTrainRouteBox(){
                    var ct = 0;
                    $('#' + TT.ui.center.timeTable.displayDiv.trainDiv.id + ' .timeTableTrainRouteBox').each(function(idx,dom){
                        if(dom.style.display != 'none'){
                            ct++;
                            //$('#timeTableTrainRouteBox_' + idx + ' .sub.num span.val')[0].innerHTML = ct;//Too slow
                            document.getElementById('timeTableTrainRouteBoxCountVal_' + idx).innerHTML = ct;
                        }
                    });
            }
            for(var tc=0; tc<aryRoute.length; tc++){
                ckDom = document.getElementById('tt_timeTable_ckRoute_' + tc);
                ckDom.addEventListener('change', function(e){
                    changeChecked(e.target);
                    resetCountOfTrainRouteBox();
                }, false);
            }
            $('.tt_ck_sortby_sh').each(function(idx,dom){
                dom.className = dom.className.replace(' select','');
                var tid = dom.id.replace('tt_timeTable_seSortBy_','');
                if(tid==sortByNow){
                    dom.className = dom.className + ' select';
                }
            });
        },
        createTrainRouteTimeBox: function(routeP, ct, renderID){
            if(!renderID) renderID = TT.ui.center.timeTable.displayDiv.trainDiv.id;
            var id = 'timeTableTrainRouteBox_' + ct;
            var div = document.createElement('div');
            div.className = 'timeTableTrainRouteBox' + ' tt_search_route_css_' + routeP.routeIndex;
            div.id = id;
            
            function createTimeBox(tbd, startTime, endTime){
                if(tbd.doNotTakeTrain) return '';
                var st = Math.ceil(TT.fn.transTime2Sec(startTime)/60),
                    ed = Math.ceil(TT.fn.transTime2Sec(endTime)/60),
                    min;
                
                if(ed < st) ed = 1440 + ed;
                min = ed - st;
                
                return '<div class="timeBox">' +
                    '<div class="value start">' + TT.fn.transTime2HM(startTime) + '</div>' +
                    '<div class="deep"><div class="minute">' + TT.ui.formatMinute2HM(min) + '</div></div>' +
                    '<div class="value end">' + TT.fn.transTime2HM(endTime) + '</div>' +
                '</div>';
            }
            function createStationBox(tbd, a, b, line){
                var aObj = TT.fn.getCommon_stationDataOfID(a);
                var bObj = TT.fn.getCommon_stationDataOfID(b);
                if(tbd.doNotTakeTrain) return aObj.name;
                
                return '<div class="stationBox">' +
                    '<div class="value from">' + aObj.name + '</div>' +
                    '<div class="deep"><div class="line_color ' + line + '"><div class="bd"></div></div>' + '</div>' +
                    '<div class="value to">' + bObj.name + '</div>' +
                '</div>';
            }
            
            function createInfoBox(tbd, info, line){
                if(tbd.doNotTakeTrain) return '';
                var rt = '';
                if(TT.fn.getCompanyOfLine(line)=='tra'){//TRA info
                    var se = '', st = TT.fn.getTRA_stationDataOfID('tra_' + info['TimeInfo'][0].Station).name,
                        ed = TT.fn.getTRA_stationDataOfID('tra_' + info['TimeInfo'][info['TimeInfo'].length-1].Station).name;
                    if(st && ed) se = '<div>' + '[' + st + ' -&gt; ' + ed + ']' + '</div>';
                    rt = '<div class="infoBox">' +
                        se +
                        '<div>' + '車次: ' + info['Train'] + '</div>' +
                        '<div>' + '車種: ' + TT.fn.getTRA_carClassName(info['CarClass'], {color: true}) + '</div>' +
                    '</div>';
                }else if(TT.fn.getCompanyOfLine(line)=='trtc'){
                    var trtcSpe = '台北捷運到站時間是以官方站間行駛時間做相對計算模擬。';
                    var outArea=TT.fn.getTRTC_stationOnOutArea(tbd.takeRange[0], tbd.takeRange[1], line);
                    if(outArea){
                        trtcSpe = '請留意是否需在<span class="defineFontStyle1">' + TT.fn.getTRTC_stationDataOfID(outArea.transAt).name + '</span>改搭下一班車，因目的地並非每班車都有到。';
                    }
                    rt = '<div class="infoBox">' +
                        '<span class="trtcArriveTimeInfo">' + trtcSpe + '</span>' +
                    '</div>';
                }else if(TT.fn.getCompanyOfLine(line)=='tymetro'){
                    var trtcSpe = '桃園捷運時間是以官方頭末班車時間做相對計算。';
                    rt = '<div class="infoBox">' +
                        '<span class="trtcArriveTimeInfo">' + trtcSpe + '</span>' +
                        '<div style="padding-bottom:10px;"> </div>' +
                        '<div>' + '車種: ' + TT.fn.tymetro.get_carTypeName(info['type'], {color: true}) + '</div>' +
                    '</div>';
                }
                return rt;
            }
            
            function createLineBox(tbd, line){
                var rt = '',
                    name = TT.fn.getCommon_lineName(line);//,
                    //color = TT.fn.getCommon_lineColor(line);
                //var ary = name.split(']');
                //rt = ary[0] + ']' + '<span style="color:' + color + ';">' + ary[1] + '</span>';
                rt = '<span class="' + TT.defined.railBgcolor + line + '">' + name + '</span>';
                return rt;
            }
            
            function createTransStationBox(ts, st){
                var vLink = '';
                if(ts.video && ts.video[st]){
                    vLink = '<div class="transStationVideoClick" tsid="' + ts.id + '" stid="' + st + '">轉乘教學</div>';
                }
                var adjTime = ['<div class="transStationAdjustWalkTime">', '調整時間', '</div>'].join('');
                return '轉乘步行時間: ' + ts.walkMinute + '分鐘' + vLink + adjTime;
            }
            
            var hDiv = document.createElement('div');
            hDiv.className = 'header';
            hDiv.innerHTML = '<div class="sub num">' + 'NO. ' + '<span class="val" id="timeTableTrainRouteBoxCountVal_' + ct + '">' + (ct+1) + '</span>' + '</div>' + 
                '<div class="sub count">' + '轉乘次數: ' + '<span class="val">' + (routeP.routeMap.length-1) + '</span>' + '</div>' + 
                '<div class="sub totalTime">' + '花費時間: ' + '<span class="val">' + TT.ui.formatMinute2HM(routeP.travelMinute) + '</span>' + '</div>' +
                '<div class="sub startTime">' + '開始時間: ' + '<span class="val">' + routeP.travelStartTime + '</span>' + '</div>' +
                '<div class="sub endTime">' + '到達時間: ' + '<span class="val">' + routeP.travelEndTime + '</span>' + '</div>' +
                '<div class="sub printCanvas" printid="' + id + '">' + '截圖' + '</div>';
            
            hDiv.addEventListener('click', function(e){
                var dom = e.target;
                if(dom.className.indexOf('printCanvas') != -1){
                    var pid = e.target.attributes.getNamedItem('printid').value;
                    var targetBox = $('#' + pid);
                    if(targetBox[0].offsetTop) TT.ui.centerScroll(targetBox[0].offsetTop-38, true);
                    TT.html2canvas(targetBox, {
                        onrendered: function(imgA) {
                            if(imgA && imgA.toDataURL){
                                window.open(imgA.toDataURL("image/png"));
                                console.log(imgA.toDataURL("image/png"));
                            }else{
                                TT.msg.show('截圖失敗，可能是瀏覽器長寬不足截下整張圖片');
                            }
                        }
                    });
                }
            }, false);
            var tDiv = document.createElement('div');
            tDiv.className = 'timeRouteDiv';
            var tTD = (function(){
                var td = '', tbd, tAfter, transInfoHTML = '', tsStyle = '';
                for(var i=0; i<routeP.routeMap.length; i++){
                    tbd = routeP.routeMap[i];
                    tAfter = (i<routeP.routeMap.length-1) ? routeP.routeMap[i+1] : false;
                    td += '<tr>' +
                        '<td class="sect">' + (i+1) + '</td>' +
                        '<td class="time">' + createTimeBox(tbd, tbd.time[0], tbd.time[1]) + '</td>' +
                        '<td class="station">' + createStationBox(tbd, tbd.takeRange[0], tbd.takeRange[1], tbd.line) + '</td>' +
                        '<td class="info">' + createInfoBox(tbd, tbd.info, tbd.line) + '</td>' +
                        '<td class="line">' + createLineBox(tbd, tbd.line) + '</td>' +
                        '<td class="other">' + '' + '</td>' +
                    '</tr>';
                    if(tbd.transStation){
                    	if(tAfter && tAfter.company==tbd.company && tAfter.info && tbd.info && tAfter.info.Train && tbd.info.Train && tAfter.info.Train==tbd.info.Train){//同一列車
                    		transInfoHTML = '同一班列車直通無需轉乘';
                    		tsStyle = ' style="border-bottom: 1px solid transparent;"';
                    	}else{
                    		transInfoHTML = createTransStationBox(tbd.transStation, tbd.takeRange[1]);
                    		tsStyle = '';
                    	}
                        td += '<tr>' +
                            '<td></td>' +
                            '<td class="time"></td>' +
                            '<td colspan="3" class="transStation"' + tsStyle + '>' + transInfoHTML + '</td>' +
                            '<td></td>' +
                        '</tr>';
                    }
                }
                return td;
            })();
            tDiv.innerHTML = '<div class="more btn">&gt;&gt;</div>' +
            '<table class="table" cellspacing="5" cellpadding="6">' +
                '<tr>' +
                    '<th class="sect">' + '區段' + '</td>' +
                    '<th class="time">' + '列車時刻' + '</td>' +
                    '<th class="station">' + '車站' + '</td>' +
                    '<th class="info">' + '列車資訊' + '</td>' +
                    '<th class="line">' + '路線資訊' + '</td>' +
                    '<th class="other">' + '其他' + '</td>' +
                '</tr>' +
                tTD +
            '</table>';
            tDiv.addEventListener('click', function(e){
                if(e.target.className.indexOf('more btn')!=-1){
                    e.target.parentNode.className += ' showAll';
                }
                if(e.target.className.indexOf('transStationVideoClick')!=-1){
                    var tsid = e.target.attributes.getNamedItem('tsid').value,
                        stid = e.target.attributes.getNamedItem('stid').value;
                    
                    var tsObj = TT.fn.getRoute_transStationById(tsid);
                    if(tsObj.video && tsObj.video[stid]){
                        TT.ui.displayTransVideo(tsObj.video[stid]);
                    }
                }else if(e.target.className.indexOf('transStationAdjustWalkTime')!=-1){
                    TT.ui.transStationWalkTimeWindow.show({justShowInuse: true});
                }
            }, false);
            div.appendChild(hDiv);
            div.appendChild(tDiv);
            document.getElementById(renderID).appendChild(div);
        },
        createTransStationWalkTimeWindow: function(){
            var id = 'tt_transStationWalkTimeWindow:';
            if(!TT.ui.transStationWalkTimeWindow){
                
                var nowUsedTransStation = [], showCfg;
                
                function inNowUsedTransStation(st){
                    var flgA = false;
                    for(var k=0; k<nowUsedTransStation.length; k++){
                        if(nowUsedTransStation[k]==st){
                            flgA = true;
                            break;
                        }
                    }
                    return flgA;
                }
                function getNowUsedTransStation(){
                    nowUsedTransStation = [];
                    if(TT.now && TT.now.totalRoute){
                        var route = TT.now.totalRoute;
                        for(var i=0; i<route.length; i++){
                            if(route[i]){
                            for(var j=0; j<route[i].length; j++){
                                if(route[i][j] && route[i][j].transStationID && !inNowUsedTransStation(route[i][j].transStationID)){
                                    nowUsedTransStation.push(route[i][j].transStationID);
                                }
                            }
                            }
                        }
                    } 
                }
                
                function updateCDiv(){
                    var justShowInuse = (showCfg && showCfg.justShowInuse) ? true : false;
                    var aryT = TT.data.transStation, ht='', mt='', st='', st1='', st2='', optStyle = '', inputID='', flgInUsed = false;
                    for(var i=0; i<aryT.length; i++){
                        mt = '在<span class="stationName">{st}</span>往返{st1}與{st2}間的步行時間';
                        st = aryT[i].name;
                        flgInUsed = inNowUsedTransStation(aryT[i].id);
                        st1 = TT.fn.getCommon_lineName(aryT[i]["changeLine"][0]);
                        st2 = TT.fn.getCommon_lineName(aryT[i]["changeLine"][1]);
                        mt = mt.replace('{st}',st).replace('{st1}',st1).replace('{st2}',st2);
                        optStyle = (justShowInuse && !flgInUsed) ? ' style="display:none;"' : '';
                        ht += '<div' + optStyle + '><input class="minute" type="text" id="' + id + aryT[i].id + '" value="' + aryT[i].walkMinute + '"><span>' + '分鐘' + ' , ' + mt + '</span></div>';
                    }
                    cDiv.innerHTML = ht;
                }
                
                function updateData(){
                    var aryT = TT.data.transStation, stid='', domA;
                    for(var i=0; i<aryT.length; i++){
                        stid = aryT[i].id;
                        domA = document.getElementById(id + stid);
                        if(domA){
                            aryT[i].walkMinute = parseInt(domA.value, 10);
                        }
                    }
                }
                
                var cDiv = TT.ui.createDiv(id + 'c', 'contentBox');
                var bDiv = TT.ui.createDiv(id + 'b', 'buttonBox');
                bDiv.innerHTML = '<span><button id="' + id + 'save">' + '儲存' + '</button></span>' +
                    '<span><button id="' + id + 'cancel">' + '取消' + '</button></span>';
                bDiv.addEventListener('click', function(e){
                    var bid= e.target.id.replace(id,'');
                    if(bid=='save'){
                        updateData();
                        win.close();
                    }
                    if(bid=='cancel'){
                        win.close();
                    }
                },false);
                var win = new TT.lib.classWindow({
                    id: id,
                    items: [cDiv, bDiv],
                    mask: true,
                    cls: 'transStationWalkTimeWindow',
                    onShow: function(thisA){
                        showCfg = thisA.showCfg;
                        getNowUsedTransStation();
                        TT.ui.centerTimeTableDisplayDivClear();
                        updateCDiv();
                        thisA.resetPosition();
                    }
                });
                TT.ui.transStationWalkTimeWindow = win;
            }
        },
        displayTransVideo: function(cfg){
            cfg = cfg || {};
            cfg.width = (cfg.width) ? cfg.width : 640;
            cfg.height = (cfg.height) ? cfg.height : 480;
            function renderInner(ww){
                        var ifm = '<iframe width="' + ww.vcfg.width + '" height="' + ww.vcfg.height + '" src="' + ww.vcfg.src + '" frameborder="0" allowfullscreen></iframe>';
                        ww.inner.innerHTML = ifm;
            }
            if(!this.win){
                this.win = new TT.lib.classWindow({
                    mask: true,
                    onShow: function(ww){
                        renderInner(ww);
                    }
                });
            }
            
            var win = this.win;
            win.el.style.width = (cfg.width + 30) + 'px';
            win.el.style.height = (cfg.height + 60) + 'px';
            win.vcfg = cfg;
            win.show();
            
            
        },
        findBeforeTrain: function(cbFn){
            TT.ui.findTrain(cbFn);
        },
        findTrain: function(cbFn){
            var w = TT.ui.center.timeTable.controlDiv.weekSelectDiv.fnGetDay();
            var localDataFn = TT.fn.localData;
            function fnAfterCheck(){
                
                var controlDiv = TT.ui.center.timeTable.controlDiv;
                var startTime = controlDiv.timeSelectDiv.fnGetStartTime();
                var endTime = controlDiv.timeSelectDiv.fnGetEndTime();
                var flagAD = controlDiv.depArrDiv.fnGetValue();
                var a = controlDiv.stationSelectDiv.fnGetStart();
                var b = controlDiv.stationSelectDiv.fnGetEnd();
                //var w = controlDiv.weekSelectDiv.fnGetDay();
                
                
                function endOfFind(aryRoute){
                	TT.ui.printStatus('尋找列車班次完成');TT.msg.show('尋找完成',200);
                	TT.ui.printTrain(aryRoute,'', cbFn);
                
                	localDataFn.setItem('defaultFromStation', a);
                	localDataFn.setItem('defaultToStation', b);
                	localDataFn.setItem('defaultStartTime', startTime);
                	localDataFn.setItem('defaultEndTime', endTime);
                
                	//rewrite url Get param
                	var sObj = {
                    	a: a,
                    	b: b,
                    	w: w,
                    	startTime: startTime,
                    	endTime: endTime
                	}
                	var sParam = '?a=' + a + '&b=' + b + '&w=' + w + //'&findTrain=1' +
                    	'&startTime=' + encodeURIComponent(startTime) +
                    	'&endTime=' + encodeURIComponent(endTime);
                	if(window.history) history.pushState(sObj,'',sParam);
                }
                TT.fn.getCommon_timeRangeBestByFromTo(a,b,startTime,endTime,flagAD,w,endOfFind);
            }
            
            function fnCheck(){
                var a1 = TT.fn.checkTRA_dayTimeIsLoaded(w);
                if(!a1){
                    TT.fn.getTRA_TimeTable2Data(w, fnCheck);
                    return false;
                }
                var a2 = TT.fn.checkTRTC_rnwTimeTableIsLoaded();
                if(!a2){
                    TT.fn.getTRTC_timeTable2Data(fnCheck);
                    return false;
                }
                var a3 = TT.fn.tymetro.check_timeTableIsLoaded();
                if(!a3){
                    TT.fn.tymetro.get_timeTable2Data(fnCheck);
                    return false;
                }
                fnAfterCheck();
            }
            fnCheck();
        },
        getCenterPage: function(str){
            for(var k in TT.ui.center){
                if(TT.ui.center[k].id == 'tt_' + str){
                    return TT.ui.center[k];
                }
            }
            return false;
        },
        getCenterActive: function(){
            for(var k in TT.ui.center){
                if(TT.ui.center[k].className.indexOf('show')>=0){
                    return TT.ui.center[k];
                }
            }
            return false;
        },
        setCenterActive: function(str){
            for(var k in TT.ui.center){
                TT.ui.center[k].className = TT.ui.center[k].className.replace(' show','');
                if(TT.ui.center[k].id == 'tt_' + str){
                    var dom = TT.ui.center[k];
                    TT.ui.center[k].className = TT.ui.center[k].className + ' show';
                }
            }
            return dom;
        },
        mask: function(str){
            if(TT.ui.maskDiv.className.indexOf('show')<0){
                TT.ui.maskDiv.className = TT.ui.maskDiv.className + ' show';
            }
            if(str){
                TT.ui.maskText.innerHTML = str;
            }else{
                TT.ui.maskText.innerHTML = TT.defined.defaultMaskText;
            }
        },
        unmask: function(){
            TT.ui.maskDiv.className = TT.ui.maskDiv.className.replace(' show','');
        },
        printStatus: function(str){
            TT.ui.statusBar.innerHTML = str;
        },
        printTrain: function(aryRoute, sortBy, cbFn){
            var controlDiv = TT.ui.center.timeTable.controlDiv;
            var startTime = controlDiv.timeSelectDiv.fnGetStartTime();
            var endTime = controlDiv.timeSelectDiv.fnGetEndTime();
            var flagAD = controlDiv.depArrDiv.fnGetValue();
            var a = controlDiv.stationSelectDiv.fnGetStart();
            var b = controlDiv.stationSelectDiv.fnGetEnd();
            
            //sortBy: '', 'travelMinute'
            var fRouteAry = TT.fn.mixAllRoute(aryRoute, flagAD, sortBy);
            TT.now = {
                totalRoute: aryRoute,
                sortRoute: fRouteAry,
                sortBy: sortBy
            }
            
            var tDiv;
            //Clear Old
            document.getElementById(TT.ui.center.timeTable.displayDiv.routeDiv.id).innerHTML = '';
            document.getElementById(TT.ui.center.timeTable.displayDiv.trainDiv.id).innerHTML = '';
            TT.ui.createTrainRouteSelectBox(aryRoute);
            for(var i=0; i<fRouteAry.length; i++){
                tDiv = TT.ui.createTrainRouteTimeBox(fRouteAry[i], i);
            }
            if(fRouteAry.length==0) TT.msg.show('糟糕，系統找不到這個時間內的列車！');
            if(TT.fn.checkIsFunction(cbFn)) cbFn();
        },
        resizeFn: function(e){
            var h = TT.fn.getDocumentHeight();
            var w = TT.fn.getDocumentWidth();
            var ch = h - 64;
            if(ch < 0) ch = 0;
            if(TT.os.isAndroidBrowser){
                TT.ui.centerDiv.style.height = 'auto';
            }else{
                TT.ui.centerDiv.style.height = ch + 'px';
            }
        },
        updateCenter: function(cmd){
            if(!cmd || /home/g.test(cmd)){
                var aryCkWeekLoaded = $('.center .home .frameA.tra div.ckWeekLoaded').hide();
                if(TT.data.tra.timeTable){
                    for(var i=0; i<TT.data.tra.timeTable.length; i++){
                        if(TT.fn.checkTRA_dayTimeIsLoaded(i)){
                            document.getElementById('tt_home_tra_ckWeekLoaded_' + i).style.display = '';
                        }
                    }
                }
                TT.data.tra.timeTable
            }
        }
    });
    
    TT.initFn = function(){
        //Remove HTML Element
        //var msff = document.getElementById(new Array('pre','_g','_text').join(''));
        //msff.innerHTML = '';
        //msff.style.display = 'none';
        //msff.remove();
        //.....
        
        //產生動態計算之固定路由資料
        TT.fn.createTRA_routeFile();
        
        //產生 UI
        TT.ui.createBaseDiv();
        TT.ui.createHeader();
        TT.ui.createStatus();
        
        TT.ui.createHome();
        TT.ui.createTimeTable();
        TT.ui.createTool();
        TT.ui.setCenterActive('timeTable');//home
        TT.ui.updateCenter();
        TT.msg.show('歡迎使用接軌時刻 Web APP。',2000);
        
        //TT.fn.getTRTC_timeTable2Data();//Initital get TRTC time
        //Check if auto search
        var GetP = TT.defined.GetP;
        if(GetP && GetP['findTrain'] && GetP['findTrain']==1) TT.ui.findTrain();
        
        //Resize function
        window.addEventListener('resize', TT.ui.resizeFn, false);
        TT.ui.resizeFn();
    }
        
    return TT;
})();

</script>
<script type="text/javascript" src="canvasTaiwanRailwayMap.js"></script>
<script type="text/javascript" src="html2canvas.js"></script>
<!-- -->
<!-- -->
</head>
<body onload="TT.initFn()">
    <!--
    <div id="pre_g_text">
        <p>接軌時刻，台灣的鐵路、火車、捷運 等運行之 時刻表以及路線轉乘查詢系統 </p>
        <p>Taiwan Railway MRT Timetable Search System</p>
        <p>提供您查詢[台鐵]轉[捷運]或[MRT]轉[火車]等多種需求</p>
        <ul>
            <li>淡水線、信義線、淡水信義線</li>
            <li>新店線、松山線、松山新店線</li>
            <li>中和線、新莊線、蘆洲線、中和新蘆線</li>
            <li>板橋線、南港線、板南線</li>
            <li>火車、台鐵、台灣鐵路局西部幹線縱貫線</li>
        </ul>
    </div>
    -->
</body>
</html>
